(window.webpackJsonp=window.webpackJsonp||[]).push([[6],{532:function(t,s,a){t.exports=a.p+"assets/img/frame.15f1b594.png"},533:function(t,s,a){t.exports=a.p+"assets/img/v15-example-1.506e7c1d.png"},534:function(t,s,a){t.exports=a.p+"assets/img/v15-example-2.6699f462.png"},535:function(t,s,a){t.exports=a.p+"assets/img/v16-example.c55d5087.png"},536:function(t,s,a){t.exports=a.p+"assets/img/fiber-tree.1502d674.png"},537:function(t,s,a){t.exports=a.p+"assets/img/mount-fiber-tree-1.0a6be4b7.png"},538:function(t,s,a){t.exports=a.p+"assets/img/mount-fiber-tree-2.4dac1618.png"},539:function(t,s,a){t.exports=a.p+"assets/img/mount-fiber-tree-3.c5f06db7.png"},540:function(t,s,a){t.exports=a.p+"assets/img/update-fiber-tree-1.74bae74e.png"},541:function(t,s,a){t.exports=a.p+"assets/img/update-fiber-tree-2.cfa37ae8.png"},667:function(t,s,a){"use strict";a.r(s);var e=a(22),n=Object(e.a)({},(function(){var t=this,s=t.$createElement,e=t._self._c||s;return e("ContentSlotsDistributor",{attrs:{"slot-key":t.$parent.slotKey}},[e("h2",{attrs:{id:"前言"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#前言"}},[t._v("#")]),t._v(" 前言")]),t._v(" "),e("p",[t._v("我们可以从"),e("a",{attrs:{href:"https://react.docschina.org/docs/thinking-in-react.html",target:"_blank",rel:"noopener noreferrer"}},[t._v("官网"),e("OutboundLink")],1),t._v("看到React的理念：")]),t._v(" "),e("blockquote",[e("p",[t._v("我们认为，React 是用 JavaScript 构建快速响应的大型 Web 应用程序的首选方式。它在 Facebook 和 Instagram 上表现优秀。")])]),t._v(" "),e("h2",{attrs:{id:"react-15-x-架构"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#react-15-x-架构"}},[t._v("#")]),t._v(" React 15.x 架构")]),t._v(" "),e("p",[e("code",[t._v("React")]),t._v(" 从 "),e("code",[t._v("v15")]),t._v(" 升级到 "),e("code",[t._v("v16")]),t._v(" 后重构了整个架构。本节我们聊聊 "),e("code",[t._v("v15")]),t._v(" ，看看他为什么不能满足速度快，响应自然的理念，以至于被重构。")]),t._v(" "),e("p",[e("code",[t._v("React v15")]),t._v(" 架构可以分为两层：")]),t._v(" "),e("ul",[e("li",[e("strong",[t._v("Reconciler")]),t._v("（协调器）—— 负责找出变化的组件")]),t._v(" "),e("li",[e("strong",[t._v("Renderer")]),t._v("（渲染器）—— 负责将变化的组件渲染到页面上")])]),t._v(" "),e("h3",{attrs:{id:"reconciler-协调器"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#reconciler-协调器"}},[t._v("#")]),t._v(" Reconciler（协调器）")]),t._v(" "),e("p",[t._v("我们知道，在 "),e("code",[t._v("React")]),t._v(" 中可以通过 "),e("code",[t._v("this.setState")]),t._v(" 、 "),e("code",[t._v("this.forceUpdate")]),t._v(" 、 "),e("code",[t._v("ReactDOM.render")]),t._v(" 等API触发更新。")]),t._v(" "),e("p",[t._v("每当有更新发生时， "),e("code",[t._v("Reconciler")]),t._v(" 会做如下工作：")]),t._v(" "),e("ul",[e("li",[t._v("调用函数组件、或 "),e("code",[t._v("class")]),t._v(" 组件的 "),e("code",[t._v("render")]),t._v(" 方法，将返回的 "),e("code",[t._v("JSX")]),t._v(" 转化为 "),e("code",[t._v("虚拟DOM")])]),t._v(" "),e("li",[t._v("将 "),e("code",[t._v("虚拟DOM")]),t._v(" 和上次更新时的 "),e("code",[t._v("虚拟DOM")]),t._v(" 对比")]),t._v(" "),e("li",[t._v("通过对比找出本次更新中变化的 "),e("code",[t._v("虚拟DOM")])]),t._v(" "),e("li",[t._v("通知 "),e("code",[t._v("Renderer")]),t._v(" 将变化的 "),e("code",[t._v("虚拟DOM")]),t._v(" 渲染到页面上")])]),t._v(" "),e("h3",{attrs:{id:"renderer-渲染器"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#renderer-渲染器"}},[t._v("#")]),t._v(" Renderer（渲染器）")]),t._v(" "),e("p",[t._v("由于 "),e("code",[t._v("React")]),t._v(" 支持跨平台，所以不同平台有不同的 "),e("code",[t._v("Renderer")]),t._v(" 。我们前端最熟悉的是负责在浏览器环境渲染的 "),e("code",[t._v("Renderer")]),t._v(" —— "),e("a",{attrs:{href:"https://www.npmjs.com/package/react-dom",target:"_blank",rel:"noopener noreferrer"}},[t._v("ReactDOM"),e("OutboundLink")],1),t._v("。")]),t._v(" "),e("p",[t._v("除此之外，还有：")]),t._v(" "),e("ul",[e("li",[e("a",{attrs:{href:"https://www.npmjs.com/package/react-native",target:"_blank",rel:"noopener noreferrer"}},[t._v("ReactNative"),e("OutboundLink")],1),t._v("渲染器，渲染App原生组件")]),t._v(" "),e("li",[e("a",{attrs:{href:"https://www.npmjs.com/package/react-test-renderer",target:"_blank",rel:"noopener noreferrer"}},[t._v("ReactTest"),e("OutboundLink")],1),t._v("渲染器，渲染出纯Js对象用于测试")]),t._v(" "),e("li",[e("a",{attrs:{href:"https://www.npmjs.com/package/react-art",target:"_blank",rel:"noopener noreferrer"}},[t._v("ReactArt"),e("OutboundLink")],1),t._v("渲染器，渲染到Canvas, SVG 或 VML (IE8)\n在每次更新发生时， "),e("code",[t._v("Renderer")]),t._v(" 接到 "),e("code",[t._v("Reconciler")]),t._v(" 通知，将变化的组件渲染在当前宿主环境。")])]),t._v(" "),e("h3",{attrs:{id:"react-15架构的缺点"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#react-15架构的缺点"}},[t._v("#")]),t._v(" React 15架构的缺点")]),t._v(" "),e("p",[t._v("在 "),e("code",[t._v("Reconciler")]),t._v(" 中， "),e("code",[t._v("mount")]),t._v(" 的组件会调用"),e("a",{attrs:{href:"https://github.com/facebook/react/blob/15-stable/src/renderers/dom/shared/ReactDOMComponent.js#L498",target:"_blank",rel:"noopener noreferrer"}},[t._v("mountComponent"),e("OutboundLink")],1),t._v("， "),e("code",[t._v("update")]),t._v(" 的组件会调用"),e("a",{attrs:{href:"https://github.com/facebook/react/blob/15-stable/src/renderers/dom/shared/ReactDOMComponent.js#L877",target:"_blank",rel:"noopener noreferrer"}},[t._v("updateComponent"),e("OutboundLink")],1),t._v("。这两个方法都会 "),e("code",[t._v("递归")]),t._v(" 更新子组件。")]),t._v(" "),e("h4",{attrs:{id:"递归更新的缺点"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#递归更新的缺点"}},[t._v("#")]),t._v(" 递归更新的缺点")]),t._v(" "),e("p",[t._v("主流的浏览器刷新频率为 "),e("code",[t._v("60Hz")]),t._v(" ，即每16.6ms（1000ms / 60Hz）浏览器刷新一次。我们知道， "),e("code",[t._v("JS")]),t._v(" 可以操作 "),e("code",[t._v("DOM")]),t._v(" ， "),e("code",[t._v("GUI")]),t._v(" 渲染线程与 "),e("code",[t._v("JS")]),t._v(" 线程是互斥的。所以 "),e("code",[t._v("JS")]),t._v(" 脚本执行和浏览器布局、绘制不能同时执行。")]),t._v(" "),e("p",[t._v("在每16.6ms时间内，需要完成如下工作：")]),t._v(" "),e("p",[e("img",{attrs:{src:a(532),alt:"frame"}})]),t._v(" "),e("p",[t._v("当JS执行时间过长，超出了16.6ms，这次刷新就没有时间执行样式布局和样式绘制了。")]),t._v(" "),e("p",[t._v("对于React的更新来说，由于 "),e("code",[t._v("递归执行")]),t._v(" ，所以更新一旦开始，中途就无法中断。当层级很深时，递归更新时间超过了16ms，用户交互就会卡顿。")]),t._v(" "),e("p",[t._v("那么我们可以提出了解决办法：用 "),e("code",[t._v("可中断")]),t._v(" 的异步更新代替同步的更新。那么 "),e("code",[t._v("React 15")]),t._v(" 的架构支持异步更新么？是不能的。我们可以看一个例子：")]),t._v(" "),e("div",{staticClass:"language-jsx line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-jsx"}},[e("code",[e("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("import")]),t._v(" React "),e("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("from")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token string"}},[t._v('"react"')]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n\n"),e("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("export")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("default")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("class")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("App")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("extends")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("React"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("Component")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n  "),e("span",{pre:!0,attrs:{class:"token function"}},[t._v("constructor")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),e("span",{pre:!0,attrs:{class:"token parameter"}},[e("span",{pre:!0,attrs:{class:"token operator"}},[t._v("...")]),t._v("props")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n    "),e("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("super")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v("...")]),t._v("props"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    "),e("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("this")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("state "),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n      count"),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token number"}},[t._v("1")]),t._v("\n    "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n  "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n  "),e("span",{pre:!0,attrs:{class:"token function"}},[t._v("onClick")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n    "),e("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("this")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),e("span",{pre:!0,attrs:{class:"token function"}},[t._v("setState")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n      count"),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("this")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("state"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("count "),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v("+")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token number"}},[t._v("1")]),t._v("\n    "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n  "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n  "),e("span",{pre:!0,attrs:{class:"token function"}},[t._v("render")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n    "),e("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("return")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("\n      "),e("span",{pre:!0,attrs:{class:"token tag"}},[e("span",{pre:!0,attrs:{class:"token tag"}},[e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("<")]),t._v("ul")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(">")])]),e("span",{pre:!0,attrs:{class:"token plain-text"}},[t._v("\n        ")]),e("span",{pre:!0,attrs:{class:"token tag"}},[e("span",{pre:!0,attrs:{class:"token tag"}},[e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("<")]),t._v("button")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token attr-name"}},[t._v("onClick")]),e("span",{pre:!0,attrs:{class:"token script language-javascript"}},[e("span",{pre:!0,attrs:{class:"token script-punctuation punctuation"}},[t._v("=")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=>")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("this")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),e("span",{pre:!0,attrs:{class:"token function"}},[t._v("onClick")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")])]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(">")])]),e("span",{pre:!0,attrs:{class:"token plain-text"}},[t._v("乘以")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),e("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("this")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("state"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("count"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),e("span",{pre:!0,attrs:{class:"token tag"}},[e("span",{pre:!0,attrs:{class:"token tag"}},[e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("</")]),t._v("button")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(">")])]),e("span",{pre:!0,attrs:{class:"token plain-text"}},[t._v("\n        ")]),e("span",{pre:!0,attrs:{class:"token tag"}},[e("span",{pre:!0,attrs:{class:"token tag"}},[e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("<")]),t._v("li")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(">")])]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),e("span",{pre:!0,attrs:{class:"token number"}},[t._v("1")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v("*")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("this")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("state"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("count"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),e("span",{pre:!0,attrs:{class:"token tag"}},[e("span",{pre:!0,attrs:{class:"token tag"}},[e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("</")]),t._v("li")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(">")])]),e("span",{pre:!0,attrs:{class:"token plain-text"}},[t._v("\n        ")]),e("span",{pre:!0,attrs:{class:"token tag"}},[e("span",{pre:!0,attrs:{class:"token tag"}},[e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("<")]),t._v("li")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(">")])]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),e("span",{pre:!0,attrs:{class:"token number"}},[t._v("2")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v("*")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("this")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("state"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("count"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),e("span",{pre:!0,attrs:{class:"token tag"}},[e("span",{pre:!0,attrs:{class:"token tag"}},[e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("</")]),t._v("li")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(">")])]),e("span",{pre:!0,attrs:{class:"token plain-text"}},[t._v("\n        ")]),e("span",{pre:!0,attrs:{class:"token tag"}},[e("span",{pre:!0,attrs:{class:"token tag"}},[e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("<")]),t._v("li")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(">")])]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),e("span",{pre:!0,attrs:{class:"token number"}},[t._v("3")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v("*")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("this")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("state"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("count"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),e("span",{pre:!0,attrs:{class:"token tag"}},[e("span",{pre:!0,attrs:{class:"token tag"}},[e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("</")]),t._v("li")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(">")])]),e("span",{pre:!0,attrs:{class:"token plain-text"}},[t._v("\n      ")]),e("span",{pre:!0,attrs:{class:"token tag"}},[e("span",{pre:!0,attrs:{class:"token tag"}},[e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("</")]),t._v("ul")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(">")])]),t._v("\n    "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n  "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n")])]),t._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[t._v("1")]),e("br"),e("span",{staticClass:"line-number"},[t._v("2")]),e("br"),e("span",{staticClass:"line-number"},[t._v("3")]),e("br"),e("span",{staticClass:"line-number"},[t._v("4")]),e("br"),e("span",{staticClass:"line-number"},[t._v("5")]),e("br"),e("span",{staticClass:"line-number"},[t._v("6")]),e("br"),e("span",{staticClass:"line-number"},[t._v("7")]),e("br"),e("span",{staticClass:"line-number"},[t._v("8")]),e("br"),e("span",{staticClass:"line-number"},[t._v("9")]),e("br"),e("span",{staticClass:"line-number"},[t._v("10")]),e("br"),e("span",{staticClass:"line-number"},[t._v("11")]),e("br"),e("span",{staticClass:"line-number"},[t._v("12")]),e("br"),e("span",{staticClass:"line-number"},[t._v("13")]),e("br"),e("span",{staticClass:"line-number"},[t._v("14")]),e("br"),e("span",{staticClass:"line-number"},[t._v("15")]),e("br"),e("span",{staticClass:"line-number"},[t._v("16")]),e("br"),e("span",{staticClass:"line-number"},[t._v("17")]),e("br"),e("span",{staticClass:"line-number"},[t._v("18")]),e("br"),e("span",{staticClass:"line-number"},[t._v("19")]),e("br"),e("span",{staticClass:"line-number"},[t._v("20")]),e("br"),e("span",{staticClass:"line-number"},[t._v("21")]),e("br"),e("span",{staticClass:"line-number"},[t._v("22")]),e("br"),e("span",{staticClass:"line-number"},[t._v("23")]),e("br"),e("span",{staticClass:"line-number"},[t._v("24")]),e("br"),e("span",{staticClass:"line-number"},[t._v("25")]),e("br")])]),e("p",[t._v("我用红色标注了更新的步骤。")]),t._v(" "),e("p",[e("img",{attrs:{src:a(533),alt:"v15-example-1"}})]),t._v(" "),e("p",[t._v("我们可以看到， "),e("code",[t._v("Reconciler")]),t._v(" 和 "),e("code",[t._v("Renderer")]),t._v(" 是 "),e("code",[t._v("交替工作")]),t._v(" 的，当第一个 "),e("code",[t._v("li")]),t._v(" 在页面上已经变化后，第二个 "),e("code",[t._v("li")]),t._v(" 再进入 "),e("code",[t._v("Reconciler")]),t._v(" 。")]),t._v(" "),e("p",[t._v("由于整个过程都是同步的，所以在用户看来所有 "),e("code",[t._v("DOM")]),t._v(" 是同时更新的。")]),t._v(" "),e("p",[t._v("让我们看看在 "),e("code",[t._v("React v15")]),t._v(" 架构中如果中途中断更新会怎么样？")]),t._v(" "),e("p",[e("img",{attrs:{src:a(534),alt:"v15-example-2"}})]),t._v(" "),e("p",[t._v("当第一个li完成更新时中断更新，即步骤3完成后中断更新，此时后面的步骤都还未执行。")]),t._v(" "),e("p",[t._v("用户本来期望 "),e("code",[t._v("123")]),t._v(" 变为 "),e("code",[t._v("246")]),t._v(" 。实际却看见更新不完全的 "),e("code",[t._v("DOM")]),t._v(" ！")]),t._v(" "),e("p",[t._v("基于这个原因， "),e("code",[t._v("React")]),t._v(" 决定重写整个架构。")]),t._v(" "),e("h2",{attrs:{id:"react-16-x-架构"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#react-16-x-架构"}},[t._v("#")]),t._v(" React 16.x 架构")]),t._v(" "),e("p",[t._v("React16架构可以分为三层：")]),t._v(" "),e("ul",[e("li",[e("strong",[t._v("Scheduler")]),t._v("（调度器）—— 调度任务的优先级，高优任务优先进入Reconciler")]),t._v(" "),e("li",[e("strong",[t._v("Reconciler")]),t._v("（协调器）—— 负责找出变化的组件")]),t._v(" "),e("li",[e("strong",[t._v("Renderer")]),t._v("（渲染器）—— 负责将变化的组件渲染到页面上")])]),t._v(" "),e("p",[t._v("可以看到，相较于 "),e("code",[t._v("React v15")]),t._v(" ， "),e("code",[t._v("React v16")]),t._v(" 中新增了 "),e("strong",[t._v("Scheduler（调度器）")]),t._v("，让我们来了解下他。")]),t._v(" "),e("h3",{attrs:{id:"scheduler-调度器"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#scheduler-调度器"}},[t._v("#")]),t._v(" Scheduler（调度器）")]),t._v(" "),e("p",[t._v("在 "),e("code",[t._v("React v16")]),t._v(" 中所有有关 "),e("code",[t._v("Scheduler")]),t._v("(调度器) 的实现都在 "),e("code",[t._v("packages/scheduler")]),t._v(" 中，"),e("a",{attrs:{href:"https://www.npmjs.com/package/scheduler",target:"_blank",rel:"noopener noreferrer"}},[t._v("scheduler"),e("OutboundLink")],1),t._v("是独立于"),e("code",[t._v("React")]),t._v("的库。")]),t._v(" "),e("p",[t._v("既然我们"),e("strong",[t._v("以浏览器是否有剩余时间作为任务中断的标准")]),t._v("，那么我们需要一种机制，当浏览器有剩余时间时通知我们。")]),t._v(" "),e("p",[t._v("其实部分浏览器已经实现了这个 "),e("code",[t._v("API")]),t._v(" ，这就是"),e("a",{attrs:{href:"https://developer.mozilla.org/zh-CN/docs/Web/API/Window/requestIdleCallback",target:"_blank",rel:"noopener noreferrer"}},[t._v("requestIdleCallback"),e("OutboundLink")],1),t._v("。但是由于以下因素，"),e("code",[t._v("React v16")]),t._v(" 放弃使用：")]),t._v(" "),e("ul",[e("li",[t._v("浏览器兼容性问题")]),t._v(" "),e("li",[t._v("触发频率不稳定，受很多因素影响。比如当我们的浏览器 "),e("code",[t._v("切换tab")]),t._v(" 后，之前tab注册的 "),e("code",[t._v("requestIdleCallback")]),t._v(" 触发的频率会变得很低")])]),t._v(" "),e("p",[t._v("关于该 "),e("code",[t._v("requestIdleCallback")]),t._v(" 详细的解读可以看一下之前的"),e("a",{attrs:{href:"https://artoriaschan.github.io/blog/2019/05/03/requestidlecallback/",target:"_blank",rel:"noopener noreferrer"}},[t._v("文章"),e("OutboundLink")],1),t._v("。")]),t._v(" "),e("p",[t._v("基于以上原因，"),e("code",[t._v("React v16")]),t._v(" 实现了功能更完备的 "),e("code",[t._v("requestIdleCallbackpolyfill")]),t._v(" ，这就是 "),e("code",[t._v("Scheduler")]),t._v(" 。除了在空闲时触发回调的功能外， "),e("code",[t._v("Scheduler")]),t._v(" 还提供了多种调度优先级供任务设置。")]),t._v(" "),e("h3",{attrs:{id:"reconciler-协调器-2"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#reconciler-协调器-2"}},[t._v("#")]),t._v(" Reconciler（协调器）")]),t._v(" "),e("p",[t._v("我们知道，在 "),e("code",[t._v("React v15")]),t._v(" 中 "),e("code",[t._v("Reconciler")]),t._v(" 是递归处理 "),e("code",[t._v("虚拟DOM")]),t._v(" 的。让我们看看 "),e("code",[t._v("React V16")]),t._v(" 的 "),e("a",{attrs:{href:"https://github.com/facebook/react/blob/master/packages/react-reconciler/src/ReactFiberWorkLoop.new.js#L1646",target:"_blank",rel:"noopener noreferrer"}},[t._v("Reconciler"),e("OutboundLink")],1),t._v("。")]),t._v(" "),e("blockquote",[e("p",[t._v("由于 Reconciler 也是平台无关的，所以 React 为他们单独发了一个包"),e("a",{attrs:{href:"https://www.npmjs.com/package/react-reconciler",target:"_blank",rel:"noopener noreferrer"}},[t._v("react-Reconciler"),e("OutboundLink")],1),t._v("。")])]),t._v(" "),e("p",[t._v("我们可以看见，更新工作从递归变成了可以中断的循环过程。每次循环都会调用 "),e("code",[t._v("shouldYield")]),t._v(" 判断当前是否有剩余时间。")]),t._v(" "),e("div",{staticClass:"language-javascript line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-javascript"}},[e("code",[e("span",{pre:!0,attrs:{class:"token comment"}},[t._v("/** @noinline */")]),t._v("\n"),e("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("function")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token function"}},[t._v("workLoopConcurrent")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n  "),e("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// Perform work until Scheduler asks us to yield")]),t._v("\n  "),e("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("while")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("workInProgress "),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v("!==")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("null")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v("&&")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v("!")]),e("span",{pre:!0,attrs:{class:"token function"}},[t._v("shouldYield")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n    "),e("span",{pre:!0,attrs:{class:"token function"}},[t._v("performUnitOfWork")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("workInProgress"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n  "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n")])]),t._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[t._v("1")]),e("br"),e("span",{staticClass:"line-number"},[t._v("2")]),e("br"),e("span",{staticClass:"line-number"},[t._v("3")]),e("br"),e("span",{staticClass:"line-number"},[t._v("4")]),e("br"),e("span",{staticClass:"line-number"},[t._v("5")]),e("br"),e("span",{staticClass:"line-number"},[t._v("6")]),e("br"),e("span",{staticClass:"line-number"},[t._v("7")]),e("br")])]),e("p",[t._v("那么 "),e("code",[t._v("React v16")]),t._v(" 是如何解决中断更新时DOM渲染不完全的问题呢？")]),t._v(" "),e("p",[t._v("在 "),e("code",[t._v("React v16")]),t._v(" 中， "),e("code",[t._v("Reconciler")]),t._v(" 与 "),e("code",[t._v("Renderer")]),t._v(" 不再是交替工作。当 "),e("code",[t._v("Scheduler")]),t._v(" 将任务交给 "),e("code",[t._v("Reconciler")]),t._v(" 后， "),e("code",[t._v("Reconciler")]),t._v(" 会为变化的 "),e("code",[t._v("虚拟DOM")]),t._v(" 打上代表增/删/更新的标记，类似这样：")]),t._v(" "),e("div",{staticClass:"language-javascript line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-javascript"}},[e("code",[e("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// You can change the rest (and add more).")]),t._v("\n"),e("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("export")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("const")]),t._v(" Placement "),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token comment"}},[t._v("/*                    */")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token number"}},[t._v("0b0000000000000000010")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n"),e("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("export")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("const")]),t._v(" Update "),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token comment"}},[t._v("/*                       */")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token number"}},[t._v("0b0000000000000000100")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n"),e("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("export")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("const")]),t._v(" PlacementAndUpdate "),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token comment"}},[t._v("/*           */")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token number"}},[t._v("0b0000000000000000110")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n"),e("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("export")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("const")]),t._v(" Deletion "),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token comment"}},[t._v("/*                     */")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token number"}},[t._v("0b0000000000000001000")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n")])]),t._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[t._v("1")]),e("br"),e("span",{staticClass:"line-number"},[t._v("2")]),e("br"),e("span",{staticClass:"line-number"},[t._v("3")]),e("br"),e("span",{staticClass:"line-number"},[t._v("4")]),e("br"),e("span",{staticClass:"line-number"},[t._v("5")]),e("br")])]),e("blockquote",[e("p",[t._v("全部的"),e("a",{attrs:{href:"https://github.com/facebook/react/blob/master/packages/react-reconciler/src/ReactFiberFlags.js",target:"_blank",rel:"noopener noreferrer"}},[t._v("标记"),e("OutboundLink")],1)])]),t._v(" "),e("p",[t._v("整个 "),e("code",[t._v("Scheduler")]),t._v(" 与 "),e("code",[t._v("Reconciler")]),t._v(" 的工作都在内存中进行。只有当所有组件都完成 "),e("code",[t._v("Reconciler")]),t._v(" 的工作，才会统一交给 "),e("code",[t._v("Renderer")]),t._v(" 。")]),t._v(" "),e("blockquote",[e("p",[t._v("你可以在"),e("a",{attrs:{href:"https://react.docschina.org/docs/codebase-overview.html#fiber-reconciler",target:"_blank",rel:"noopener noreferrer"}},[t._v("这里"),e("OutboundLink")],1),t._v("看到 React 官方对 React v16 Fiber Reconciler 的解释")])]),t._v(" "),e("h3",{attrs:{id:"renderer-渲染器-2"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#renderer-渲染器-2"}},[t._v("#")]),t._v(" Renderer（渲染器）")]),t._v(" "),e("p",[e("code",[t._v("Renderer")]),t._v(" 根据 "),e("code",[t._v("Reconciler")]),t._v(" 为虚拟DOM打的标记，同步执行对应的DOM操作。")]),t._v(" "),e("p",[t._v("所以，对于我们在上一节使用过的 demo, 在 React 16 架构中整个更新流程为：")]),t._v(" "),e("p",[e("img",{attrs:{src:a(535),alt:"v16-example"}})]),t._v(" "),e("p",[t._v("其中红框中的步骤随时可能由于以下原因被中断：")]),t._v(" "),e("ul",[e("li",[t._v("有其他更高优任务需要先更新")]),t._v(" "),e("li",[t._v("当前帧没有剩余时间")])]),t._v(" "),e("p",[t._v("由于红框中的工作都在内存中进行，不会更新页面上的DOM，所以即使反复中断，用户也不会看见更新不完全的DOM（即上一节演示的情况）。")]),t._v(" "),e("p",[t._v("由于 "),e("code",[t._v("Reconciler")]),t._v(" 是 "),e("code",[t._v("React")]),t._v(" 对外提供的独立的包，我们可以根据其开放的 "),e("code",[t._v("API")]),t._v(" ，自定义自己的 "),e("code",[t._v("Renderer")]),t._v(" 。")]),t._v(" "),e("blockquote",[e("p",[e("a",{attrs:{href:"https://www.youtube.com/watch?reload=9&v=CGpMlWVcHok&list=PLPxbbTqCLbGHPxZpw4xj_Wwg8-fdNxJRh&index=7",target:"_blank",rel:"noopener noreferrer"}},[t._v("[Youtube] Building a Custom React Renderer | Sophie Alpert 🚀"),e("OutboundLink")],1)])]),t._v(" "),e("h2",{attrs:{id:"fiber"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#fiber"}},[t._v("#")]),t._v(" Fiber")]),t._v(" "),e("p",[t._v("根据 "),e("a",{attrs:{href:"https://mobile.twitter.com/dan_abramov",target:"_blank",rel:"noopener noreferrer"}},[t._v("Dan Abramov"),e("OutboundLink")],1),t._v(" 博客中的一篇关于"),e("a",{attrs:{href:"https://overreacted.io/algebraic-effects-for-the-rest-of-us/",target:"_blank",rel:"noopener noreferrer"}},[t._v("代数效应"),e("OutboundLink")],1),t._v("文章中我们可以知道， "),e("code",[t._v("React")]),t._v(" 核心团队成员 "),e("code",[t._v("Sebastian Markbåge")]),t._v("（React Hooks的发明者）曾说：我们在 "),e("code",[t._v("React")]),t._v(" 中做的就是践行代数效应（Algebraic Effects）。")]),t._v(" "),e("p",[t._v("至于什么是代数效应，可以看一下上段提到的 "),e("code",[t._v("Dan Abramov")]),t._v(" 博客中的那篇关于代数效应的文章，这里不过多的展开了。大概的讲述一下代数效应。")]),t._v(" "),e("p",[t._v("代数效应是一项研究中的编程语言特性。具体表现为当代码逻辑进入效应处理器后，在处理完副作用后返回继续执行剩余的逻辑。并且代数效应这种方式可以将代码中的 "),e("code",[t._v("what")]),t._v(" 和 "),e("code",[t._v("how")]),t._v(" 分开，这让你在写代码时可以把更多的精力放到关注 "),e("code",[t._v("what")]),t._v(" 上。")]),t._v(" "),e("p",[t._v("React 中的 "),e("a",{attrs:{href:"https://react.docschina.org/docs/hooks-intro.html",target:"_blank",rel:"noopener noreferrer"}},[t._v("Hooks"),e("OutboundLink")],1),t._v(" 和 "),e("a",{attrs:{href:"https://react.docschina.org/docs/concurrent-mode-suspense.html",target:"_blank",rel:"noopener noreferrer"}},[t._v("Suspense"),e("OutboundLink")],1),t._v(" 的灵感都来自代数效应。")]),t._v(" "),e("h3",{attrs:{id:"心智模型"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#心智模型"}},[t._v("#")]),t._v(" 心智模型")]),t._v(" "),e("h4",{attrs:{id:"代数效应和generator"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#代数效应和generator"}},[t._v("#")]),t._v(" "),e("strong",[t._v("代数效应和Generator")])]),t._v(" "),e("p",[t._v("从 "),e("code",[t._v("React v15")]),t._v(" 到 "),e("code",[t._v("React v16")]),t._v(" ，协调器（ "),e("code",[t._v("Reconciler")]),t._v(" ）重构的一大目的是：将老的 "),e("code",[t._v("同步更新")]),t._v(" 的架构变为 "),e("code",[t._v("异步可中断更新")]),t._v(" 。")]),t._v(" "),e("p",[e("code",[t._v("异步可中断更新")]),t._v(" 可以理解为：更新在执行过程中可能会被打断（浏览器时间分片用尽或有更高优任务插队），当可以继续执行时恢复之前执行的中间状态。")]),t._v(" "),e("p",[t._v("其实，浏览器原生就支持类似的实现，这就是 "),e("code",[t._v("Generator")]),t._v(" 。")]),t._v(" "),e("p",[t._v("但是 "),e("code",[t._v("Generator")]),t._v(" 的一些缺陷使 "),e("code",[t._v("React")]),t._v(" 团队放弃了他：")]),t._v(" "),e("ul",[e("li",[t._v("类似 "),e("code",[t._v("async")]),t._v(" ， "),e("code",[t._v("Generator")]),t._v(" 也是传染性的，使用了 "),e("code",[t._v("Generator")]),t._v(" 则上下文的其他函数也需要作出改变。这样心智负担比较重。")]),t._v(" "),e("li",[e("code",[t._v("Generator")]),t._v(" 执行的中间状态是上下文关联的。")])]),t._v(" "),e("p",[t._v("考虑如下例子：")]),t._v(" "),e("div",{staticClass:"language-javascript line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-javascript"}},[e("code",[e("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("function")]),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v("*")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token function"}},[t._v("doWork")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),e("span",{pre:!0,attrs:{class:"token parameter"}},[e("span",{pre:!0,attrs:{class:"token constant"}},[t._v("A")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token constant"}},[t._v("B")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token constant"}},[t._v("C")])]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n  "),e("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("var")]),t._v(" x "),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token function"}},[t._v("doExpensiveWorkA")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),e("span",{pre:!0,attrs:{class:"token constant"}},[t._v("A")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n  "),e("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("yield")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n  "),e("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("var")]),t._v(" y "),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" x "),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v("+")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token function"}},[t._v("doExpensiveWorkB")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),e("span",{pre:!0,attrs:{class:"token constant"}},[t._v("B")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n  "),e("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("yield")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n  "),e("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("var")]),t._v(" z "),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" y "),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v("+")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token function"}},[t._v("doExpensiveWorkC")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),e("span",{pre:!0,attrs:{class:"token constant"}},[t._v("C")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n  "),e("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("return")]),t._v(" z"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n")])]),t._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[t._v("1")]),e("br"),e("span",{staticClass:"line-number"},[t._v("2")]),e("br"),e("span",{staticClass:"line-number"},[t._v("3")]),e("br"),e("span",{staticClass:"line-number"},[t._v("4")]),e("br"),e("span",{staticClass:"line-number"},[t._v("5")]),e("br"),e("span",{staticClass:"line-number"},[t._v("6")]),e("br"),e("span",{staticClass:"line-number"},[t._v("7")]),e("br"),e("span",{staticClass:"line-number"},[t._v("8")]),e("br")])]),e("p",[t._v("每当浏览器有空闲时间都会依次执行其中一个 "),e("code",[t._v("doExpensiveWork")]),t._v(" ，当时间用尽则会中断，当再次恢复时会从中断位置继续执行。")]),t._v(" "),e("p",[t._v("只考虑“单一优先级任务的中断与继续”情况下 "),e("code",[t._v("Generator")]),t._v(" 可以很好的实现异步可中断更新。")]),t._v(" "),e("p",[t._v("但是当我们考虑“高优先级任务插队”的情况，如果此时已经完成 "),e("code",[t._v("doExpensiveWorkA")]),t._v(" 与 "),e("code",[t._v("doExpensiveWorkB")]),t._v(" 计算出x与y。")]),t._v(" "),e("p",[t._v("此时B组件接收到一个高优更新，由于 "),e("code",[t._v("Generator")]),t._v(" 执行的中间状态是上下文关联的，所以计算y时无法复用之前已经计算出的x，需要重新计算。")]),t._v(" "),e("p",[t._v("如果通过全局变量保存之前执行的中间状态，又会引入新的复杂度。")]),t._v(" "),e("blockquote",[e("p",[t._v("更详细的解释可以参考这个"),e("a",{attrs:{href:"https://github.com/facebook/react/issues/7942#issuecomment-254987818",target:"_blank",rel:"noopener noreferrer"}},[t._v("issue"),e("OutboundLink")],1)])]),t._v(" "),e("p",[t._v("基于这些原因， "),e("code",[t._v("React")]),t._v(" 没有采用 "),e("code",[t._v("Generator")]),t._v(" 实现协调器。")]),t._v(" "),e("h4",{attrs:{id:"代数效应和fiber"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#代数效应和fiber"}},[t._v("#")]),t._v(" "),e("strong",[t._v("代数效应和Fiber")])]),t._v(" "),e("p",[e("code",[t._v("Fiber")]),t._v(" 并不是计算机术语中的新名词，他的中文翻译叫做纤程，与 "),e("code",[t._v("进程（Process）")]),t._v(" 、 "),e("code",[t._v("线程（Thread）")]),t._v(" 、 "),e("code",[t._v("协程（Coroutine）")]),t._v(" 同为程序执行过程。")]),t._v(" "),e("p",[t._v("在很多文章中将纤程理解为协程的一种实现。在 "),e("code",[t._v("JS")]),t._v(" 中，协程的实现便是 "),e("code",[t._v("Generator")]),t._v(" 。")]),t._v(" "),e("p",[t._v("所以，我们可以将 "),e("code",[t._v("纤程(Fiber)")]),t._v(" 、 "),e("code",[t._v("协程(Generator)")]),t._v(" 理解为代数效应思想在JS中的体现。")]),t._v(" "),e("p",[e("code",[t._v("React Fiber")]),t._v(" 可以理解为：")]),t._v(" "),e("p",[e("code",[t._v("React")]),t._v(" 内部实现的一套状态更新机制。支持任务不同优先级，可中断与恢复，并且恢复后可以复用之前的中间状态。")]),t._v(" "),e("p",[t._v("其中每个任务更新单元为 "),e("code",[t._v("React Element")]),t._v(" 对应的 "),e("code",[t._v("Fiber")]),t._v(" 节点。")]),t._v(" "),e("h3",{attrs:{id:"实现原理"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#实现原理"}},[t._v("#")]),t._v(" 实现原理")]),t._v(" "),e("p",[t._v("在 "),e("code",[t._v("React")]),t._v(" 中 "),e("code",[t._v("虚拟DOM")]),t._v(" 有一个正式的称呼 —— "),e("code",[t._v("Fiber")])]),t._v(" "),e("h4",{attrs:{id:"起源"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#起源"}},[t._v("#")]),t._v(" 起源")]),t._v(" "),e("blockquote",[e("p",[t._v("最早的Fiber官方解释来源于2016年 React 团队成员 Acdlite 的一篇"),e("a",{attrs:{href:"https://github.com/acdlite/react-fiber-architecture",target:"_blank",rel:"noopener noreferrer"}},[t._v("介绍"),e("OutboundLink")],1),t._v("。")])]),t._v(" "),e("p",[t._v("从上一章的学习我们知道：")]),t._v(" "),e("p",[t._v("在 "),e("code",[t._v("React v15")]),t._v(" 及以前， "),e("code",[t._v("Reconciler")]),t._v(" 采用 "),e("code",[t._v("递归")]),t._v(" 的方式创建虚拟DOM，递归过程是不能中断的。如果组件树的层级很深，递归会占用线程很多时间，造成卡顿。")]),t._v(" "),e("p",[t._v("为了解决这个问题， "),e("code",[t._v("React v16")]),t._v(" 将 "),e("code",[t._v("递归")]),t._v(" 的无法中断的更新重构为 "),e("code",[t._v("异步可中断")]),t._v(" 更新，由于曾经用于递归的 "),e("code",[t._v("虚拟DOM")]),t._v(" 数据结构已经无法满足需要。于是，全新的 "),e("code",[t._v("Fiber架构")]),t._v(" 应运而生。")]),t._v(" "),e("h4",{attrs:{id:"含义"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#含义"}},[t._v("#")]),t._v(" 含义")]),t._v(" "),e("p",[e("code",[t._v("Fiber")]),t._v(" 包含三层含义：")]),t._v(" "),e("ul",[e("li",[t._v("作为架构来说，之前 "),e("code",[t._v("React v15")]),t._v(" 的 "),e("code",[t._v("Reconciler")]),t._v(" 采用递归的方式执行，数据保存在递归调用栈中，所以被称为 "),e("code",[t._v("Stack Reconciler")]),t._v(" 。 "),e("code",[t._v("React v16")]),t._v(" 的 "),e("code",[t._v("Reconciler")]),t._v(" 基于 "),e("code",[t._v("Fiber")]),t._v(" 节点实现，被称为 "),e("code",[t._v("Fiber Reconciler")]),t._v(" 。")]),t._v(" "),e("li",[t._v("作为静态的数据结构来说，每个 "),e("code",[t._v("Fiber")]),t._v(" 节点对应一个 "),e("code",[t._v("React element")]),t._v(" ，保存了该组件的类型（函数组件/类组件/原生组件等）、对应的 "),e("code",[t._v("DOM节点")]),t._v(" 等信息。")]),t._v(" "),e("li",[t._v("作为动态的工作单元来说，每个 "),e("code",[t._v("Fiber")]),t._v(" 节点保存了本次更新中该组件改变的状态、要执行的工作（需要被删除/被插入页面中/被更新等）。")])]),t._v(" "),e("h4",{attrs:{id:"结构"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#结构"}},[t._v("#")]),t._v(" 结构")]),t._v(" "),e("p",[t._v("你可以从这里看到"),e("a",{attrs:{href:"https://github.com/facebook/react/blob/master/packages/react-reconciler/src/ReactFiber.new.js#L116",target:"_blank",rel:"noopener noreferrer"}},[t._v("Fiber节点的属性定义"),e("OutboundLink")],1),t._v("。虽然属性很多，但我们可以按三层含义将他们分类来看。")]),t._v(" "),e("div",{staticClass:"language-javascript line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-javascript"}},[e("code",[e("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// packages/react-reconciler/src/ReactFiber.new.js")]),t._v("\n\n"),e("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("function")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token function"}},[t._v("FiberNode")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("\n  "),e("span",{pre:!0,attrs:{class:"token parameter"}},[t._v("tag"),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" WorkTag"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n  pendingProps"),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" mixed"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n  key"),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("null")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v("|")]),t._v(" string"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n  mode"),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" TypeOfMode"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")])]),t._v("\n"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n  "),e("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 实例静态属性")]),t._v("\n  "),e("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("this")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("tag "),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" tag"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n  "),e("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("this")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("key "),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" key"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n  "),e("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("this")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("elementType "),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("null")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n  "),e("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("this")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("type "),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("null")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n  "),e("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("this")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("stateNode "),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("null")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n\n  "),e("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 链接其他Fiber实例的属性")]),t._v("\n  "),e("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("this")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("return "),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("null")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n  "),e("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("this")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("child "),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("null")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n  "),e("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("this")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("sibling "),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("null")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n  "),e("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("this")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("index "),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token number"}},[t._v("0")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n\n  "),e("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("this")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("ref "),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("null")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n\n  "),e("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 作为动态的工作单元的属性")]),t._v("\n  "),e("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("this")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("pendingProps "),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" pendingProps"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n  "),e("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("this")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("memoizedProps "),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("null")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n  "),e("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("this")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("updateQueue "),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("null")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n  "),e("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("this")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("memoizedState "),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("null")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n  "),e("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("this")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("dependencies "),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("null")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n\n  "),e("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("this")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("mode "),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" mode"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n\n  "),e("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// Effects")]),t._v("\n  "),e("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("this")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("flags "),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" NoFlags"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n  "),e("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("this")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("subtreeFlags "),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" NoFlags"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n  "),e("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("this")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("deletions "),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("null")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n\n  "),e("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 调用优先级相关属性")]),t._v("\n  "),e("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("this")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("lanes "),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" NoLanes"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n  "),e("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("this")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("childLanes "),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" NoLanes"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n\n  "),e("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("this")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("alternate "),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("null")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n\n  "),e("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("if")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("enableProfilerTimer"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n    "),e("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// Note: The following is done to avoid a v8 performance cliff.")]),t._v("\n    "),e("span",{pre:!0,attrs:{class:"token comment"}},[t._v("//")]),t._v("\n    "),e("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// Initializing the fields below to smis and later updating them with")]),t._v("\n    "),e("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// double values will cause Fibers to end up having separate shapes.")]),t._v("\n    "),e("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// This behavior/bug has something to do with Object.preventExtension().")]),t._v("\n    "),e("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// Fortunately this only impacts DEV builds.")]),t._v("\n    "),e("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// Unfortunately it makes React unusably slow for some applications.")]),t._v("\n    "),e("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// To work around this, initialize the fields below with doubles.")]),t._v("\n    "),e("span",{pre:!0,attrs:{class:"token comment"}},[t._v("//")]),t._v("\n    "),e("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// Learn more about this here:")]),t._v("\n    "),e("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// https://github.com/facebook/react/issues/14365")]),t._v("\n    "),e("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// https://bugs.chromium.org/p/v8/issues/detail?id=8538")]),t._v("\n    "),e("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("this")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("actualDuration "),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" Number"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),e("span",{pre:!0,attrs:{class:"token number"}},[t._v("NaN")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    "),e("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("this")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("actualStartTime "),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" Number"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),e("span",{pre:!0,attrs:{class:"token number"}},[t._v("NaN")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    "),e("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("this")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("selfBaseDuration "),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" Number"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),e("span",{pre:!0,attrs:{class:"token number"}},[t._v("NaN")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    "),e("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("this")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("treeBaseDuration "),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" Number"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),e("span",{pre:!0,attrs:{class:"token number"}},[t._v("NaN")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n\n    "),e("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// It's okay to replace the initial doubles with smis after initialization.")]),t._v("\n    "),e("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// This won't trigger the performance cliff mentioned above,")]),t._v("\n    "),e("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// and it simplifies other profiler code (including DevTools).")]),t._v("\n    "),e("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("this")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("actualDuration "),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token number"}},[t._v("0")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    "),e("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("this")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("actualStartTime "),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v("-")]),e("span",{pre:!0,attrs:{class:"token number"}},[t._v("1")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    "),e("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("this")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("selfBaseDuration "),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token number"}},[t._v("0")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    "),e("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("this")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("treeBaseDuration "),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token number"}},[t._v("0")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n  "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n  "),e("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// ...")]),t._v("\n"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n")])]),t._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[t._v("1")]),e("br"),e("span",{staticClass:"line-number"},[t._v("2")]),e("br"),e("span",{staticClass:"line-number"},[t._v("3")]),e("br"),e("span",{staticClass:"line-number"},[t._v("4")]),e("br"),e("span",{staticClass:"line-number"},[t._v("5")]),e("br"),e("span",{staticClass:"line-number"},[t._v("6")]),e("br"),e("span",{staticClass:"line-number"},[t._v("7")]),e("br"),e("span",{staticClass:"line-number"},[t._v("8")]),e("br"),e("span",{staticClass:"line-number"},[t._v("9")]),e("br"),e("span",{staticClass:"line-number"},[t._v("10")]),e("br"),e("span",{staticClass:"line-number"},[t._v("11")]),e("br"),e("span",{staticClass:"line-number"},[t._v("12")]),e("br"),e("span",{staticClass:"line-number"},[t._v("13")]),e("br"),e("span",{staticClass:"line-number"},[t._v("14")]),e("br"),e("span",{staticClass:"line-number"},[t._v("15")]),e("br"),e("span",{staticClass:"line-number"},[t._v("16")]),e("br"),e("span",{staticClass:"line-number"},[t._v("17")]),e("br"),e("span",{staticClass:"line-number"},[t._v("18")]),e("br"),e("span",{staticClass:"line-number"},[t._v("19")]),e("br"),e("span",{staticClass:"line-number"},[t._v("20")]),e("br"),e("span",{staticClass:"line-number"},[t._v("21")]),e("br"),e("span",{staticClass:"line-number"},[t._v("22")]),e("br"),e("span",{staticClass:"line-number"},[t._v("23")]),e("br"),e("span",{staticClass:"line-number"},[t._v("24")]),e("br"),e("span",{staticClass:"line-number"},[t._v("25")]),e("br"),e("span",{staticClass:"line-number"},[t._v("26")]),e("br"),e("span",{staticClass:"line-number"},[t._v("27")]),e("br"),e("span",{staticClass:"line-number"},[t._v("28")]),e("br"),e("span",{staticClass:"line-number"},[t._v("29")]),e("br"),e("span",{staticClass:"line-number"},[t._v("30")]),e("br"),e("span",{staticClass:"line-number"},[t._v("31")]),e("br"),e("span",{staticClass:"line-number"},[t._v("32")]),e("br"),e("span",{staticClass:"line-number"},[t._v("33")]),e("br"),e("span",{staticClass:"line-number"},[t._v("34")]),e("br"),e("span",{staticClass:"line-number"},[t._v("35")]),e("br"),e("span",{staticClass:"line-number"},[t._v("36")]),e("br"),e("span",{staticClass:"line-number"},[t._v("37")]),e("br"),e("span",{staticClass:"line-number"},[t._v("38")]),e("br"),e("span",{staticClass:"line-number"},[t._v("39")]),e("br"),e("span",{staticClass:"line-number"},[t._v("40")]),e("br"),e("span",{staticClass:"line-number"},[t._v("41")]),e("br"),e("span",{staticClass:"line-number"},[t._v("42")]),e("br"),e("span",{staticClass:"line-number"},[t._v("43")]),e("br"),e("span",{staticClass:"line-number"},[t._v("44")]),e("br"),e("span",{staticClass:"line-number"},[t._v("45")]),e("br"),e("span",{staticClass:"line-number"},[t._v("46")]),e("br"),e("span",{staticClass:"line-number"},[t._v("47")]),e("br"),e("span",{staticClass:"line-number"},[t._v("48")]),e("br"),e("span",{staticClass:"line-number"},[t._v("49")]),e("br"),e("span",{staticClass:"line-number"},[t._v("50")]),e("br"),e("span",{staticClass:"line-number"},[t._v("51")]),e("br"),e("span",{staticClass:"line-number"},[t._v("52")]),e("br"),e("span",{staticClass:"line-number"},[t._v("53")]),e("br"),e("span",{staticClass:"line-number"},[t._v("54")]),e("br"),e("span",{staticClass:"line-number"},[t._v("55")]),e("br"),e("span",{staticClass:"line-number"},[t._v("56")]),e("br"),e("span",{staticClass:"line-number"},[t._v("57")]),e("br"),e("span",{staticClass:"line-number"},[t._v("58")]),e("br"),e("span",{staticClass:"line-number"},[t._v("59")]),e("br"),e("span",{staticClass:"line-number"},[t._v("60")]),e("br"),e("span",{staticClass:"line-number"},[t._v("61")]),e("br"),e("span",{staticClass:"line-number"},[t._v("62")]),e("br"),e("span",{staticClass:"line-number"},[t._v("63")]),e("br"),e("span",{staticClass:"line-number"},[t._v("64")]),e("br"),e("span",{staticClass:"line-number"},[t._v("65")]),e("br"),e("span",{staticClass:"line-number"},[t._v("66")]),e("br"),e("span",{staticClass:"line-number"},[t._v("67")]),e("br"),e("span",{staticClass:"line-number"},[t._v("68")]),e("br"),e("span",{staticClass:"line-number"},[t._v("69")]),e("br"),e("span",{staticClass:"line-number"},[t._v("70")]),e("br"),e("span",{staticClass:"line-number"},[t._v("71")]),e("br")])]),e("ul",[e("li",[e("strong",[t._v("架构方面")])])]),t._v(" "),e("p",[t._v("每个 "),e("code",[t._v("Fiber节点")]),t._v(" 有个对应的 "),e("code",[t._v("React element")]),t._v(" ，多个 "),e("code",[t._v("Fiber节点")]),t._v(" 是如何连接形成树呢？靠如下三个属性：")]),t._v(" "),e("div",{staticClass:"language-javascript line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-javascript"}},[e("code",[e("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 指向父级Fiber节点")]),t._v("\n"),e("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("this")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("return "),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("null")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n"),e("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 指向子Fiber节点")]),t._v("\n"),e("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("this")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("child "),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("null")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n"),e("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 指向右边第一个兄弟Fiber节点")]),t._v("\n"),e("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("this")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("sibling "),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("null")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n")])]),t._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[t._v("1")]),e("br"),e("span",{staticClass:"line-number"},[t._v("2")]),e("br"),e("span",{staticClass:"line-number"},[t._v("3")]),e("br"),e("span",{staticClass:"line-number"},[t._v("4")]),e("br"),e("span",{staticClass:"line-number"},[t._v("5")]),e("br"),e("span",{staticClass:"line-number"},[t._v("6")]),e("br")])]),e("p",[t._v("举一个例子：")]),t._v(" "),e("div",{staticClass:"language-jsx line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-jsx"}},[e("code",[e("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("function")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token function"}},[t._v("App")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n  "),e("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("return")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("\n    "),e("span",{pre:!0,attrs:{class:"token tag"}},[e("span",{pre:!0,attrs:{class:"token tag"}},[e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("<")]),t._v("div")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(">")])]),e("span",{pre:!0,attrs:{class:"token plain-text"}},[t._v("\n      hello\n      ")]),e("span",{pre:!0,attrs:{class:"token tag"}},[e("span",{pre:!0,attrs:{class:"token tag"}},[e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("<")]),t._v("span")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(">")])]),e("span",{pre:!0,attrs:{class:"token plain-text"}},[t._v("react")]),e("span",{pre:!0,attrs:{class:"token tag"}},[e("span",{pre:!0,attrs:{class:"token tag"}},[e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("</")]),t._v("span")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(">")])]),e("span",{pre:!0,attrs:{class:"token plain-text"}},[t._v("\n    ")]),e("span",{pre:!0,attrs:{class:"token tag"}},[e("span",{pre:!0,attrs:{class:"token tag"}},[e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("</")]),t._v("div")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(">")])]),t._v("\n  "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n")])]),t._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[t._v("1")]),e("br"),e("span",{staticClass:"line-number"},[t._v("2")]),e("br"),e("span",{staticClass:"line-number"},[t._v("3")]),e("br"),e("span",{staticClass:"line-number"},[t._v("4")]),e("br"),e("span",{staticClass:"line-number"},[t._v("5")]),e("br"),e("span",{staticClass:"line-number"},[t._v("6")]),e("br"),e("span",{staticClass:"line-number"},[t._v("7")]),e("br"),e("span",{staticClass:"line-number"},[t._v("8")]),e("br")])]),e("p",[t._v("对应的 "),e("code",[t._v("Fiber 树")]),t._v(" 结构如下图所示：\n"),e("img",{attrs:{src:a(536),alt:"fiber-tree"}})]),t._v(" "),e("ul",[e("li",[e("strong",[t._v("静态数据结构")])])]),t._v(" "),e("p",[t._v("作为一种静态的数据结构，保存了组件相关的信息：")]),t._v(" "),e("div",{staticClass:"language-javascript line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-javascript"}},[e("code",[e("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// Fiber对应组件的类型 Function/Class/Host...")]),t._v("\n"),e("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("this")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("tag "),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" tag"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n"),e("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// key属性")]),t._v("\n"),e("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("this")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("key "),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" key"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n"),e("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 大部分情况同type，某些情况不同，比如FunctionComponent使用React.memo包裹")]),t._v("\n"),e("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("this")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("elementType "),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("null")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n"),e("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 对于 FunctionComponent，指函数本身，对于ClassComponent，指class，对于HostComponent，指DOM节点tagName")]),t._v("\n"),e("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("this")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("type "),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("null")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n"),e("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// Fiber对应的真实DOM节点")]),t._v("\n"),e("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("this")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("stateNode "),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("null")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n")])]),t._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[t._v("1")]),e("br"),e("span",{staticClass:"line-number"},[t._v("2")]),e("br"),e("span",{staticClass:"line-number"},[t._v("3")]),e("br"),e("span",{staticClass:"line-number"},[t._v("4")]),e("br"),e("span",{staticClass:"line-number"},[t._v("5")]),e("br"),e("span",{staticClass:"line-number"},[t._v("6")]),e("br"),e("span",{staticClass:"line-number"},[t._v("7")]),e("br"),e("span",{staticClass:"line-number"},[t._v("8")]),e("br"),e("span",{staticClass:"line-number"},[t._v("9")]),e("br"),e("span",{staticClass:"line-number"},[t._v("10")]),e("br")])]),e("ul",[e("li",[e("strong",[t._v("动态工作单元")])])]),t._v(" "),e("p",[t._v("作为动态的工作单元， "),e("code",[t._v("Fiber")]),t._v(" 中如下参数保存了本次更新相关的信息，我们会在后续的更新流程中使用到具体属性时再详细介绍：")]),t._v(" "),e("div",{staticClass:"language-javascript line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-javascript"}},[e("code",[e("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 作为动态的工作单元的属性")]),t._v("\n"),e("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("this")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("pendingProps "),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" pendingProps"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n"),e("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("this")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("memoizedProps "),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("null")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n"),e("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("this")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("updateQueue "),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("null")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n"),e("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("this")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("memoizedState "),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("null")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n"),e("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("this")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("dependencies "),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("null")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n\n"),e("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("this")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("mode "),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" mode"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n\n"),e("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// Effects")]),t._v("\n"),e("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("this")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("flags "),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" NoFlags"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n"),e("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("this")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("subtreeFlags "),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" NoFlags"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n"),e("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("this")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("deletions "),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("null")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n")])]),t._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[t._v("1")]),e("br"),e("span",{staticClass:"line-number"},[t._v("2")]),e("br"),e("span",{staticClass:"line-number"},[t._v("3")]),e("br"),e("span",{staticClass:"line-number"},[t._v("4")]),e("br"),e("span",{staticClass:"line-number"},[t._v("5")]),e("br"),e("span",{staticClass:"line-number"},[t._v("6")]),e("br"),e("span",{staticClass:"line-number"},[t._v("7")]),e("br"),e("span",{staticClass:"line-number"},[t._v("8")]),e("br"),e("span",{staticClass:"line-number"},[t._v("9")]),e("br"),e("span",{staticClass:"line-number"},[t._v("10")]),e("br"),e("span",{staticClass:"line-number"},[t._v("11")]),e("br"),e("span",{staticClass:"line-number"},[t._v("12")]),e("br"),e("span",{staticClass:"line-number"},[t._v("13")]),e("br")])]),e("p",[t._v("如下两个字段保存调度优先级相关的信息，会在讲解 "),e("code",[t._v("Scheduler")]),t._v(" 时介绍。")]),t._v(" "),e("div",{staticClass:"language-javascript line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-javascript"}},[e("code",[e("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 调度优先级相关")]),t._v("\n"),e("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("this")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("lanes "),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" NoLanes"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n"),e("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("this")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("childLanes "),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" NoLanes"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n")])]),t._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[t._v("1")]),e("br"),e("span",{staticClass:"line-number"},[t._v("2")]),e("br"),e("span",{staticClass:"line-number"},[t._v("3")]),e("br")])]),e("div",{staticClass:"custom-block warning"},[e("p",{staticClass:"custom-block-title"},[t._v("注意")]),t._v(" "),e("p",[t._v("在2020年5月，调度优先级策略经历了比较大的重构。以 "),e("code",[t._v("expirationTime")]),t._v(" 属性为代表的优先级模型被 "),e("code",[t._v("lane")]),t._v(" 取代。详见"),e("a",{attrs:{href:"https://github.com/facebook/react/pull/18796",target:"_blank",rel:"noopener noreferrer"}},[t._v("这个PR"),e("OutboundLink")],1)])]),t._v(" "),e("h3",{attrs:{id:"工作原理"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#工作原理"}},[t._v("#")]),t._v(" 工作原理")]),t._v(" "),e("h4",{attrs:{id:"双缓存"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#双缓存"}},[t._v("#")]),t._v(" 双缓存")]),t._v(" "),e("p",[t._v("首先我们需要了解一下 “双缓存” 技术。这里用我们比较熟悉的 "),e("code",[t._v("canvas")]),t._v(" 来举例。")]),t._v(" "),e("p",[t._v("当我们用 "),e("code",[t._v("canvas")]),t._v(" 绘制动画，每一帧绘制前都会调用 "),e("code",[t._v("ctx.clearRect")]),t._v(" 清除上一帧的画面。")]),t._v(" "),e("p",[t._v("如果当前帧画面计算量比较大，导致清除上一帧画面到绘制当前帧画面之间有较长间隙，就会出现白屏。")]),t._v(" "),e("p",[t._v("为了解决这个问题，我们可以在内存中绘制当前帧动画，绘制完毕后直接用当前帧替换上一帧画面，由于省去了两帧替换间的计算时间，不会出现从白屏到出现画面的闪烁情况。")]),t._v(" "),e("p",[t._v("这种"),e("strong",[t._v("在内存中构建并直接替换的技术")]),t._v("叫做双缓存。")]),t._v(" "),e("p",[e("code",[t._v("React")]),t._v(" 使用“双缓存”来完成 "),e("code",[t._v("Fiber树")]),t._v(" 的构建与替换——对应着DOM树的创建与更新。")]),t._v(" "),e("h4",{attrs:{id:"双缓存fiber树"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#双缓存fiber树"}},[t._v("#")]),t._v(" 双缓存Fiber树")]),t._v(" "),e("p",[t._v("在 "),e("code",[t._v("React")]),t._v(" 中最多会同时存在两棵 "),e("code",[t._v("Fiber树")]),t._v(" 。当前屏幕上显示内容对应的 "),e("code",[t._v("Fiber树")]),t._v(" 称为 "),e("code",[t._v("Current Fiber Tree")]),t._v(" ，正在内存中构建的 "),e("code",[t._v("Fiber树")]),t._v(" 称为 "),e("code",[t._v("WorkInProgress Fiber Tree")]),t._v(" 。")]),t._v(" "),e("p",[e("code",[t._v("Current Fiber Tree")]),t._v(" 中的 "),e("code",[t._v("Fiber节点")]),t._v(" 被称为 "),e("code",[t._v("current fiber")]),t._v(" ， "),e("code",[t._v("WorkInProgress Fiber Tree")]),t._v(" 中的 "),e("code",[t._v("Fiber节点")]),t._v(" 被称为 "),e("code",[t._v("workInProgress fiber")]),t._v(" "),e("code",[t._v("，他们通过alternate")]),t._v(" 属性连接。")]),t._v(" "),e("div",{staticClass:"language-javascript line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-javascript"}},[e("code",[t._v("workInProgress"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("alternate "),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" current"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\ncurrent"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("alternate "),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" workInProgress"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n")])]),t._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[t._v("1")]),e("br"),e("span",{staticClass:"line-number"},[t._v("2")]),e("br")])]),e("p",[e("code",[t._v("React")]),t._v(" 应用的根节点通过 "),e("code",[t._v("current")]),t._v(" 指针在不同 "),e("code",[t._v("Fiber树")]),t._v(" 的 "),e("code",[t._v("rootFiber")]),t._v(" 间切换来实现 "),e("code",[t._v("Fiber树")]),t._v(" 的切换。")]),t._v(" "),e("p",[t._v("当 "),e("code",[t._v("WorkInProgress Fiber Tree")]),t._v(" 构建完成交给 "),e("code",[t._v("Renderer")]),t._v(" 渲染在页面上后，应用根节点的 "),e("code",[t._v("current")]),t._v(" 指针指向 "),e("code",[t._v("WorkInProgress Fiber Tree")]),t._v(" ，此时 "),e("code",[t._v("WorkInProgress Fiber Tree")]),t._v(" 就变为 "),e("code",[t._v("Current Fiber Tree")]),t._v(" 。")]),t._v(" "),e("p",[t._v("每次状态更新都会产生新的 "),e("code",[t._v("WorkInProgress Fiber Tree")]),t._v(" ，通过 "),e("code",[t._v("current")]),t._v(" 与 "),e("code",[t._v("workInProgress")]),t._v(" 的替换，完成DOM更新。")]),t._v(" "),e("h4",{attrs:{id:"mount时构建fiber-tree"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#mount时构建fiber-tree"}},[t._v("#")]),t._v(" mount时构建Fiber tree")]),t._v(" "),e("p",[t._v("考虑如下例子：")]),t._v(" "),e("div",{staticClass:"language-jsx line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-jsx"}},[e("code",[e("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("function")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token function"}},[t._v("App")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n  "),e("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("const")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),t._v("num"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" add"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token function"}},[t._v("useState")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),e("span",{pre:!0,attrs:{class:"token number"}},[t._v("0")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n  "),e("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("return")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("\n    "),e("span",{pre:!0,attrs:{class:"token tag"}},[e("span",{pre:!0,attrs:{class:"token tag"}},[e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("<")]),t._v("p")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token attr-name"}},[t._v("onClick")]),e("span",{pre:!0,attrs:{class:"token script language-javascript"}},[e("span",{pre:!0,attrs:{class:"token script-punctuation punctuation"}},[t._v("=")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=>")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token function"}},[t._v("add")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("num "),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v("+")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token number"}},[t._v("1")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")])]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(">")])]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("num"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),e("span",{pre:!0,attrs:{class:"token tag"}},[e("span",{pre:!0,attrs:{class:"token tag"}},[e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("</")]),t._v("p")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(">")])]),t._v("\n  "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n\nReactDOM"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),e("span",{pre:!0,attrs:{class:"token function"}},[t._v("render")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),e("span",{pre:!0,attrs:{class:"token tag"}},[e("span",{pre:!0,attrs:{class:"token tag"}},[e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("<")]),e("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("App")])]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("/>")])]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" document"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),e("span",{pre:!0,attrs:{class:"token function"}},[t._v("getElementById")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),e("span",{pre:!0,attrs:{class:"token string"}},[t._v("'root'")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n")])]),t._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[t._v("1")]),e("br"),e("span",{staticClass:"line-number"},[t._v("2")]),e("br"),e("span",{staticClass:"line-number"},[t._v("3")]),e("br"),e("span",{staticClass:"line-number"},[t._v("4")]),e("br"),e("span",{staticClass:"line-number"},[t._v("5")]),e("br"),e("span",{staticClass:"line-number"},[t._v("6")]),e("br"),e("span",{staticClass:"line-number"},[t._v("7")]),e("br"),e("span",{staticClass:"line-number"},[t._v("8")]),e("br")])]),e("ol",[e("li",[t._v("首先，首次执行 "),e("code",[t._v("ReactDOM.render")]),t._v(" 会创建 "),e("code",[t._v("fiberRootNode")]),t._v(" （源码中叫 "),e("code",[t._v("fiberRoot")]),t._v(" ）和 "),e("code",[t._v("rootFiber")]),t._v(" 。其中 "),e("code",[t._v("fiberRootNode")]),t._v(" 是整个应用的根节点， "),e("code",[t._v("rootFiber")]),t._v(" 是"),e("code",[t._v("<App/>")]),t._v("所在组件树的根节点。")])]),t._v(" "),e("p",[t._v("之所以要区分 "),e("code",[t._v("fiberRootNode")]),t._v(" 与 "),e("code",[t._v("rootFiber")]),t._v(" ，是因为在应用中我们可以多次调用 "),e("code",[t._v("ReactDOM.render")]),t._v(" 渲染不同的组件树，他们会拥有不同的 "),e("code",[t._v("rootFiber")]),t._v(" 。但是整个应用的根节点只有一个，那就是 "),e("code",[t._v("fiberRootNode")]),t._v(" 。")]),t._v(" "),e("p",[e("code",[t._v("fiberRootNode")]),t._v(" 的 "),e("code",[t._v("current")]),t._v(" 会指向当前页面上已渲染内容对应对 "),e("code",[t._v("Fiber树")]),t._v(" ，被称为 "),e("code",[t._v("Current Fiber Tree")]),t._v(" 。\n"),e("img",{attrs:{src:a(537),alt:"mount-fiber-tree-1"}})]),t._v(" "),e("div",{staticClass:"language-javascript line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-javascript"}},[e("code",[e("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// packages/react-reconciler/src/ReactFiberRoot.new.js -> createFiberRoot function")]),t._v("\n\n"),e("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// Cyclic construction. This cheats the type system right now because")]),t._v("\n"),e("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// stateNode is any.")]),t._v("\n"),e("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("const")]),t._v(" uninitializedFiber "),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token function"}},[t._v("createHostRootFiber")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("tag"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\nroot"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("current "),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" uninitializedFiber"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n")])]),t._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[t._v("1")]),e("br"),e("span",{staticClass:"line-number"},[t._v("2")]),e("br"),e("span",{staticClass:"line-number"},[t._v("3")]),e("br"),e("span",{staticClass:"line-number"},[t._v("4")]),e("br"),e("span",{staticClass:"line-number"},[t._v("5")]),e("br"),e("span",{staticClass:"line-number"},[t._v("6")]),e("br")])]),e("p",[t._v("由于是首屏渲染，页面中还没有挂载任何 "),e("code",[t._v("DOM")]),t._v(" ，所以 "),e("code",[t._v("fiberRootNode.current")]),t._v(" 指向的 "),e("code",[t._v("rootFiber")]),t._v(" 没有任何子 "),e("code",[t._v("Fiber节点")]),t._v(" （即current Fiber树为空）。")]),t._v(" "),e("ol",{attrs:{start:"2"}},[e("li",[t._v("接下来进入 "),e("code",[t._v("render")]),t._v(" 阶段，根据组件返回的 "),e("code",[t._v("JSX")]),t._v(" 在内存中依次创建 "),e("code",[t._v("Fiber 节点")]),t._v(" 并连接在一起构建 "),e("code",[t._v("Fiber 树")]),t._v(" ，被称为 "),e("code",[t._v("WorkInProgress Fiber Tree")]),t._v(" 。（下图中右侧为内存中构建的树，左侧为页面显示的树）\n"),e("img",{attrs:{src:a(538),alt:"mount-fiber-tree-2"}})]),t._v(" "),e("li",[t._v("图中右侧已构建完的 "),e("code",[t._v("WorkInProgress Fiber Tree")]),t._v(" 在 "),e("code",[t._v("commit阶段")]),t._v(" 渲染到页面。")])]),t._v(" "),e("p",[t._v("此时DOM更新为右侧树对应的样子。"),e("code",[t._v("fiberRootNode")]),t._v(" 的 "),e("code",[t._v("current")]),t._v(" 指针指向 "),e("code",[t._v("WorkInProgress Fiber Tree")]),t._v(" 使其变为 "),e("code",[t._v("Current Fiber Tree")]),t._v(" 。\n"),e("img",{attrs:{src:a(539),alt:"mount-fiber-tree-3"}})]),t._v(" "),e("h4",{attrs:{id:"update时替换fiber-tree"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#update时替换fiber-tree"}},[t._v("#")]),t._v(" update时替换Fiber tree")]),t._v(" "),e("ol",[e("li",[t._v("接下来我们点击 p 节点触发状态改变，这会开启一次新的 "),e("code",[t._v("render阶段")]),t._v(" 并构建一棵新的 "),e("code",[t._v("WorkInProgress Fiber Tree")]),t._v(" 。\n"),e("img",{attrs:{src:a(540),alt:"update-fiber-tree-1"}}),t._v("\n和 "),e("code",[t._v("mount")]),t._v(" 时一样，"),e("code",[t._v("workInProgress fiber")]),t._v(" 的创建可以复用 "),e("code",[t._v("Current Fiber Tree")]),t._v(" 对应的节点数据。")])]),t._v(" "),e("blockquote",[e("p",[t._v("这个决定是否复用的过程就是Diff算法")])]),t._v(" "),e("ol",{attrs:{start:"2"}},[e("li",[e("code",[t._v("WorkInProgress Fiber Tree")]),t._v(" 在 "),e("code",[t._v("render阶段")]),t._v(" 完成构建后进入 "),e("code",[t._v("commit阶段")]),t._v(" 渲染到页面上。渲染完毕后， "),e("code",[t._v("WorkInProgress Fiber Tree")]),t._v(" 变为 "),e("code",[t._v("Current Fiber Tree")]),t._v(" 。\n"),e("img",{attrs:{src:a(541),alt:"update-fiber-tree-2"}})])]),t._v(" "),e("h2",{attrs:{id:"文件结构"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#文件结构"}},[t._v("#")]),t._v(" 文件结构")]),t._v(" "),e("p",[t._v("根据前文的介绍，我们已经知道 "),e("code",[t._v("React v16")]),t._v(" 的架构分为三层：")]),t._v(" "),e("ul",[e("li",[e("strong",[t._v("Scheduler")]),t._v("（调度器）—— 调度任务的优先级，高优任务优先进入 Reconciler")]),t._v(" "),e("li",[e("strong",[t._v("Reconciler")]),t._v("（协调器）—— 负责找出变化的组件")]),t._v(" "),e("li",[e("strong",[t._v("Renderer")]),t._v("（渲染器）—— 负责将变化的组件渲染到页面上")])]),t._v(" "),e("p",[t._v("那么架构是如何体现在源码的文件结构上呢，让我们一起看看吧。")]),t._v(" "),e("h3",{attrs:{id:"顶层目录"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#顶层目录"}},[t._v("#")]),t._v(" 顶层目录")]),t._v(" "),e("div",{staticClass:"language- line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[t._v("根目录\n  ├── fixtures        # 包含一些给贡献者准备的小型 React 测试项目\n  ├── packages        # 包含元数据（比如 package.json）和 React 仓库中所有 package 的源码（子目录 src）\n  ├── scripts         # 各种工具链的脚本，比如git、jest、eslint等\n")])]),t._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[t._v("1")]),e("br"),e("span",{staticClass:"line-number"},[t._v("2")]),e("br"),e("span",{staticClass:"line-number"},[t._v("3")]),e("br"),e("span",{staticClass:"line-number"},[t._v("4")]),e("br")])]),e("p",[t._v("实际上 "),e("code",[t._v("React")]),t._v(" 的项目采用 "),e("code",[t._v("Monorepo")]),t._v(" 结构来进行管理的，不同的功能分在不同的 "),e("code",[t._v("package")]),t._v(" 里。所以我们重点关注 "),e("code",[t._v("packages")]),t._v(" 文件夹。")]),t._v(" "),e("h3",{attrs:{id:"packages目录"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#packages目录"}},[t._v("#")]),t._v(" packages目录")]),t._v(" "),e("p",[t._v("目录下的文件夹非常多，我们来看下：")]),t._v(" "),e("h4",{attrs:{id:"react"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#react"}},[t._v("#")]),t._v(" react")]),t._v(" "),e("p",[e("code",[t._v("React")]),t._v(" 的核心，包含所有全局 "),e("code",[t._v("React API")]),t._v(" ，如：")]),t._v(" "),e("ul",[e("li",[e("code",[t._v("React.createElement")])]),t._v(" "),e("li",[e("code",[t._v("React.Component")])]),t._v(" "),e("li",[e("code",[t._v("React.Children")])])]),t._v(" "),e("p",[t._v("这些 "),e("code",[t._v("API")]),t._v(" 是全平台通用的，它不包含 "),e("code",[t._v("ReactDOM")]),t._v(" 、 "),e("code",[t._v("ReactNative")]),t._v(" 等平台特定的代码。在 NPM 上作为单独的一个"),e("a",{attrs:{href:"https://www.npmjs.com/package/react",target:"_blank",rel:"noopener noreferrer"}},[t._v("包"),e("OutboundLink")],1),t._v("发布。")]),t._v(" "),e("h4",{attrs:{id:"scheduler"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#scheduler"}},[t._v("#")]),t._v(" scheduler")]),t._v(" "),e("p",[e("code",[t._v("Scheduler")]),t._v(" （调度器）的实现。也是一个单独的"),e("a",{attrs:{href:"https://www.npmjs.com/package/scheduler",target:"_blank",rel:"noopener noreferrer"}},[t._v("NPM包"),e("OutboundLink")],1),t._v("。")]),t._v(" "),e("h4",{attrs:{id:"renderer相关文件夹"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#renderer相关文件夹"}},[t._v("#")]),t._v(" Renderer相关文件夹")]),t._v(" "),e("div",{staticClass:"language- line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[t._v("packages\n  ├──react-art\n  ├──react-dom                 # 注意这同时是DOM和SSR（服务端渲染）的入口\n  ├──react-native-renderer\n  ├──react-noop-renderer       # 用于debug fiber（后面会介绍fiber）\n  ├──react-test-renderer\n")])]),t._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[t._v("1")]),e("br"),e("span",{staticClass:"line-number"},[t._v("2")]),e("br"),e("span",{staticClass:"line-number"},[t._v("3")]),e("br"),e("span",{staticClass:"line-number"},[t._v("4")]),e("br"),e("span",{staticClass:"line-number"},[t._v("5")]),e("br"),e("span",{staticClass:"line-number"},[t._v("6")]),e("br")])]),e("h4",{attrs:{id:"react-reconciler文件夹"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#react-reconciler文件夹"}},[t._v("#")]),t._v(" "),e("a",{attrs:{href:"https://www.npmjs.com/package/react-reconciler",target:"_blank",rel:"noopener noreferrer"}},[t._v("react-reconciler"),e("OutboundLink")],1),t._v("文件夹")]),t._v(" "),e("p",[t._v("我们需要重点关注 "),e("code",[t._v("react-reconciler")]),t._v(" ，在接下来源码学习中 80%的代码量都来自这个包。")]),t._v(" "),e("p",[t._v("虽然他是一个实验性的包，内部的很多功能在正式版本中还未开放。但是他一边对接 "),e("code",[t._v("Scheduler")]),t._v(" ，一边对接不同平台的 "),e("code",[t._v("Renderer")]),t._v(" ，构成了整个 "),e("code",[t._v("React v16")]),t._v(" 的架构体系。")]),t._v(" "),e("blockquote",[e("p",[t._v("虽然这已经在 React 16 中启用了，但是 async 特性还没有默认开启。")])]),t._v(" "),e("p",[t._v("至于结构性的源码概览，可以看一下官网的"),e("a",{attrs:{href:"https://react.docschina.org/docs/codebase-overview.html",target:"_blank",rel:"noopener noreferrer"}},[t._v("源码概览"),e("OutboundLink")],1),t._v("。")]),t._v(" "),e("h2",{attrs:{id:"调试源码"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#调试源码"}},[t._v("#")]),t._v(" 调试源码")]),t._v(" "),e("p",[t._v("即使版本号相同（当前最新版为17.0.0），但是 "),e("code",[t._v("facebook/react")]),t._v(" 项目 "),e("code",[t._v("master")]),t._v(" 分支的代码和我们使用 "),e("code",[t._v("create-react-app")]),t._v(" 创建的项目 "),e("code",[t._v("node_modules")]),t._v(" 下的 "),e("code",[t._v("react")]),t._v(" 项目代码还是有些区别。")]),t._v(" "),e("p",[t._v("因为 "),e("code",[t._v("React")]),t._v(" 的新代码都是直接提交到 "),e("code",[t._v("master")]),t._v(" 分支，而 "),e("code",[t._v("create-react-app")]),t._v(" 内的 "),e("code",[t._v("react")]),t._v(" 使用的是稳定版的包。")]),t._v(" "),e("p",[t._v("为了始终使用最新版 "),e("code",[t._v("React")]),t._v(" 教学，我们调试源码遵循以下步骤：")]),t._v(" "),e("ul",[e("li",[t._v("从 "),e("code",[t._v("facebook/react")]),t._v(" 项目 "),e("code",[t._v("master")]),t._v(" 分支拉取最新源码")]),t._v(" "),e("li",[t._v("基于最新源码构建 "),e("code",[t._v("react")]),t._v(" 、 "),e("code",[t._v("scheduler")]),t._v(" 、 "),e("code",[t._v("react-dom")]),t._v(" 三个包")]),t._v(" "),e("li",[t._v("通过 "),e("code",[t._v("create-react-app")]),t._v(" 创建测试项目，并使用步骤2创建的包作为项目依赖的包")])]),t._v(" "),e("h3",{attrs:{id:"拉取源码"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#拉取源码"}},[t._v("#")]),t._v(" 拉取源码")]),t._v(" "),e("p",[t._v("拉取 "),e("code",[t._v("facebook/react")]),t._v(" 代码：")]),t._v(" "),e("div",{staticClass:"language-sh line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-sh"}},[e("code",[e("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# 拉取代码")]),t._v("\n"),e("span",{pre:!0,attrs:{class:"token function"}},[t._v("git")]),t._v(" clone https://github.com/facebook/react.git\n"),e("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# github cli")]),t._v("\ngh repo clone facebook/react\n")])]),t._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[t._v("1")]),e("br"),e("span",{staticClass:"line-number"},[t._v("2")]),e("br"),e("span",{staticClass:"line-number"},[t._v("3")]),e("br"),e("span",{staticClass:"line-number"},[t._v("4")]),e("br")])]),e("p",[t._v("安装依赖")]),t._v(" "),e("div",{staticClass:"language-sh line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-sh"}},[e("code",[e("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# 切入到react源码所在文件夹")]),t._v("\n"),e("span",{pre:!0,attrs:{class:"token builtin class-name"}},[t._v("cd")]),t._v(" react\n\n"),e("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# 安装依赖")]),t._v("\n"),e("span",{pre:!0,attrs:{class:"token function"}},[t._v("yarn")]),t._v("\n")])]),t._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[t._v("1")]),e("br"),e("span",{staticClass:"line-number"},[t._v("2")]),e("br"),e("span",{staticClass:"line-number"},[t._v("3")]),e("br"),e("span",{staticClass:"line-number"},[t._v("4")]),e("br"),e("span",{staticClass:"line-number"},[t._v("5")]),e("br")])]),e("p",[t._v("打包 "),e("code",[t._v("react")]),t._v(" 、 "),e("code",[t._v("scheduler")]),t._v(" 、 "),e("code",[t._v("react-dom")]),t._v(" 三个包为dev环境可以使用的cjs包。")]),t._v(" "),e("div",{staticClass:"language-sh line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-sh"}},[e("code",[e("span",{pre:!0,attrs:{class:"token function"}},[t._v("yarn")]),t._v(" build react/index,react-dom/index,scheduler --type"),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v("NODE\n")])]),t._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[t._v("1")]),e("br")])]),e("blockquote",[e("p",[t._v("对每一步更详细的介绍可以参考React文档"),e("a",{attrs:{href:"https://zh-hans.reactjs.org/docs/how-to-contribute.html#development-workflow",target:"_blank",rel:"noopener noreferrer"}},[t._v("源码贡献章节"),e("OutboundLink")],1)])]),t._v(" "),e("div",{staticClass:"custom-block warning"},[e("p",{staticClass:"custom-block-title"},[t._v("注意")]),t._v(" "),e("p",[t._v("17.0.0 版本执行命令：")]),t._v(" "),e("div",{staticClass:"language-sh line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-sh"}},[e("code",[e("span",{pre:!0,attrs:{class:"token function"}},[t._v("yarn")]),t._v(" build react,react-dom,scheduler --type"),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v("NODE\n")])]),t._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[t._v("1")]),e("br")])])]),t._v(" "),e("p",[t._v("现在源码目录 "),e("code",[t._v("build/node_modules")]),t._v(" 下会生成最新代码的包。我们为 "),e("code",[t._v("react")]),t._v(" 、 "),e("code",[t._v("react-dom")]),t._v(" 创建 "),e("code",[t._v("yarn link")]),t._v("。")]),t._v(" "),e("div",{staticClass:"language-sh line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-sh"}},[e("code",[e("span",{pre:!0,attrs:{class:"token builtin class-name"}},[t._v("cd")]),t._v(" build/node_modules/react\n"),e("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# 申明react指向")]),t._v("\n"),e("span",{pre:!0,attrs:{class:"token function"}},[t._v("yarn")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token function"}},[t._v("link")]),t._v("\n"),e("span",{pre:!0,attrs:{class:"token builtin class-name"}},[t._v("cd")]),t._v(" build/node_modules/react-dom\n"),e("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# 申明react-dom指向")]),t._v("\n"),e("span",{pre:!0,attrs:{class:"token function"}},[t._v("yarn")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token function"}},[t._v("link")]),t._v("\n")])]),t._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[t._v("1")]),e("br"),e("span",{staticClass:"line-number"},[t._v("2")]),e("br"),e("span",{staticClass:"line-number"},[t._v("3")]),e("br"),e("span",{staticClass:"line-number"},[t._v("4")]),e("br"),e("span",{staticClass:"line-number"},[t._v("5")]),e("br"),e("span",{staticClass:"line-number"},[t._v("6")]),e("br")])]),e("h3",{attrs:{id:"创建项目"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#创建项目"}},[t._v("#")]),t._v(" 创建项目")]),t._v(" "),e("p",[t._v("接下来我们通过create-react-app在其他地方创建新项目。")]),t._v(" "),e("div",{staticClass:"language-sh line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-sh"}},[e("code",[e("span",{pre:!0,attrs:{class:"token function"}},[t._v("yarn")]),t._v(" create react-app "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),t._v("YOUR-PROJECT-NAME"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),t._v("\n")])]),t._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[t._v("1")]),e("br")])]),e("p",[t._v("在新项目中，将react与react-dom2个包指向facebook/react下我们刚才生成的包。")]),t._v(" "),e("div",{staticClass:"language-sh line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-sh"}},[e("code",[e("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# 将项目内的react react-dom指向之前申明的包")]),t._v("\n"),e("span",{pre:!0,attrs:{class:"token function"}},[t._v("yarn")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token function"}},[t._v("link")]),t._v(" react react-dom\n")])]),t._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[t._v("1")]),e("br"),e("span",{staticClass:"line-number"},[t._v("2")]),e("br")])]),e("p",[t._v("这样在 "),e("code",[t._v("react/build/node_modules/react-dom/cjs/react-dom.development.js")]),t._v(" 中的任意修改都会在项目运行时显示出来。可以很方便我们对源码进行调试和分析。")])])}),[],!1,null,null,null);s.default=n.exports}}]);