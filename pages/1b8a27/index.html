<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Vite - 基于原生 ESM 的构建工具 | 三行代码</title>
    <meta name="generator" content="VuePress 1.8.2">
    <link rel="icon" href="/favicon.ico">
    <meta name="description" content="Web development, Frontend, JavaScript">
    <meta name="keywords" content="前端博客,个人技术博客,前端,前端开发,前端框架,web前端,前端面试题,技术文档,学习,面试,JavaScript,js,ES6,TypeScript,vue,python,css3,html5,Node,git,github,markdown">
    <meta name="theme-color" content="#11a8cd">
    <link rel="preload" href="/assets/css/0.styles.c149dbaa.css" as="style"><link rel="preload" href="/assets/js/app.c17531b4.js" as="script"><link rel="preload" href="/assets/js/2.3e7b8786.js" as="script"><link rel="preload" href="/assets/js/38.d458af07.js" as="script"><link rel="prefetch" href="/assets/js/10.2234e2c8.js"><link rel="prefetch" href="/assets/js/100.42ab15ac.js"><link rel="prefetch" href="/assets/js/101.e6fef504.js"><link rel="prefetch" href="/assets/js/11.14461477.js"><link rel="prefetch" href="/assets/js/12.157d8dc0.js"><link rel="prefetch" href="/assets/js/13.a7890c3d.js"><link rel="prefetch" href="/assets/js/14.d0894eb7.js"><link rel="prefetch" href="/assets/js/15.bb14362f.js"><link rel="prefetch" href="/assets/js/16.e34746ec.js"><link rel="prefetch" href="/assets/js/17.ca83e363.js"><link rel="prefetch" href="/assets/js/18.9a14520a.js"><link rel="prefetch" href="/assets/js/19.ceb87610.js"><link rel="prefetch" href="/assets/js/20.0d0d893e.js"><link rel="prefetch" href="/assets/js/21.a2cae791.js"><link rel="prefetch" href="/assets/js/22.9bd77fe5.js"><link rel="prefetch" href="/assets/js/23.3ca57ee7.js"><link rel="prefetch" href="/assets/js/24.5df7731a.js"><link rel="prefetch" href="/assets/js/25.becd8254.js"><link rel="prefetch" href="/assets/js/26.21837df4.js"><link rel="prefetch" href="/assets/js/27.12585d76.js"><link rel="prefetch" href="/assets/js/28.4aff2d40.js"><link rel="prefetch" href="/assets/js/29.606a725e.js"><link rel="prefetch" href="/assets/js/3.953185bb.js"><link rel="prefetch" href="/assets/js/30.281826a9.js"><link rel="prefetch" href="/assets/js/31.3e0344fb.js"><link rel="prefetch" href="/assets/js/32.1ef62439.js"><link rel="prefetch" href="/assets/js/33.7f023c0c.js"><link rel="prefetch" href="/assets/js/34.ad479baf.js"><link rel="prefetch" href="/assets/js/35.dc52b883.js"><link rel="prefetch" href="/assets/js/36.a8a20daf.js"><link rel="prefetch" href="/assets/js/37.c33aae67.js"><link rel="prefetch" href="/assets/js/39.668922f9.js"><link rel="prefetch" href="/assets/js/4.c115e727.js"><link rel="prefetch" href="/assets/js/40.dd259277.js"><link rel="prefetch" href="/assets/js/41.0685dabf.js"><link rel="prefetch" href="/assets/js/42.90bf1511.js"><link rel="prefetch" href="/assets/js/43.81710a1b.js"><link rel="prefetch" href="/assets/js/44.a20853a1.js"><link rel="prefetch" href="/assets/js/45.a0a76abf.js"><link rel="prefetch" href="/assets/js/46.95e74803.js"><link rel="prefetch" href="/assets/js/47.ba80bcea.js"><link rel="prefetch" href="/assets/js/48.ddc3aede.js"><link rel="prefetch" href="/assets/js/49.3040c348.js"><link rel="prefetch" href="/assets/js/5.7d5490f2.js"><link rel="prefetch" href="/assets/js/50.9e45cd68.js"><link rel="prefetch" href="/assets/js/51.3a5eacd8.js"><link rel="prefetch" href="/assets/js/52.2a50b570.js"><link rel="prefetch" href="/assets/js/53.8059a783.js"><link rel="prefetch" href="/assets/js/54.3e54252d.js"><link rel="prefetch" href="/assets/js/55.50b455ff.js"><link rel="prefetch" href="/assets/js/56.43d7e6b7.js"><link rel="prefetch" href="/assets/js/57.dc8bbc95.js"><link rel="prefetch" href="/assets/js/58.c0b76901.js"><link rel="prefetch" href="/assets/js/59.28ec02f3.js"><link rel="prefetch" href="/assets/js/6.8749434b.js"><link rel="prefetch" href="/assets/js/60.001ff532.js"><link rel="prefetch" href="/assets/js/61.b9d6b6db.js"><link rel="prefetch" href="/assets/js/62.81245a10.js"><link rel="prefetch" href="/assets/js/63.8332ae73.js"><link rel="prefetch" href="/assets/js/64.357b1d40.js"><link rel="prefetch" href="/assets/js/65.947a76a1.js"><link rel="prefetch" href="/assets/js/66.59c57da7.js"><link rel="prefetch" href="/assets/js/67.02d525a5.js"><link rel="prefetch" href="/assets/js/68.808b1fd2.js"><link rel="prefetch" href="/assets/js/69.703935c0.js"><link rel="prefetch" href="/assets/js/7.7aa8fb69.js"><link rel="prefetch" href="/assets/js/70.9c6a4dbf.js"><link rel="prefetch" href="/assets/js/71.955445a1.js"><link rel="prefetch" href="/assets/js/72.5ae810be.js"><link rel="prefetch" href="/assets/js/73.40b461f0.js"><link rel="prefetch" href="/assets/js/74.eb777c24.js"><link rel="prefetch" href="/assets/js/75.cf25358f.js"><link rel="prefetch" href="/assets/js/76.f2b37de5.js"><link rel="prefetch" href="/assets/js/77.5db6e6e5.js"><link rel="prefetch" href="/assets/js/78.2fcfdf72.js"><link rel="prefetch" href="/assets/js/79.501697d3.js"><link rel="prefetch" href="/assets/js/8.6aee0b06.js"><link rel="prefetch" href="/assets/js/80.1c75a4c9.js"><link rel="prefetch" href="/assets/js/81.eb9a1728.js"><link rel="prefetch" href="/assets/js/82.d18239f7.js"><link rel="prefetch" href="/assets/js/83.b4360fed.js"><link rel="prefetch" href="/assets/js/84.206370c0.js"><link rel="prefetch" href="/assets/js/85.7ef6ce1f.js"><link rel="prefetch" href="/assets/js/86.711072c9.js"><link rel="prefetch" href="/assets/js/87.8db4bcfa.js"><link rel="prefetch" href="/assets/js/88.d23ba184.js"><link rel="prefetch" href="/assets/js/89.9cd79b2e.js"><link rel="prefetch" href="/assets/js/9.9d5551f6.js"><link rel="prefetch" href="/assets/js/90.1000b730.js"><link rel="prefetch" href="/assets/js/91.0c90c597.js"><link rel="prefetch" href="/assets/js/92.e6b9a689.js"><link rel="prefetch" href="/assets/js/93.3ba18b6b.js"><link rel="prefetch" href="/assets/js/94.8eb468d2.js"><link rel="prefetch" href="/assets/js/95.7b5e4261.js"><link rel="prefetch" href="/assets/js/96.6d0c67f2.js"><link rel="prefetch" href="/assets/js/97.98f63f27.js"><link rel="prefetch" href="/assets/js/98.f7445085.js"><link rel="prefetch" href="/assets/js/99.f9a1abbd.js">
    <link rel="stylesheet" href="/assets/css/0.styles.c149dbaa.css">
  </head>
  <body class="theme-mode-light">
    <div id="app" data-server-rendered="true"><div class="theme-container sidebar-open have-rightmenu have-body-img"><header class="navbar blur"><div title="目录" class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><img src="https://cdn.jsdelivr.net/gh/artoriaschan/image-hosting@master/blog/20200105104632.15vzpyhnwvuk.png" alt="三行代码" class="logo"> <span class="site-name can-hide">三行代码</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/" class="nav-link">首页</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="前端" class="dropdown-title"><a href="/web/" class="link-title">前端</a> <span class="title" style="display:none;">前端</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><h4>前端文章</h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/pages/d533f9/" class="nav-link">基础知识</a></li><li class="dropdown-subitem"><a href="/pages/6d91ad/" class="nav-link">JavaScript</a></li><li class="dropdown-subitem"><a href="/pages/c5fd6c/" class="nav-link">Vue</a></li><li class="dropdown-subitem"><a href="/pages/8da03e/" class="nav-link">React</a></li><li class="dropdown-subitem"><a href="/pages/28de07/" class="nav-link">杂谈</a></li></ul></li><li class="dropdown-item"><h4>学习笔记</h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/note/vue2/" class="nav-link">Vue 2 源码解析</a></li><li class="dropdown-subitem"><a href="/note/vue3/" class="nav-link">Vue 3 源码解析</a></li><li class="dropdown-subitem"><a href="/note/react17/" class="nav-link">React 17 源码解析</a></li><li class="dropdown-subitem"><a href="/note/vite/" class="nav-link">Vite 源码解析</a></li></ul></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="页面" class="dropdown-title"><a href="/ui/" class="link-title">页面</a> <span class="title" style="display:none;">页面</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/pages/8309a5b876fc95e3/" class="nav-link">HTML</a></li><li class="dropdown-item"><!----> <a href="/pages/0a83b083bdf257cb/" class="nav-link">CSS</a></li><li class="dropdown-item"><!----> <a href="/pages/9f15c1a281d8bedb/" class="nav-link">Stylus</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="技术" class="dropdown-title"><a href="/technology/" class="link-title">技术</a> <span class="title" style="display:none;">技术</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/pages/9a7ee40fc232253e/" class="nav-link">技术文档</a></li><li class="dropdown-item"><!----> <a href="/pages/4c778760be26d8b3/" class="nav-link">GitHub技巧</a></li><li class="dropdown-item"><!----> <a href="/pages/117708e0af7f0bd9/" class="nav-link">Nodejs</a></li><li class="dropdown-item"><!----> <a href="/pages/33969f/" class="nav-link">Interview</a></li><li class="dropdown-item"><h4>Rust</h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/note/rust-notes/" class="nav-link">Rust 学习笔记</a></li></ul></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="转载" class="dropdown-title"><a href="/reship/" class="link-title">转载</a> <span class="title" style="display:none;">转载</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/pages/ed5303/" class="nav-link">前端精读</a></li></ul></div></div><div class="nav-item"><a href="/pages/beb6c0bd8a66cea6/" class="nav-link">收藏</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="索引" class="dropdown-title"><a href="/archives/" class="link-title">索引</a> <span class="title" style="display:none;">索引</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/categories/" class="nav-link">分类</a></li><li class="dropdown-item"><!----> <a href="/tags/" class="nav-link">标签</a></li><li class="dropdown-item"><!----> <a href="/archives/" class="nav-link">归档</a></li></ul></div></div> <a href="https://github.com/artoriaschan" target="_blank" rel="noopener noreferrer" class="repo-link">
    GitHub
    <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar" style="display:none;"><div class="blogger"><img src="https://cdn.jsdelivr.net/gh/artoriaschan/image-hosting@master/blog/WechatIMG1.6c8n1rhrpqg0.jpeg"> <div class="blogger-info"><h3>陈先生</h3> <span>☭ 让我们一起粉碎资本主义吧， 达瓦里氏！☭</span></div></div> <nav class="nav-links"><div class="nav-item"><a href="/" class="nav-link">首页</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="前端" class="dropdown-title"><a href="/web/" class="link-title">前端</a> <span class="title" style="display:none;">前端</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><h4>前端文章</h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/pages/d533f9/" class="nav-link">基础知识</a></li><li class="dropdown-subitem"><a href="/pages/6d91ad/" class="nav-link">JavaScript</a></li><li class="dropdown-subitem"><a href="/pages/c5fd6c/" class="nav-link">Vue</a></li><li class="dropdown-subitem"><a href="/pages/8da03e/" class="nav-link">React</a></li><li class="dropdown-subitem"><a href="/pages/28de07/" class="nav-link">杂谈</a></li></ul></li><li class="dropdown-item"><h4>学习笔记</h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/note/vue2/" class="nav-link">Vue 2 源码解析</a></li><li class="dropdown-subitem"><a href="/note/vue3/" class="nav-link">Vue 3 源码解析</a></li><li class="dropdown-subitem"><a href="/note/react17/" class="nav-link">React 17 源码解析</a></li><li class="dropdown-subitem"><a href="/note/vite/" class="nav-link">Vite 源码解析</a></li></ul></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="页面" class="dropdown-title"><a href="/ui/" class="link-title">页面</a> <span class="title" style="display:none;">页面</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/pages/8309a5b876fc95e3/" class="nav-link">HTML</a></li><li class="dropdown-item"><!----> <a href="/pages/0a83b083bdf257cb/" class="nav-link">CSS</a></li><li class="dropdown-item"><!----> <a href="/pages/9f15c1a281d8bedb/" class="nav-link">Stylus</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="技术" class="dropdown-title"><a href="/technology/" class="link-title">技术</a> <span class="title" style="display:none;">技术</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/pages/9a7ee40fc232253e/" class="nav-link">技术文档</a></li><li class="dropdown-item"><!----> <a href="/pages/4c778760be26d8b3/" class="nav-link">GitHub技巧</a></li><li class="dropdown-item"><!----> <a href="/pages/117708e0af7f0bd9/" class="nav-link">Nodejs</a></li><li class="dropdown-item"><!----> <a href="/pages/33969f/" class="nav-link">Interview</a></li><li class="dropdown-item"><h4>Rust</h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/note/rust-notes/" class="nav-link">Rust 学习笔记</a></li></ul></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="转载" class="dropdown-title"><a href="/reship/" class="link-title">转载</a> <span class="title" style="display:none;">转载</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/pages/ed5303/" class="nav-link">前端精读</a></li></ul></div></div><div class="nav-item"><a href="/pages/beb6c0bd8a66cea6/" class="nav-link">收藏</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="索引" class="dropdown-title"><a href="/archives/" class="link-title">索引</a> <span class="title" style="display:none;">索引</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/categories/" class="nav-link">分类</a></li><li class="dropdown-item"><!----> <a href="/tags/" class="nav-link">标签</a></li><li class="dropdown-item"><!----> <a href="/archives/" class="nav-link">归档</a></li></ul></div></div> <a href="https://github.com/artoriaschan" target="_blank" rel="noopener noreferrer" class="repo-link">
    GitHub
    <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></nav>  <ul class="sidebar-links"><li><section class="sidebar-group depth-0"><p class="sidebar-heading open"><span>Vite - 基于原生 ESM 的构建工具</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/pages/1b8a27/#简介" class="sidebar-link">简介</a><ul class="sidebar-sub-headers"></ul></li><li><a href="/pages/1b8a27/#什么是-vite" class="sidebar-link">什么是 Vite？</a><ul class="sidebar-sub-headers"></ul></li><li><a href="/pages/1b8a27/#原理" class="sidebar-link">原理</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/pages/1b8a27/#esm" class="sidebar-link">ESM</a></li><li class="sidebar-sub-header"><a href="/pages/1b8a27/#web-server" class="sidebar-link">web server</a></li><li class="sidebar-sub-header"><a href="/pages/1b8a27/#esbuild" class="sidebar-link">esbuild</a></li></ul></li><li><a href="/pages/1b8a27/#手动实现" class="sidebar-link">手动实现</a><ul class="sidebar-sub-headers"></ul></li><li><a href="/pages/1b8a27/#总结" class="sidebar-link">总结</a><ul class="sidebar-sub-headers"></ul></li></ul></section></li></ul> </aside> <div><main class="page"><div class="theme-vdoing-wrapper "><div class="articleInfo-wrap" data-v-1cd794fe><div class="articleInfo" data-v-1cd794fe><ul class="breadcrumbs" data-v-1cd794fe><li data-v-1cd794fe><a href="/" title="首页" class="iconfont icon-home router-link-active" data-v-1cd794fe></a></li> <li data-v-1cd794fe><a href="/note/vite/" title="Vite 源码解析-目录页" data-v-1cd794fe>Vite 源码解析</a></li> <!----> <!----></ul> <div class="info" data-v-1cd794fe><div title="作者" class="author iconfont icon-touxiang" data-v-1cd794fe><a href="https://github.com/artoriaschan" target="_blank" title="作者" class="beLink" data-v-1cd794fe>Artorias Chan</a></div> <div title="创建时间" class="date iconfont icon-riqi" data-v-1cd794fe><a href="javascript:;" data-v-1cd794fe>2020-12-22</a></div> <!----></div></div></div> <!----> <div class="content-wrapper"><div class="right-menu-wrapper"><div class="right-menu-margin"><div class="right-menu-content"></div></div></div> <h1><!---->
          Vite - 基于原生 ESM 的构建工具
        </h1> <!----> <div class="theme-vdoing-content content__default"><h2 id="简介"><a href="#简介" class="header-anchor">#</a> 简介</h2> <p>关于 <code>Vite</code> 工具的了解还是从尤大的一条 <code>twitter</code> ，那条 <code>twitter</code> 表示再也回不去 <code>webpack</code> 了。
<img src="/assets/img/twitter.b3da3b68.png" alt="twitter"></p> <p>那么我们就来详细了解下 <code>Vite</code> 及其实现原理。本文的所有分析都基于 <code>1.0.0-rc.13</code> 版本。</p> <h2 id="什么是-vite"><a href="#什么是-vite" class="header-anchor">#</a> 什么是 Vite？</h2> <div class="custom-block tip"><p class="custom-block-title">提示</p> <p>github：<a href="github.com/vitejs/vite">github.com/vitejs/vite</a></p></div> <p>根据项目的 <code>README.md</code> 中：</p> <blockquote><p>Vite is an opinionated web dev build tool that serves your code via native ES Module imports during dev and bundles it with Rollup for production.</p></blockquote> <p>也就是说 <code>Vite</code> 是一个由原生 <code>ESM</code> 驱动的 <code>Web</code> 开发构建工具。在开发环境下基于浏览器原生 <code>ES imports</code> 开发，在生产环境下基于 <code>Rollup</code> 打包。</p> <p>并且我们得知它主要具有以下特点：</p> <ul><li>快速的 <code>冷启动</code></li> <li>即时的 <code>模块热更新</code></li> <li>真正的 <code>按需编译</code></li></ul> <p>我们通过如下命令可以快速创建一个使用 <code>Vite</code> 构建的 <code>Vue 3.0</code> 项目。</p> <div class="custom-block warning"><p class="custom-block-title">注意</p> <p><code>Vite</code> 目前只能和 <code>Vue 3.0</code> 一起使用。</p></div> <div class="language-sh line-numbers-mode"><pre class="language-sh"><code>$ <span class="token function">yarn</span> create vite-app <span class="token operator">&lt;</span>project-name<span class="token operator">&gt;</span>
$ <span class="token builtin class-name">cd</span> <span class="token operator">&lt;</span>project-name<span class="token operator">&gt;</span>
$ <span class="token function">yarn</span>
$ <span class="token function">yarn</span> dev
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><p>创建完项目后我们看一下 <code>mian.js</code> 和 <code>index.html</code> 文件。</p> <div class="language-html line-numbers-mode"><div class="highlight-lines"><br><br><br><br><br><br><br><br><br><br><div class="highlighted"> </div><br><br><br></div><pre class="language-html"><code><span class="token doctype"><span class="token punctuation">&lt;!</span><span class="token doctype-tag">DOCTYPE</span> <span class="token name">html</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>html</span> <span class="token attr-name">lang</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>en<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>head</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>meta</span> <span class="token attr-name">charset</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>UTF-8<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>link</span> <span class="token attr-name">rel</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>icon<span class="token punctuation">&quot;</span></span> <span class="token attr-name">href</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>/favicon.ico<span class="token punctuation">&quot;</span></span> <span class="token punctuation">/&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>meta</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>viewport<span class="token punctuation">&quot;</span></span> <span class="token attr-name">content</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>width=device-width, initial-scale=1.0<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>title</span><span class="token punctuation">&gt;</span></span>Vite App<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>title</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>head</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>body</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>app<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>module<span class="token punctuation">&quot;</span></span> <span class="token attr-name">src</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>/src/main.js<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span><span class="token script"></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>body</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>html</span><span class="token punctuation">&gt;</span></span>
</code></pre><div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br></div></div><div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">import</span> <span class="token punctuation">{</span> createApp <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'vue'</span>
<span class="token keyword">import</span> App <span class="token keyword">from</span> <span class="token string">'./App.vue'</span>
<span class="token keyword">import</span> <span class="token string">'./index.css'</span>

<span class="token function">createApp</span><span class="token punctuation">(</span>App<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">mount</span><span class="token punctuation">(</span><span class="token string">'#app'</span><span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><p>我们发现在 <code>html模板</code> 上的高亮部分，对 <code>script</code> 引入使用了 <code>type=&quot;module&quot;</code> 属性，那么我们具体的看先这个属性的作用。</p> <h2 id="原理"><a href="#原理" class="header-anchor">#</a> 原理</h2> <h3 id="esm"><a href="#esm" class="header-anchor">#</a> ESM</h3> <p><code>script module</code> 是 <code>ES Module</code> 在浏览器端的实现，目前主流的浏览器都已经支持。</p> <p>其最大的特点是在浏览器端使用 <code>export</code> 、 <code>import</code> 的方式导入和导出模块，在 <code>script</code> 标签里设置 <code>type=&quot;module&quot;</code> 。</p> <div class="language-html line-numbers-mode"><pre class="language-html"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>module<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span><span class="token script"><span class="token language-javascript">
  <span class="token keyword">import</span> <span class="token punctuation">{</span> createApp <span class="token punctuation">}</span> <span class="token keyword">from</span> '<span class="token punctuation">.</span><span class="token operator">/</span>main<span class="token punctuation">.</span>js‘<span class="token punctuation">;</span>
  <span class="token function">createApp</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">&gt;</span></span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><p>浏览器会识别添加 <code>type=&quot;module&quot;</code> 的 <code>&lt;script&gt;</code> 元素，浏览器会把这段 <code>内联 script</code> 或者 <code>外链 script</code> 认为是 <code>ECMAScript 模块</code>，浏览器将对其内部的 <code>import</code> 引用发起 <code>HTTP 请求</code> 获取模块内容。</p> <p>在 <code>main.js</code> 里，我们用 <code>named export</code> 导出 <code>createApp</code> 函数，在上面的 <code>script</code> 中能获取到该函数：</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token comment">// main.js</span>
<span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">createApp</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'create app!'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><h3 id="web-server"><a href="#web-server" class="header-anchor">#</a> web server</h3> <p>经过上面对 script module 的描述，我们可以有个大致的了解。我们可以在本地起一个服务，用来为浏览器请求 script module 提供代理即可。</p> <p>但是这里也有几个问题需要处理一下：</p> <ul><li>import 路径为 <code>/</code> 、 <code>./</code> 和 <code>../</code> 。</li> <li>浏览器不支持 .vue 后缀的单文件组件</li></ul> <h4 id="modules-支持"><a href="#modules-支持" class="header-anchor">#</a> /@modules/ 支持</h4> <p>针对第一个问题来说，浏览器中的 <code>ESM</code> 是获取不到导入的模块内容的。</p> <p>我们平常引用 <code>node_modules</code> 中的模块时，直接使用 <code>import xxx from 'xxx'</code> 语句。</p> <p>但是这种语句在浏览器端是无法解析，进而保存的。因为 <code>script module</code> 的 <code>import 路径</code> 要求为 <code>/</code> 、 <code>./</code> 和 <code>../</code> 。所以如果不经过处理，浏览器是无法获取到正常的资源。</p> <p>所以在 <code>Vite</code> 中，为了解决 <code>import xxx from 'xxx'</code> 报错的问题， <code>Vite</code> 对这种资源路径做了一个统一的处理，加一个 <code>/@modules/</code> 前缀。</p> <p>我们在 <code>src/node/server/serverPluginModuleRewrite.ts</code> 源码这个 <code>koa 中间件</code> 里可以看到 <code>Vite</code> 对 <code>import</code> 都做了一层处理，其过程如下：</p> <ul><li>判断请求资源是否是<code>js</code>，若是，获取 <code>ctx.body</code></li> <li>将 <code>ctx.body</code> 从 <code>stream</code> 转成 <code>string</code></li> <li>调用 <code>rewriteImports</code> 函数进行重写 <code>import</code> ，并将返回结果重新赋值给 <code>ctx.body</code> 。</li> <li>做重写的缓存处理： <code>rewriteCache</code> 。</li></ul> <p>具体的代码如下：</p> <div class="language-ts line-numbers-mode"><div class="highlight-lines"><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><div class="highlighted"> </div><br><br><br><br><br><br><br><br><br><br><div class="highlighted"> </div><div class="highlighted"> </div><div class="highlighted"> </div><div class="highlighted"> </div><div class="highlighted"> </div><div class="highlighted"> </div><div class="highlighted"> </div><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br></div><pre class="language-ts"><code><span class="token comment">// src/node/server/serverPluginModuleRewrite.ts</span>

<span class="token keyword">export</span> <span class="token keyword">const</span> <span class="token keyword">module</span>RewritePlugin<span class="token operator">:</span> <span class="token function-variable function">ServerPlugin</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">{</span>
  root<span class="token punctuation">,</span>
  app<span class="token punctuation">,</span>
  watcher<span class="token punctuation">,</span>
  resolver
<span class="token punctuation">}</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  app<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span><span class="token keyword">async</span> <span class="token punctuation">(</span>ctx<span class="token punctuation">,</span> next<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">await</span> <span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>ctx<span class="token punctuation">.</span>status <span class="token operator">===</span> <span class="token number">304</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">return</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">const</span> publicPath <span class="token operator">=</span> ctx<span class="token punctuation">.</span>path
    <span class="token keyword">if</span> <span class="token punctuation">(</span>
      ctx<span class="token punctuation">.</span>body <span class="token operator">&amp;&amp;</span>
      ctx<span class="token punctuation">.</span>response<span class="token punctuation">.</span><span class="token keyword">is</span><span class="token punctuation">(</span><span class="token string">'js'</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span>
      <span class="token operator">!</span><span class="token function">isCSSRequest</span><span class="token punctuation">(</span>ctx<span class="token punctuation">.</span>path<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span>
      <span class="token operator">!</span>ctx<span class="token punctuation">.</span>url<span class="token punctuation">.</span><span class="token function">endsWith</span><span class="token punctuation">(</span><span class="token string">'.map'</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span>
      <span class="token operator">!</span>resolver<span class="token punctuation">.</span><span class="token function">isPublicRequest</span><span class="token punctuation">(</span>ctx<span class="token punctuation">.</span>path<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span>
      <span class="token comment">// skip internal client</span>
      publicPath <span class="token operator">!==</span> clientPublicPath <span class="token operator">&amp;&amp;</span>
      <span class="token comment">// need to rewrite for &lt;script&gt;\&lt;template&gt; part in vue files</span>
      <span class="token operator">!</span><span class="token punctuation">(</span><span class="token punctuation">(</span>ctx<span class="token punctuation">.</span>path<span class="token punctuation">.</span><span class="token function">endsWith</span><span class="token punctuation">(</span><span class="token string">'.vue'</span><span class="token punctuation">)</span> <span class="token operator">||</span> ctx<span class="token punctuation">.</span>vue<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> ctx<span class="token punctuation">.</span>query<span class="token punctuation">.</span>type <span class="token operator">===</span> <span class="token string">'style'</span><span class="token punctuation">)</span>
    <span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">const</span> content <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token function">readBody</span><span class="token punctuation">(</span>ctx<span class="token punctuation">.</span>body<span class="token punctuation">)</span>
      <span class="token keyword">const</span> cacheKey <span class="token operator">=</span> publicPath <span class="token operator">+</span> content
      <span class="token keyword">const</span> isHmrRequest <span class="token operator">=</span> <span class="token operator">!</span><span class="token operator">!</span>ctx<span class="token punctuation">.</span>query<span class="token punctuation">.</span>t
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>isHmrRequest <span class="token operator">&amp;&amp;</span> rewriteCache<span class="token punctuation">.</span><span class="token function">has</span><span class="token punctuation">(</span>cacheKey<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">debug</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">(cached) </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>ctx<span class="token punctuation">.</span>url<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span>
        ctx<span class="token punctuation">.</span>body <span class="token operator">=</span> rewriteCache<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>cacheKey<span class="token punctuation">)</span>
      <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        <span class="token keyword">await</span> initLexers
        <span class="token keyword">const</span> importer <span class="token operator">=</span> <span class="token function">removeUnRelatedHmrQuery</span><span class="token punctuation">(</span>
          resolver<span class="token punctuation">.</span><span class="token function">normalizePublicPath</span><span class="token punctuation">(</span>ctx<span class="token punctuation">.</span>url<span class="token punctuation">)</span>
        <span class="token punctuation">)</span>
        ctx<span class="token punctuation">.</span>body <span class="token operator">=</span> <span class="token function">rewriteImports</span><span class="token punctuation">(</span>
          root<span class="token punctuation">,</span>
          content<span class="token operator">!</span><span class="token punctuation">,</span>
          importer<span class="token punctuation">,</span>
          resolver<span class="token punctuation">,</span>
          ctx<span class="token punctuation">.</span>query<span class="token punctuation">.</span>t
        <span class="token punctuation">)</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>isHmrRequest<span class="token punctuation">)</span> <span class="token punctuation">{</span>
          rewriteCache<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>cacheKey<span class="token punctuation">,</span> ctx<span class="token punctuation">.</span>body<span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
      <span class="token function">debug</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">(skipped) </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>ctx<span class="token punctuation">.</span>url<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>

  watcher<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">'change'</span><span class="token punctuation">,</span> <span class="token keyword">async</span> <span class="token punctuation">(</span>filePath<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token comment">// 检测文件变化删除缓存。</span>
    <span class="token comment">// ...</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br></div></div><p>至于实质对 import 路径 进行转换的，则是通过 resolveImport 函数来进行的，其中也借助了 resolver 模块的方法。</p> <div class="language-ts line-numbers-mode"><pre class="language-ts"><code><span class="token keyword">export</span> <span class="token keyword">const</span> resolveImport <span class="token operator">=</span> <span class="token punctuation">(</span>
  root<span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">,</span>
  importer<span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">,</span>
  id<span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">,</span>
  resolver<span class="token operator">:</span> InternalResolver<span class="token punctuation">,</span>
  timestamp<span class="token operator">?</span><span class="token operator">:</span> <span class="token builtin">string</span>
<span class="token punctuation">)</span><span class="token operator">:</span> <span class="token builtin">string</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  id <span class="token operator">=</span> resolver<span class="token punctuation">.</span><span class="token function">alias</span><span class="token punctuation">(</span>id<span class="token punctuation">)</span> <span class="token operator">||</span> id

  <span class="token keyword">if</span> <span class="token punctuation">(</span>bareImportRE<span class="token punctuation">.</span><span class="token function">test</span><span class="token punctuation">(</span>id<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 直接将裸模块名称解析为其入口路径，以便从其中的相对导入（包括源映射url）可以正常工作</span>
    id <span class="token operator">=</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">/@modules/</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span><span class="token function">resolveBareModuleRequest</span><span class="token punctuation">(</span>root<span class="token punctuation">,</span> id<span class="token punctuation">,</span> importer<span class="token punctuation">,</span> resolver<span class="token punctuation">)</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
    <span class="token comment">// 1. 相对路径修改为绝对路径</span>
    <span class="token comment">//    ./foo -&gt; /some/path/foo</span>
    <span class="token keyword">let</span> <span class="token punctuation">{</span> pathname<span class="token punctuation">,</span> query <span class="token punctuation">}</span> <span class="token operator">=</span> resolver<span class="token punctuation">.</span><span class="token function">resolveRelativeRequest</span><span class="token punctuation">(</span>importer<span class="token punctuation">,</span> id<span class="token punctuation">)</span>

    <span class="token comment">// 2. 解决目录索引和扩展名</span>
    pathname <span class="token operator">=</span> resolver<span class="token punctuation">.</span><span class="token function">normalizePublicPath</span><span class="token punctuation">(</span>pathname<span class="token punctuation">)</span>

    <span class="token comment">// 3. 标记没有来源的导入</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>query <span class="token operator">&amp;&amp;</span> path<span class="token punctuation">.</span><span class="token function">extname</span><span class="token punctuation">(</span>pathname<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>jsSrcRE<span class="token punctuation">.</span><span class="token function">test</span><span class="token punctuation">(</span>pathname<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      query <span class="token operator">+=</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">?import</span><span class="token template-punctuation string">`</span></span>
    <span class="token punctuation">}</span>

    id <span class="token operator">=</span> pathname <span class="token operator">+</span> query
  <span class="token punctuation">}</span>

  <span class="token comment">// 4. 通过附加时间戳来强制重新获取脏导入，用来做模块热更新</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>timestamp<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> dirtyFiles <span class="token operator">=</span> hmrDirtyFilesMap<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>timestamp<span class="token punctuation">)</span>
    <span class="token keyword">const</span> cleanId <span class="token operator">=</span> <span class="token function">cleanUrl</span><span class="token punctuation">(</span>id<span class="token punctuation">)</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>dirtyFiles <span class="token operator">&amp;&amp;</span> dirtyFiles<span class="token punctuation">.</span><span class="token function">has</span><span class="token punctuation">(</span>cleanId<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// 这是一个标记为脏文件（在已更改文件的导入链中）</span>
      id <span class="token operator">+=</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>id<span class="token punctuation">.</span><span class="token function">includes</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">?</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span> <span class="token operator">?</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">&amp;</span><span class="token template-punctuation string">`</span></span> <span class="token operator">:</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">?</span><span class="token template-punctuation string">`</span></span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">t=</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>timestamp<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>latestVersionsMap<span class="token punctuation">.</span><span class="token function">has</span><span class="token punctuation">(</span>cleanId<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// 2. 此文件以前是热更新的，并且具有更新的版本</span>
      id <span class="token operator">+=</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>id<span class="token punctuation">.</span><span class="token function">includes</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">?</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span> <span class="token operator">?</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">&amp;</span><span class="token template-punctuation string">`</span></span> <span class="token operator">:</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">?</span><span class="token template-punctuation string">`</span></span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">t=</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>latestVersionsMap<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>cleanId<span class="token punctuation">)</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">return</span> id
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br></div></div><h4 id="文件编译"><a href="#文件编译" class="header-anchor">#</a> 文件编译</h4> <p>上面我们提到的是对普通 <code>js module</code> 的处理，那对于其他文件，比如 <code>vue</code> 、 <code>css</code> 、 <code>ts</code> 等是如何处理的呢？</p> <p>我们先看一下 vue 文件的处理。</p> <p>通过工程下的 HelloWorld.vue 和开发环境下的实际加载的 HelloWorld.vue 对比，发现内容发生了改变</p> <div class="language-vue line-numbers-mode"><pre class="language-vue"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>template</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>h1</span><span class="token punctuation">&gt;</span></span>{{ msg }}<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>h1</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>button</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>c-button<span class="token punctuation">&quot;</span></span> <span class="token attr-name">@click</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>count++<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>count is: {{ count }}<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>button</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>p</span><span class="token punctuation">&gt;</span></span>Edit <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>code</span><span class="token punctuation">&gt;</span></span>components/HelloWorld.vue<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>code</span><span class="token punctuation">&gt;</span></span> to test hot module replacement.<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>p</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>template</span><span class="token punctuation">&gt;</span></span>

<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span><span class="token punctuation">&gt;</span></span><span class="token script"><span class="token language-javascript">
<span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token punctuation">{</span>
  name<span class="token operator">:</span> <span class="token string">'HelloWorld'</span><span class="token punctuation">,</span>
  props<span class="token operator">:</span> <span class="token punctuation">{</span>
    msg<span class="token operator">:</span> String
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token function">data</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token punctuation">{</span>
      count<span class="token operator">:</span> <span class="token number">0</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>style</span><span class="token punctuation">&gt;</span></span><span class="token style"><span class="token language-css">
<span class="token selector">.c-button</span> <span class="token punctuation">{</span>
  <span class="token property">width</span><span class="token punctuation">:</span> 200px<span class="token punctuation">;</span>
  <span class="token property">height</span><span class="token punctuation">:</span> 50px<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>style</span><span class="token punctuation">&gt;</span></span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br></div></div><div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">const</span> __script <span class="token operator">=</span> <span class="token punctuation">{</span>
    name<span class="token operator">:</span> <span class="token string">'HelloWorld'</span><span class="token punctuation">,</span>
    props<span class="token operator">:</span> <span class="token punctuation">{</span>
        msg<span class="token operator">:</span> String
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token function">data</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token punctuation">{</span>
            count<span class="token operator">:</span> <span class="token number">0</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span class="token keyword">import</span> <span class="token string">&quot;/src/components/HelloWorld.vue?type=style&amp;index=0&quot;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span>render <span class="token keyword">as</span> __render<span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&quot;/src/components/HelloWorld.vue?type=template&quot;</span>
__script<span class="token punctuation">.</span>render <span class="token operator">=</span> __render
__script<span class="token punctuation">.</span>__hmrId <span class="token operator">=</span> <span class="token string">&quot;/src/components/HelloWorld.vue&quot;</span>
<span class="token keyword">typeof</span> __VUE_HMR_RUNTIME__ <span class="token operator">!==</span> <span class="token string">'undefined'</span> <span class="token operator">&amp;&amp;</span> __VUE_HMR_RUNTIME__<span class="token punctuation">.</span><span class="token function">createRecord</span><span class="token punctuation">(</span>__script<span class="token punctuation">.</span>__hmrId<span class="token punctuation">,</span> __script<span class="token punctuation">)</span>
__script<span class="token punctuation">.</span>__file <span class="token operator">=</span> <span class="token string">&quot;/Users/artorias/Desktop/work/projects/personal-project/my-vite/src/components/HelloWorld.vue&quot;</span>
<span class="token keyword">export</span> <span class="token keyword">default</span> __script
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br></div></div><p>这样就把原本一个 .vue 的文件拆成了三个请求（分别对应 script、style 和template）。</p> <p>浏览器会先收到包含 script 逻辑的 HelloWorld.vue 的响应，然后解析到 template 和 style 的路径后，会再次发起 HTTP 请求来请求对应的资源。</p> <p>此时 Vite 对其拦截并再次处理后返回相应的内容。</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token comment">// /src/components/HelloWorld.vue?type=style&amp;index=0</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> updateStyle <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&quot;/vite/client&quot;</span>
<span class="token keyword">const</span> css <span class="token operator">=</span> <span class="token string">&quot;\n.c-button {\n  width: 200px;\n  height: 50px;\n}\n&quot;</span>
<span class="token function">updateStyle</span><span class="token punctuation">(</span><span class="token string">&quot;62a9ebed-0&quot;</span><span class="token punctuation">,</span> css<span class="token punctuation">)</span>
<span class="token keyword">export</span> <span class="token keyword">default</span> css

<span class="token comment">// /src/components/HelloWorld.vue?type=template</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span>
  toDisplayString <span class="token keyword">as</span> _toDisplayString<span class="token punctuation">,</span> 
  createVNode <span class="token keyword">as</span> _createVNode<span class="token punctuation">,</span> 
  createTextVNode <span class="token keyword">as</span> _createTextVNode<span class="token punctuation">,</span> 
  Fragment <span class="token keyword">as</span> _Fragment<span class="token punctuation">,</span> 
  openBlock <span class="token keyword">as</span> _openBlock<span class="token punctuation">,</span> 
  createBlock <span class="token keyword">as</span> _createBlock
<span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&quot;/@modules/vue.js&quot;</span>

<span class="token keyword">const</span> _hoisted_1 <span class="token operator">=</span> <span class="token comment">/*#__PURE__*/</span>
<span class="token function">_createVNode</span><span class="token punctuation">(</span><span class="token string">&quot;p&quot;</span><span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token comment">/*#__PURE__*/</span>
    <span class="token function">_createTextVNode</span><span class="token punctuation">(</span><span class="token string">&quot;Edit &quot;</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token comment">/*#__PURE__*/</span>
    <span class="token function">_createVNode</span><span class="token punctuation">(</span><span class="token string">&quot;code&quot;</span><span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">,</span> <span class="token string">&quot;components/HelloWorld.vue&quot;</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token comment">/*#__PURE__*/</span>
    <span class="token function">_createTextVNode</span><span class="token punctuation">(</span><span class="token string">&quot; to test hot module replacement.&quot;</span><span class="token punctuation">)</span>
  <span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">1</span> <span class="token comment">/* HOISTED */</span>
<span class="token punctuation">)</span>

<span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">render</span><span class="token punctuation">(</span><span class="token parameter">_ctx<span class="token punctuation">,</span> _cache<span class="token punctuation">,</span> $props<span class="token punctuation">,</span> $setup<span class="token punctuation">,</span> $data<span class="token punctuation">,</span> $options</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token punctuation">(</span><span class="token function">_openBlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token function">_createBlock</span><span class="token punctuation">(</span>_Fragment<span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token function">_createVNode</span><span class="token punctuation">(</span><span class="token string">&quot;h1&quot;</span><span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">,</span> <span class="token function">_toDisplayString</span><span class="token punctuation">(</span>$props<span class="token punctuation">.</span>msg<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">1</span> <span class="token comment">/* TEXT */</span>
    <span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">_createVNode</span><span class="token punctuation">(</span><span class="token string">&quot;button&quot;</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>
        <span class="token keyword">class</span><span class="token operator">:</span> <span class="token string">&quot;c-button&quot;</span><span class="token punctuation">,</span>
        onClick<span class="token operator">:</span> _cache<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">||</span> <span class="token punctuation">(</span>_cache<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token parameter">$event</span><span class="token operator">=&gt;</span><span class="token punctuation">(</span>$data<span class="token punctuation">.</span>count<span class="token operator">++</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token string">&quot;count is: &quot;</span> <span class="token operator">+</span> <span class="token function">_toDisplayString</span><span class="token punctuation">(</span>$data<span class="token punctuation">.</span>count<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">1</span> <span class="token comment">/* TEXT */</span>
    <span class="token punctuation">)</span><span class="token punctuation">,</span> _hoisted_1<span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token number">64</span> <span class="token comment">/* STABLE_FRAGMENT */</span>
    <span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br></div></div><p>实际上 Vite 是拦截了对模块的请求并执行了一个实时编译。和处理 import 路径类似，都是提供了一个 <code>Koa 中间件</code> 来负责这个问题。</p> <div class="language-ts line-numbers-mode"><div class="highlight-lines"><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><div class="highlighted"> </div><div class="highlighted"> </div><div class="highlighted"> </div><div class="highlighted"> </div><div class="highlighted"> </div><div class="highlighted"> </div><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><div class="highlighted"> </div><div class="highlighted"> </div><div class="highlighted"> </div><div class="highlighted"> </div><div class="highlighted"> </div><div class="highlighted"> </div><div class="highlighted"> </div><div class="highlighted"> </div><div class="highlighted"> </div><div class="highlighted"> </div><br><br><br><br><br><br><br><br><br><br><br><br><div class="highlighted"> </div><div class="highlighted"> </div><div class="highlighted"> </div><div class="highlighted"> </div><div class="highlighted"> </div><div class="highlighted"> </div><div class="highlighted"> </div><div class="highlighted"> </div><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br></div><pre class="language-ts"><code><span class="token comment">// src/node/server/serverPluginVue.ts</span>

<span class="token keyword">export</span> <span class="token keyword">const</span> vuePlugin<span class="token operator">:</span> <span class="token function-variable function">ServerPlugin</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">{</span>
  root<span class="token punctuation">,</span>
  app<span class="token punctuation">,</span>
  resolver<span class="token punctuation">,</span>
  watcher<span class="token punctuation">,</span>
  config
<span class="token punctuation">}</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> <span class="token function-variable function">etagCacheCheck</span> <span class="token operator">=</span> <span class="token punctuation">(</span>ctx<span class="token operator">:</span> Context<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    ctx<span class="token punctuation">.</span>etag <span class="token operator">=</span> <span class="token function">getEtag</span><span class="token punctuation">(</span>ctx<span class="token punctuation">.</span>body<span class="token punctuation">)</span>
    ctx<span class="token punctuation">.</span>status <span class="token operator">=</span>
      seenUrls<span class="token punctuation">.</span><span class="token function">has</span><span class="token punctuation">(</span>ctx<span class="token punctuation">.</span>url<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> ctx<span class="token punctuation">.</span>etag <span class="token operator">===</span> ctx<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">'If-None-Match'</span><span class="token punctuation">)</span> <span class="token operator">?</span> <span class="token number">304</span> <span class="token operator">:</span> <span class="token number">200</span>
    seenUrls<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>ctx<span class="token punctuation">.</span>url<span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
  <span class="token comment">// 挂载中间件</span>
  app<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span><span class="token keyword">async</span> <span class="token punctuation">(</span>ctx<span class="token punctuation">,</span> next<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>ctx<span class="token punctuation">.</span>path<span class="token punctuation">.</span><span class="token function">endsWith</span><span class="token punctuation">(</span><span class="token string">'.vue'</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>ctx<span class="token punctuation">.</span>vue<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">return</span> <span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">const</span> query <span class="token operator">=</span> ctx<span class="token punctuation">.</span>query
    <span class="token keyword">const</span> publicPath <span class="token operator">=</span> ctx<span class="token punctuation">.</span>path
    <span class="token keyword">let</span> filePath <span class="token operator">=</span> resolver<span class="token punctuation">.</span><span class="token function">requestToFile</span><span class="token punctuation">(</span>publicPath<span class="token punctuation">)</span>

    <span class="token keyword">const</span> descriptor <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token function">parseSFC</span><span class="token punctuation">(</span>root<span class="token punctuation">,</span> filePath<span class="token punctuation">,</span> ctx<span class="token punctuation">.</span>body<span class="token punctuation">)</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>descriptor<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">return</span> <span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
    <span class="token comment">// 没有携带 type，则默认为 js</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>query<span class="token punctuation">.</span>type<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token function">watchFileIfOutOfRoot</span><span class="token punctuation">(</span>watcher<span class="token punctuation">,</span> root<span class="token punctuation">,</span> filePath<span class="token punctuation">)</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>descriptor<span class="token punctuation">.</span>script <span class="token operator">&amp;&amp;</span> descriptor<span class="token punctuation">.</span>script<span class="token punctuation">.</span>src<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        filePath <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token function">resolveSrcImport</span><span class="token punctuation">(</span>
          root<span class="token punctuation">,</span>
          descriptor<span class="token punctuation">.</span>script<span class="token punctuation">,</span>
          ctx<span class="token punctuation">,</span>
          resolver
        <span class="token punctuation">)</span>
      <span class="token punctuation">}</span>
      ctx<span class="token punctuation">.</span>type <span class="token operator">=</span> <span class="token string">'js'</span>
      <span class="token keyword">const</span> <span class="token punctuation">{</span> code<span class="token punctuation">,</span> map <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token function">compileSFCMain</span><span class="token punctuation">(</span>
        descriptor<span class="token punctuation">,</span>
        filePath<span class="token punctuation">,</span>
        publicPath<span class="token punctuation">,</span>
        root
      <span class="token punctuation">)</span>
      ctx<span class="token punctuation">.</span>body <span class="token operator">=</span> code
      ctx<span class="token punctuation">.</span>map <span class="token operator">=</span> map
      <span class="token keyword">return</span> <span class="token function">etagCacheCheck</span><span class="token punctuation">(</span>ctx<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
    <span class="token comment">// 处理 type=template 的请求</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>query<span class="token punctuation">.</span>type <span class="token operator">===</span> <span class="token string">'template'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">const</span> templateBlock <span class="token operator">=</span> descriptor<span class="token punctuation">.</span>template<span class="token operator">!</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>templateBlock<span class="token punctuation">.</span>src<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        filePath <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token function">resolveSrcImport</span><span class="token punctuation">(</span>root<span class="token punctuation">,</span> templateBlock<span class="token punctuation">,</span> ctx<span class="token punctuation">,</span> resolver<span class="token punctuation">)</span>
      <span class="token punctuation">}</span>
      ctx<span class="token punctuation">.</span>type <span class="token operator">=</span> <span class="token string">'js'</span>
      <span class="token keyword">const</span> cached <span class="token operator">=</span> vueCache<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>filePath<span class="token punctuation">)</span>
      <span class="token keyword">const</span> bindingMetadata <span class="token operator">=</span> cached <span class="token operator">&amp;&amp;</span> cached<span class="token punctuation">.</span>script <span class="token operator">&amp;&amp;</span> cached<span class="token punctuation">.</span>script<span class="token punctuation">.</span>bindings
      <span class="token keyword">const</span> vueSpecifier <span class="token operator">=</span> <span class="token function">resolveBareModuleRequest</span><span class="token punctuation">(</span>
        root<span class="token punctuation">,</span>
        <span class="token string">'vue'</span><span class="token punctuation">,</span>
        publicPath<span class="token punctuation">,</span>
        resolver
      <span class="token punctuation">)</span>
      <span class="token keyword">const</span> <span class="token punctuation">{</span> code<span class="token punctuation">,</span> map <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">compileSFCTemplate</span><span class="token punctuation">(</span>
        root<span class="token punctuation">,</span>
        templateBlock<span class="token punctuation">,</span>
        filePath<span class="token punctuation">,</span>
        publicPath<span class="token punctuation">,</span>
        descriptor<span class="token punctuation">.</span>styles<span class="token punctuation">.</span><span class="token function">some</span><span class="token punctuation">(</span><span class="token punctuation">(</span>s<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> s<span class="token punctuation">.</span>scoped<span class="token punctuation">)</span><span class="token punctuation">,</span>
        bindingMetadata<span class="token punctuation">,</span>
        vueSpecifier<span class="token punctuation">,</span>
        config
      <span class="token punctuation">)</span>
      ctx<span class="token punctuation">.</span>body <span class="token operator">=</span> code
      ctx<span class="token punctuation">.</span>map <span class="token operator">=</span> map
      <span class="token keyword">return</span> <span class="token function">etagCacheCheck</span><span class="token punctuation">(</span>ctx<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
    <span class="token comment">// 处理 type=style 的请求</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>query<span class="token punctuation">.</span>type <span class="token operator">===</span> <span class="token string">'style'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">const</span> index <span class="token operator">=</span> <span class="token function">Number</span><span class="token punctuation">(</span>query<span class="token punctuation">.</span>index<span class="token punctuation">)</span>
      <span class="token keyword">const</span> styleBlock <span class="token operator">=</span> descriptor<span class="token punctuation">.</span>styles<span class="token punctuation">[</span>index<span class="token punctuation">]</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>styleBlock<span class="token punctuation">.</span>src<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        filePath <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token function">resolveSrcImport</span><span class="token punctuation">(</span>root<span class="token punctuation">,</span> styleBlock<span class="token punctuation">,</span> ctx<span class="token punctuation">,</span> resolver<span class="token punctuation">)</span>
      <span class="token punctuation">}</span>
      <span class="token keyword">const</span> id <span class="token operator">=</span> <span class="token function">hash_sum</span><span class="token punctuation">(</span>publicPath<span class="token punctuation">)</span>
      <span class="token keyword">const</span> result <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token function">compileSFCStyle</span><span class="token punctuation">(</span>
        root<span class="token punctuation">,</span>
        styleBlock<span class="token punctuation">,</span>
        index<span class="token punctuation">,</span>
        filePath<span class="token punctuation">,</span>
        publicPath<span class="token punctuation">,</span>
        config
      <span class="token punctuation">)</span>
      ctx<span class="token punctuation">.</span>type <span class="token operator">=</span> <span class="token string">'js'</span>
      ctx<span class="token punctuation">.</span>body <span class="token operator">=</span> <span class="token function">codegenCss</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>id<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">-</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>index<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">,</span> result<span class="token punctuation">.</span>code<span class="token punctuation">,</span> result<span class="token punctuation">.</span><span class="token keyword">module</span>s<span class="token punctuation">)</span>
      <span class="token keyword">return</span> <span class="token function">etagCacheCheck</span><span class="token punctuation">(</span>ctx<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>query<span class="token punctuation">.</span>type <span class="token operator">===</span> <span class="token string">'custom'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">const</span> index <span class="token operator">=</span> <span class="token function">Number</span><span class="token punctuation">(</span>query<span class="token punctuation">.</span>index<span class="token punctuation">)</span>
      <span class="token keyword">const</span> customBlock <span class="token operator">=</span> descriptor<span class="token punctuation">.</span>customBlocks<span class="token punctuation">[</span>index<span class="token punctuation">]</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>customBlock<span class="token punctuation">.</span>src<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        filePath <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token function">resolveSrcImport</span><span class="token punctuation">(</span>root<span class="token punctuation">,</span> customBlock<span class="token punctuation">,</span> ctx<span class="token punctuation">,</span> resolver<span class="token punctuation">)</span>
      <span class="token punctuation">}</span>
      <span class="token keyword">const</span> result <span class="token operator">=</span> <span class="token function">resolveCustomBlock</span><span class="token punctuation">(</span>
        customBlock<span class="token punctuation">,</span>
        index<span class="token punctuation">,</span>
        filePath<span class="token punctuation">,</span>
        publicPath
      <span class="token punctuation">)</span>
      ctx<span class="token punctuation">.</span>type <span class="token operator">=</span> <span class="token string">'js'</span>
      ctx<span class="token punctuation">.</span>body <span class="token operator">=</span> result
      <span class="token keyword">return</span> <span class="token function">etagCacheCheck</span><span class="token punctuation">(</span>ctx<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token comment">// 热更新处理</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br><span class="line-number">65</span><br><span class="line-number">66</span><br><span class="line-number">67</span><br><span class="line-number">68</span><br><span class="line-number">69</span><br><span class="line-number">70</span><br><span class="line-number">71</span><br><span class="line-number">72</span><br><span class="line-number">73</span><br><span class="line-number">74</span><br><span class="line-number">75</span><br><span class="line-number">76</span><br><span class="line-number">77</span><br><span class="line-number">78</span><br><span class="line-number">79</span><br><span class="line-number">80</span><br><span class="line-number">81</span><br><span class="line-number">82</span><br><span class="line-number">83</span><br><span class="line-number">84</span><br><span class="line-number">85</span><br><span class="line-number">86</span><br><span class="line-number">87</span><br><span class="line-number">88</span><br><span class="line-number">89</span><br><span class="line-number">90</span><br><span class="line-number">91</span><br><span class="line-number">92</span><br><span class="line-number">93</span><br><span class="line-number">94</span><br><span class="line-number">95</span><br><span class="line-number">96</span><br><span class="line-number">97</span><br><span class="line-number">98</span><br><span class="line-number">99</span><br><span class="line-number">100</span><br><span class="line-number">101</span><br><span class="line-number">102</span><br><span class="line-number">103</span><br><span class="line-number">104</span><br><span class="line-number">105</span><br><span class="line-number">106</span><br><span class="line-number">107</span><br><span class="line-number">108</span><br><span class="line-number">109</span><br><span class="line-number">110</span><br><span class="line-number">111</span><br><span class="line-number">112</span><br><span class="line-number">113</span><br><span class="line-number">114</span><br><span class="line-number">115</span><br><span class="line-number">116</span><br><span class="line-number">117</span><br><span class="line-number">118</span><br><span class="line-number">119</span><br><span class="line-number">120</span><br></div></div><p>实际上在看到这个思路之后，对于其他的类型文件的处理几乎都是类似的逻辑，根据请求的不同文件类型，做出不同的编译处理。</p> <p>实际上 Vite 就是在按需加载的基础上通过拦截请求实现了实时按需编译。</p> <h3 id="esbuild"><a href="#esbuild" class="header-anchor">#</a> esbuild</h3> <div class="custom-block tip"><p class="custom-block-title">提示</p> <p>esbuild：<a href="https://esbuild.github.io/" target="_blank" rel="noopener noreferrer">esbuild.github.io<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p></div> <p>根据官网的描述：</p> <blockquote><p>An extremely fast JavaScript bundler</p></blockquote> <p>我们知道 esbuild 是一个 非常快的 js 打包工具。它支持的主要特性有：</p> <ul><li>具有极致的速度，并且不需要缓存</li> <li>支持 ES Module 和 CommonJS Module</li> <li>对于 ES Module 进行 Tree shaking</li> <li>提供 Go 和 JavaScript 的接口</li> <li>支持 TypeScript 和 JSX</li> <li>支持 Surce Maps</li> <li>支持代码压缩</li> <li>支持插件</li></ul> <p>在 Vite 中，esbuild 则是负责对 jsx 和 tsx 的编译工作。</p> <h2 id="手动实现"><a href="#手动实现" class="header-anchor">#</a> 手动实现</h2> <h2 id="总结"><a href="#总结" class="header-anchor">#</a> 总结</h2></div></div> <!----> <div class="page-edit"><div class="edit-link"><a href="https://github.com/artoriaschan/edit/master/src/Vite 源码解析/01.vite.md" target="_blank" rel="noopener noreferrer">编辑</a> <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></div> <div class="tags"><a href="/tags/?tag=ESBuild" title="标签">#ESBuild</a><a href="/tags/?tag=Build%20Tools" title="标签">#Build Tools</a></div> <div class="last-updated"><span class="prefix">上次更新:</span> <span class="time">2022/07/23, 17:53:01</span></div></div> <div class="page-nav-wapper"><!----> <!----></div></div> <!----></main></div> <div class="footer"><div class="icons"><a href="mailto:dalecracker@gmail.com" title="发邮件" target="_blank" class="iconfont icon-youjian"></a><a href="https://github.com/artoriaschan" title="GitHub" target="_blank" class="iconfont icon-github"></a></div> 
  Theme by
  <a href="https://github.com/xugaoyi/vuepress-theme-vdoing" target="_blank" title="本站主题">Vdoing</a> 
    | Copyright © 2018-2022
    <span>Artorias Chan | <a href="https://raw.githubusercontent.com/artoriaschan/blog/master/LICENSE" target="_blank">MIT License</a></span></div> <div class="buttons"><div title="返回顶部" class="button blur go-to-top iconfont icon-fanhuidingbu" style="display:none;"></div> <div title="去评论" class="button blur go-to-comment iconfont icon-pinglun" style="display:none;"></div> <div title="主题模式" class="button blur theme-mode-but iconfont icon-zhuti"><ul class="select-box" style="display:none;"><li class="iconfont icon-zidong">
          跟随系统
        </li><li class="iconfont icon-rijianmoshi">
          浅色模式
        </li><li class="iconfont icon-yejianmoshi">
          深色模式
        </li><li class="iconfont icon-yuedu">
          阅读模式
        </li></ul></div></div> <div class="body-bg" style="background:url() center center / cover no-repeat;opacity:0.5;"></div> <!----> <!----></div><div class="global-ui"></div></div>
    <script src="/assets/js/app.c17531b4.js" defer></script><script src="/assets/js/2.3e7b8786.js" defer></script><script src="/assets/js/38.d458af07.js" defer></script>
  </body>
</html>