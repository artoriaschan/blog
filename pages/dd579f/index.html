<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Vite 2.0 - 新版本的vite有什么提升 | 三行代码</title>
    <meta name="generator" content="VuePress 1.8.2">
    <link rel="icon" href="/favicon.ico">
    <meta name="description" content="Web development, Frontend, JavaScript">
    <meta name="keywords" content="前端博客,个人技术博客,前端,前端开发,前端框架,web前端,前端面试题,技术文档,学习,面试,JavaScript,js,ES6,TypeScript,vue,python,css3,html5,Node,git,github,markdown">
    <meta name="theme-color" content="#11a8cd">
    <link rel="preload" href="/assets/css/0.styles.c149dbaa.css" as="style"><link rel="preload" href="/assets/js/app.c17531b4.js" as="script"><link rel="preload" href="/assets/js/2.3e7b8786.js" as="script"><link rel="preload" href="/assets/js/23.3ca57ee7.js" as="script"><link rel="prefetch" href="/assets/js/10.2234e2c8.js"><link rel="prefetch" href="/assets/js/100.42ab15ac.js"><link rel="prefetch" href="/assets/js/101.e6fef504.js"><link rel="prefetch" href="/assets/js/11.14461477.js"><link rel="prefetch" href="/assets/js/12.157d8dc0.js"><link rel="prefetch" href="/assets/js/13.a7890c3d.js"><link rel="prefetch" href="/assets/js/14.d0894eb7.js"><link rel="prefetch" href="/assets/js/15.bb14362f.js"><link rel="prefetch" href="/assets/js/16.e34746ec.js"><link rel="prefetch" href="/assets/js/17.ca83e363.js"><link rel="prefetch" href="/assets/js/18.9a14520a.js"><link rel="prefetch" href="/assets/js/19.ceb87610.js"><link rel="prefetch" href="/assets/js/20.0d0d893e.js"><link rel="prefetch" href="/assets/js/21.a2cae791.js"><link rel="prefetch" href="/assets/js/22.9bd77fe5.js"><link rel="prefetch" href="/assets/js/24.5df7731a.js"><link rel="prefetch" href="/assets/js/25.becd8254.js"><link rel="prefetch" href="/assets/js/26.21837df4.js"><link rel="prefetch" href="/assets/js/27.12585d76.js"><link rel="prefetch" href="/assets/js/28.4aff2d40.js"><link rel="prefetch" href="/assets/js/29.606a725e.js"><link rel="prefetch" href="/assets/js/3.953185bb.js"><link rel="prefetch" href="/assets/js/30.281826a9.js"><link rel="prefetch" href="/assets/js/31.3e0344fb.js"><link rel="prefetch" href="/assets/js/32.1ef62439.js"><link rel="prefetch" href="/assets/js/33.7f023c0c.js"><link rel="prefetch" href="/assets/js/34.ad479baf.js"><link rel="prefetch" href="/assets/js/35.dc52b883.js"><link rel="prefetch" href="/assets/js/36.a8a20daf.js"><link rel="prefetch" href="/assets/js/37.c33aae67.js"><link rel="prefetch" href="/assets/js/38.d458af07.js"><link rel="prefetch" href="/assets/js/39.668922f9.js"><link rel="prefetch" href="/assets/js/4.c115e727.js"><link rel="prefetch" href="/assets/js/40.dd259277.js"><link rel="prefetch" href="/assets/js/41.0685dabf.js"><link rel="prefetch" href="/assets/js/42.90bf1511.js"><link rel="prefetch" href="/assets/js/43.81710a1b.js"><link rel="prefetch" href="/assets/js/44.a20853a1.js"><link rel="prefetch" href="/assets/js/45.a0a76abf.js"><link rel="prefetch" href="/assets/js/46.95e74803.js"><link rel="prefetch" href="/assets/js/47.ba80bcea.js"><link rel="prefetch" href="/assets/js/48.ddc3aede.js"><link rel="prefetch" href="/assets/js/49.3040c348.js"><link rel="prefetch" href="/assets/js/5.7d5490f2.js"><link rel="prefetch" href="/assets/js/50.9e45cd68.js"><link rel="prefetch" href="/assets/js/51.3a5eacd8.js"><link rel="prefetch" href="/assets/js/52.2a50b570.js"><link rel="prefetch" href="/assets/js/53.8059a783.js"><link rel="prefetch" href="/assets/js/54.3e54252d.js"><link rel="prefetch" href="/assets/js/55.50b455ff.js"><link rel="prefetch" href="/assets/js/56.43d7e6b7.js"><link rel="prefetch" href="/assets/js/57.dc8bbc95.js"><link rel="prefetch" href="/assets/js/58.c0b76901.js"><link rel="prefetch" href="/assets/js/59.28ec02f3.js"><link rel="prefetch" href="/assets/js/6.8749434b.js"><link rel="prefetch" href="/assets/js/60.001ff532.js"><link rel="prefetch" href="/assets/js/61.b9d6b6db.js"><link rel="prefetch" href="/assets/js/62.81245a10.js"><link rel="prefetch" href="/assets/js/63.8332ae73.js"><link rel="prefetch" href="/assets/js/64.357b1d40.js"><link rel="prefetch" href="/assets/js/65.947a76a1.js"><link rel="prefetch" href="/assets/js/66.59c57da7.js"><link rel="prefetch" href="/assets/js/67.02d525a5.js"><link rel="prefetch" href="/assets/js/68.808b1fd2.js"><link rel="prefetch" href="/assets/js/69.703935c0.js"><link rel="prefetch" href="/assets/js/7.7aa8fb69.js"><link rel="prefetch" href="/assets/js/70.9c6a4dbf.js"><link rel="prefetch" href="/assets/js/71.955445a1.js"><link rel="prefetch" href="/assets/js/72.5ae810be.js"><link rel="prefetch" href="/assets/js/73.40b461f0.js"><link rel="prefetch" href="/assets/js/74.eb777c24.js"><link rel="prefetch" href="/assets/js/75.cf25358f.js"><link rel="prefetch" href="/assets/js/76.f2b37de5.js"><link rel="prefetch" href="/assets/js/77.5db6e6e5.js"><link rel="prefetch" href="/assets/js/78.2fcfdf72.js"><link rel="prefetch" href="/assets/js/79.501697d3.js"><link rel="prefetch" href="/assets/js/8.6aee0b06.js"><link rel="prefetch" href="/assets/js/80.1c75a4c9.js"><link rel="prefetch" href="/assets/js/81.eb9a1728.js"><link rel="prefetch" href="/assets/js/82.d18239f7.js"><link rel="prefetch" href="/assets/js/83.b4360fed.js"><link rel="prefetch" href="/assets/js/84.206370c0.js"><link rel="prefetch" href="/assets/js/85.7ef6ce1f.js"><link rel="prefetch" href="/assets/js/86.711072c9.js"><link rel="prefetch" href="/assets/js/87.8db4bcfa.js"><link rel="prefetch" href="/assets/js/88.d23ba184.js"><link rel="prefetch" href="/assets/js/89.9cd79b2e.js"><link rel="prefetch" href="/assets/js/9.9d5551f6.js"><link rel="prefetch" href="/assets/js/90.1000b730.js"><link rel="prefetch" href="/assets/js/91.0c90c597.js"><link rel="prefetch" href="/assets/js/92.e6b9a689.js"><link rel="prefetch" href="/assets/js/93.3ba18b6b.js"><link rel="prefetch" href="/assets/js/94.8eb468d2.js"><link rel="prefetch" href="/assets/js/95.7b5e4261.js"><link rel="prefetch" href="/assets/js/96.6d0c67f2.js"><link rel="prefetch" href="/assets/js/97.98f63f27.js"><link rel="prefetch" href="/assets/js/98.f7445085.js"><link rel="prefetch" href="/assets/js/99.f9a1abbd.js">
    <link rel="stylesheet" href="/assets/css/0.styles.c149dbaa.css">
  </head>
  <body class="theme-mode-light">
    <div id="app" data-server-rendered="true"><div class="theme-container sidebar-open have-rightmenu have-body-img"><header class="navbar blur"><div title="目录" class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><img src="https://cdn.jsdelivr.net/gh/artoriaschan/image-hosting@master/blog/20200105104632.15vzpyhnwvuk.png" alt="三行代码" class="logo"> <span class="site-name can-hide">三行代码</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/" class="nav-link">首页</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="前端" class="dropdown-title"><a href="/web/" class="link-title">前端</a> <span class="title" style="display:none;">前端</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><h4>前端文章</h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/pages/d533f9/" class="nav-link">基础知识</a></li><li class="dropdown-subitem"><a href="/pages/6d91ad/" class="nav-link">JavaScript</a></li><li class="dropdown-subitem"><a href="/pages/c5fd6c/" class="nav-link">Vue</a></li><li class="dropdown-subitem"><a href="/pages/8da03e/" class="nav-link">React</a></li><li class="dropdown-subitem"><a href="/pages/28de07/" class="nav-link">杂谈</a></li></ul></li><li class="dropdown-item"><h4>学习笔记</h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/note/vue2/" class="nav-link">Vue 2 源码解析</a></li><li class="dropdown-subitem"><a href="/note/vue3/" class="nav-link">Vue 3 源码解析</a></li><li class="dropdown-subitem"><a href="/note/react17/" class="nav-link">React 17 源码解析</a></li><li class="dropdown-subitem"><a href="/note/vite/" class="nav-link">Vite 源码解析</a></li></ul></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="页面" class="dropdown-title"><a href="/ui/" class="link-title">页面</a> <span class="title" style="display:none;">页面</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/pages/8309a5b876fc95e3/" class="nav-link">HTML</a></li><li class="dropdown-item"><!----> <a href="/pages/0a83b083bdf257cb/" class="nav-link">CSS</a></li><li class="dropdown-item"><!----> <a href="/pages/9f15c1a281d8bedb/" class="nav-link">Stylus</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="技术" class="dropdown-title"><a href="/technology/" class="link-title">技术</a> <span class="title" style="display:none;">技术</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/pages/9a7ee40fc232253e/" class="nav-link">技术文档</a></li><li class="dropdown-item"><!----> <a href="/pages/4c778760be26d8b3/" class="nav-link">GitHub技巧</a></li><li class="dropdown-item"><!----> <a href="/pages/117708e0af7f0bd9/" class="nav-link">Nodejs</a></li><li class="dropdown-item"><!----> <a href="/pages/33969f/" class="nav-link">Interview</a></li><li class="dropdown-item"><h4>Rust</h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/note/rust-notes/" class="nav-link">Rust 学习笔记</a></li></ul></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="转载" class="dropdown-title"><a href="/reship/" class="link-title">转载</a> <span class="title" style="display:none;">转载</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/pages/ed5303/" class="nav-link">前端精读</a></li></ul></div></div><div class="nav-item"><a href="/pages/beb6c0bd8a66cea6/" class="nav-link">收藏</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="索引" class="dropdown-title"><a href="/archives/" class="link-title">索引</a> <span class="title" style="display:none;">索引</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/categories/" class="nav-link">分类</a></li><li class="dropdown-item"><!----> <a href="/tags/" class="nav-link">标签</a></li><li class="dropdown-item"><!----> <a href="/archives/" class="nav-link">归档</a></li></ul></div></div> <a href="https://github.com/artoriaschan" target="_blank" rel="noopener noreferrer" class="repo-link">
    GitHub
    <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar" style="display:none;"><div class="blogger"><img src="https://cdn.jsdelivr.net/gh/artoriaschan/image-hosting@master/blog/WechatIMG1.6c8n1rhrpqg0.jpeg"> <div class="blogger-info"><h3>陈先生</h3> <span>☭ 让我们一起粉碎资本主义吧， 达瓦里氏！☭</span></div></div> <nav class="nav-links"><div class="nav-item"><a href="/" class="nav-link">首页</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="前端" class="dropdown-title"><a href="/web/" class="link-title">前端</a> <span class="title" style="display:none;">前端</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><h4>前端文章</h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/pages/d533f9/" class="nav-link">基础知识</a></li><li class="dropdown-subitem"><a href="/pages/6d91ad/" class="nav-link">JavaScript</a></li><li class="dropdown-subitem"><a href="/pages/c5fd6c/" class="nav-link">Vue</a></li><li class="dropdown-subitem"><a href="/pages/8da03e/" class="nav-link">React</a></li><li class="dropdown-subitem"><a href="/pages/28de07/" class="nav-link">杂谈</a></li></ul></li><li class="dropdown-item"><h4>学习笔记</h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/note/vue2/" class="nav-link">Vue 2 源码解析</a></li><li class="dropdown-subitem"><a href="/note/vue3/" class="nav-link">Vue 3 源码解析</a></li><li class="dropdown-subitem"><a href="/note/react17/" class="nav-link">React 17 源码解析</a></li><li class="dropdown-subitem"><a href="/note/vite/" class="nav-link">Vite 源码解析</a></li></ul></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="页面" class="dropdown-title"><a href="/ui/" class="link-title">页面</a> <span class="title" style="display:none;">页面</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/pages/8309a5b876fc95e3/" class="nav-link">HTML</a></li><li class="dropdown-item"><!----> <a href="/pages/0a83b083bdf257cb/" class="nav-link">CSS</a></li><li class="dropdown-item"><!----> <a href="/pages/9f15c1a281d8bedb/" class="nav-link">Stylus</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="技术" class="dropdown-title"><a href="/technology/" class="link-title">技术</a> <span class="title" style="display:none;">技术</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/pages/9a7ee40fc232253e/" class="nav-link">技术文档</a></li><li class="dropdown-item"><!----> <a href="/pages/4c778760be26d8b3/" class="nav-link">GitHub技巧</a></li><li class="dropdown-item"><!----> <a href="/pages/117708e0af7f0bd9/" class="nav-link">Nodejs</a></li><li class="dropdown-item"><!----> <a href="/pages/33969f/" class="nav-link">Interview</a></li><li class="dropdown-item"><h4>Rust</h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/note/rust-notes/" class="nav-link">Rust 学习笔记</a></li></ul></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="转载" class="dropdown-title"><a href="/reship/" class="link-title">转载</a> <span class="title" style="display:none;">转载</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/pages/ed5303/" class="nav-link">前端精读</a></li></ul></div></div><div class="nav-item"><a href="/pages/beb6c0bd8a66cea6/" class="nav-link">收藏</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="索引" class="dropdown-title"><a href="/archives/" class="link-title">索引</a> <span class="title" style="display:none;">索引</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/categories/" class="nav-link">分类</a></li><li class="dropdown-item"><!----> <a href="/tags/" class="nav-link">标签</a></li><li class="dropdown-item"><!----> <a href="/archives/" class="nav-link">归档</a></li></ul></div></div> <a href="https://github.com/artoriaschan" target="_blank" rel="noopener noreferrer" class="repo-link">
    GitHub
    <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></nav>  <ul class="sidebar-links"><li><section class="sidebar-group depth-0"><p class="sidebar-heading open"><span>Vite 2.0 - 新版本的vite有什么提升</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/pages/dd579f/#目录结构" class="sidebar-link">目录结构</a><ul class="sidebar-sub-headers"></ul></li><li><a href="/pages/dd579f/#vite-2-0-的devserver" class="sidebar-link">vite 2.0 的DevServer</a><ul class="sidebar-sub-headers"></ul></li><li><a href="/pages/dd579f/#vite-2-0-的中间件" class="sidebar-link">vite 2.0 的中间件</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/pages/dd579f/#检测命中缓存" class="sidebar-link">检测命中缓存</a></li><li class="sidebar-sub-header"><a href="/pages/dd579f/#resolveid-钩子函数处理-url" class="sidebar-link">resolveId 钩子函数处理 url</a></li><li class="sidebar-sub-header"><a href="/pages/dd579f/#load-钩子函数加载资源" class="sidebar-link">load 钩子函数加载资源</a></li><li class="sidebar-sub-header"><a href="/pages/dd579f/#transform-钩子函数处理-code" class="sidebar-link">transform 钩子函数处理 code</a></li></ul></li><li><a href="/pages/dd579f/#vite-2-0-的插件机制" class="sidebar-link">vite 2.0 的插件机制</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/pages/dd579f/#加载插件" class="sidebar-link">加载插件</a></li><li class="sidebar-sub-header"><a href="/pages/dd579f/#调用插件" class="sidebar-link">调用插件</a></li></ul></li><li><a href="/pages/dd579f/#vite-2-0-的热更新机制" class="sidebar-link">vite 2.0 的热更新机制</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/pages/dd579f/#启动-watcher" class="sidebar-link">启动 watcher</a></li><li class="sidebar-sub-header"><a href="/pages/dd579f/#发送-payload" class="sidebar-link">发送 payload</a></li><li class="sidebar-sub-header"><a href="/pages/dd579f/#解析-payload" class="sidebar-link">解析 payload</a></li></ul></li><li><a href="/pages/dd579f/#总结" class="sidebar-link">总结</a><ul class="sidebar-sub-headers"></ul></li><li><a href="/pages/dd579f/#扩展阅读" class="sidebar-link">扩展阅读</a><ul class="sidebar-sub-headers"></ul></li></ul></section></li></ul> </aside> <div><main class="page"><div class="theme-vdoing-wrapper "><div class="articleInfo-wrap" data-v-1cd794fe><div class="articleInfo" data-v-1cd794fe><ul class="breadcrumbs" data-v-1cd794fe><li data-v-1cd794fe><a href="/" title="首页" class="iconfont icon-home router-link-active" data-v-1cd794fe></a></li> <li data-v-1cd794fe><a href="/note/vite/" title="Vite 源码解析-目录页" data-v-1cd794fe>Vite 源码解析</a></li> <!----> <!----></ul> <div class="info" data-v-1cd794fe><div title="作者" class="author iconfont icon-touxiang" data-v-1cd794fe><a href="https://github.com/artoriaschan" target="_blank" title="作者" class="beLink" data-v-1cd794fe>Artorias Chan</a></div> <div title="创建时间" class="date iconfont icon-riqi" data-v-1cd794fe><a href="javascript:;" data-v-1cd794fe>2021-03-20</a></div> <!----></div></div></div> <!----> <div class="content-wrapper"><div class="right-menu-wrapper"><div class="right-menu-margin"><div class="right-menu-content"></div></div></div> <h1><!---->
          Vite 2.0 - 新版本的vite有什么提升
        </h1> <!----> <div class="theme-vdoing-content content__default"><h1 id="vite-2-0-新版本的vite有什么提升"><a href="#vite-2-0-新版本的vite有什么提升" class="header-anchor">#</a> Vite 2.0 - 新版本的vite有什么提升</h1> <p>vite 在悄无声息中更新到了2.0, 以至于许多开发者都没怎么体验和了解vite 1.0, 就听到了 vite 2.0 推出的消息.</p> <p align="center"><img src="https://cdn.jsdelivr.net/gh/artoriaschan/image-hosting@master/blog/vite2-twitter.48fexteefk00.png"></p> <p>并且尤大在 Dev.to 上也发布了一篇简单的介绍文章: <a href="https://dev.to/yyx990803/announcing-vite-2-0-2f0a" target="_blank" rel="noopener noreferrer">Announcing Vite 2.0<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>, 并且在文中也列数了 2.0 相较于 1.0 , 在哪些方面做了提升:</p> <ul><li>核心设计框架无感知</li> <li>全新插件格式和接口设计</li> <li>基于esbuild的依赖预捆绑</li> <li>CSS的一等公民支持</li> <li>SSR的支持</li> <li>可选的传统浏览器支持</li></ul> <p>下面就让我们来简单的分析一下vite的实现原理和细节.</p> <h2 id="目录结构"><a href="#目录结构" class="header-anchor">#</a> 目录结构</h2> <p>我们先来看一下vite的目录结构:</p> <p><img src="/assets/img/vite2-tree.054585a6.png" alt="vite2-tree"></p> <p>我们可以看到有这么几个文件夹:</p> <ul><li>create-app</li> <li>playground</li> <li>plugin-legacy</li> <li>plugin-react-refresh</li> <li>plugin-vue</li> <li>plugin-vue-jsx</li> <li>vite</li></ul> <p>我们就先来分析最主要最核心的部分: vite 文件夹中的代码.</p> <h2 id="vite-2-0-的devserver"><a href="#vite-2-0-的devserver" class="header-anchor">#</a> vite 2.0 的DevServer</h2> <p>vite 文件夹中提供了 vite cli, 其中就包括最核心的 ViteDevServer .</p> <p>其实大家对于vite最核心的原理都有所了解, 就是基于 native ESM 来实现的. 但是对于 1.0 的版本来说, 本质上是和 vue 3.0 进行绑定的, 无法轻易的适用到其他的前端框架的开发中去, 基于此, vite 2.0 重新设计了结构, 以便达成 <strong>框架无感知</strong> 的目的.</p> <p>其中也对本地开发服务进行了改造. vite 1.0 版本是基于koa进行设计的, 而在 vite 2.0 中则是抛弃掉了koa框架, 使用 node.js 的 http 模块及 connect 中间件框架来达到相同的效果.</p> <p>下面是ViteDevServer的流程图:</p> <p><img src="/assets/img/vite2-flow.7f81b5b9.png" alt="vite2-flow"></p> <p>我们可以看一下源码中ViteDevServer的实现:</p> <div class="language-ts line-numbers-mode"><pre class="language-ts"><code><span class="token comment">// packages/vite/src/node/server/index.ts -&gt; function createServer</span>
<span class="token comment">// ...</span>
<span class="token keyword">const</span> server<span class="token operator">:</span> ViteDevServer <span class="token operator">=</span> <span class="token punctuation">{</span>
  config<span class="token operator">:</span> config<span class="token punctuation">,</span>
  middlewares<span class="token punctuation">,</span>  <span class="token comment">// connect中间件框架</span>
  httpServer<span class="token punctuation">,</span> <span class="token comment">// http服务</span>
  watcher<span class="token punctuation">,</span>  <span class="token comment">// 文件监控服务</span>
  pluginContainer<span class="token operator">:</span> container<span class="token punctuation">,</span> <span class="token comment">// 插件容器</span>
  ws<span class="token punctuation">,</span> <span class="token comment">// WebSocket服务</span>
  <span class="token keyword">module</span>Graph<span class="token punctuation">,</span>  <span class="token comment">// 模块映射图</span>
  transformWithEsbuild<span class="token punctuation">,</span> <span class="token comment">// 基于esbuild转化模块</span>
  <span class="token function">transformRequest</span><span class="token punctuation">(</span>url<span class="token punctuation">,</span> options<span class="token punctuation">)</span> <span class="token punctuation">{</span>  <span class="token comment">// 请求转换方法</span>
    <span class="token keyword">return</span> <span class="token function">transformRequest</span><span class="token punctuation">(</span>url<span class="token punctuation">,</span> server<span class="token punctuation">,</span> options<span class="token punctuation">)</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  transformIndexHtml<span class="token operator">:</span> <span class="token keyword">null</span> <span class="token keyword">as</span> <span class="token builtin">any</span><span class="token punctuation">,</span>  <span class="token comment">// index.html 转化</span>
  <span class="token function">ssrLoadModule</span><span class="token punctuation">(</span>url<span class="token punctuation">)</span> <span class="token punctuation">{</span> 
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>server<span class="token punctuation">.</span>_ssrExternals<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      server<span class="token punctuation">.</span>_ssrExternals <span class="token operator">=</span> <span class="token function">resolveSSRExternal</span><span class="token punctuation">(</span>
        config<span class="token punctuation">,</span>
        server<span class="token punctuation">.</span>_optimizeDepsMetadata
          <span class="token operator">?</span> Object<span class="token punctuation">.</span><span class="token function">keys</span><span class="token punctuation">(</span>server<span class="token punctuation">.</span>_optimizeDepsMetadata<span class="token punctuation">.</span>optimized<span class="token punctuation">)</span>
          <span class="token operator">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
      <span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> <span class="token function">ssrLoadModule</span><span class="token punctuation">(</span>url<span class="token punctuation">,</span> server<span class="token punctuation">)</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token function">ssrFixStacktrace</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>e<span class="token punctuation">.</span>stack<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      e<span class="token punctuation">.</span>stack <span class="token operator">=</span> <span class="token function">ssrRewriteStacktrace</span><span class="token punctuation">(</span>e<span class="token punctuation">.</span>stack<span class="token punctuation">,</span> <span class="token keyword">module</span>Graph<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token function">listen</span><span class="token punctuation">(</span>port<span class="token operator">?</span><span class="token operator">:</span> <span class="token builtin">number</span><span class="token punctuation">,</span> isRestart<span class="token operator">?</span><span class="token operator">:</span> <span class="token builtin">boolean</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>  <span class="token comment">// 服务启动方法</span>
    <span class="token keyword">return</span> <span class="token function">startServer</span><span class="token punctuation">(</span>server<span class="token punctuation">,</span> port<span class="token punctuation">,</span> isRestart<span class="token punctuation">)</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token keyword">async</span> <span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment">// 服务关闭方法</span>
    <span class="token keyword">await</span> <span class="token builtin">Promise</span><span class="token punctuation">.</span><span class="token function">all</span><span class="token punctuation">(</span><span class="token punctuation">[</span>
      watcher<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
      ws<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
      container<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
      <span class="token function">closeHttpServer</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">]</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token comment">// ...</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br></div></div><p>可以看到 ViteDevServer 是一个对象字面量, 我们可以先看其中的 middlewares , httpServer, watcher 及 ws 字段.</p> <h2 id="vite-2-0-的中间件"><a href="#vite-2-0-的中间件" class="header-anchor">#</a> vite 2.0 的中间件</h2> <p>首先我们看一下 middlewares 字段的实现:</p> <div class="language-ts line-numbers-mode"><pre class="language-ts"><code><span class="token comment">// packages/vite/src/node/server/index.ts -&gt; function createServer</span>

<span class="token keyword">import</span> connect <span class="token keyword">from</span> <span class="token string">'connect'</span>

<span class="token keyword">export</span> <span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token function">createServer</span><span class="token punctuation">(</span>
  inlineConfig<span class="token operator">:</span> InlineConfig <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
<span class="token punctuation">)</span><span class="token operator">:</span> <span class="token builtin">Promise</span><span class="token operator">&lt;</span>ViteDevServer<span class="token operator">&gt;</span> <span class="token punctuation">{</span>
  <span class="token comment">// ...</span>
  <span class="token keyword">const</span> middlewares <span class="token operator">=</span> <span class="token function">connect</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">as</span> Connect<span class="token punctuation">.</span>Server
  <span class="token keyword">const</span> httpServer <span class="token operator">=</span> middlewareMode
    <span class="token operator">?</span> <span class="token keyword">null</span>
    <span class="token operator">:</span> <span class="token keyword">await</span> <span class="token function">resolveHttpServer</span><span class="token punctuation">(</span>serverConfig<span class="token punctuation">,</span> middlewares<span class="token punctuation">)</span>
  <span class="token comment">// ...</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br></div></div><div class="language-ts line-numbers-mode"><pre class="language-ts"><code><span class="token comment">// packages/vite/src/node/server/http.ts</span>

<span class="token keyword">export</span> <span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token function">resolveHttpServer</span><span class="token punctuation">(</span>
  <span class="token punctuation">{</span> https <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">,</span> proxy <span class="token punctuation">}</span><span class="token operator">:</span> ServerOptions<span class="token punctuation">,</span>
  app<span class="token operator">:</span> Connect<span class="token punctuation">.</span>Server
<span class="token punctuation">)</span><span class="token operator">:</span> <span class="token builtin">Promise</span><span class="token operator">&lt;</span>HttpServer<span class="token operator">&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>https<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token keyword">require</span><span class="token punctuation">(</span><span class="token string">'http'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">createServer</span><span class="token punctuation">(</span>app<span class="token punctuation">)</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">const</span> httpsOptions <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token function">resolveHttpsConfig</span><span class="token punctuation">(</span>
    <span class="token keyword">typeof</span> https <span class="token operator">===</span> <span class="token string">'boolean'</span> <span class="token operator">?</span> <span class="token punctuation">{</span><span class="token punctuation">}</span> <span class="token operator">:</span> https
  <span class="token punctuation">)</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>proxy<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// #484 fallback to http1 when proxy is needed.</span>
    <span class="token keyword">return</span> <span class="token keyword">require</span><span class="token punctuation">(</span><span class="token string">'https'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">createServer</span><span class="token punctuation">(</span>httpsOptions<span class="token punctuation">,</span> app<span class="token punctuation">)</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token keyword">require</span><span class="token punctuation">(</span><span class="token string">'http2'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">createSecureServer</span><span class="token punctuation">(</span>
      <span class="token punctuation">{</span>
        <span class="token operator">...</span>httpsOptions<span class="token punctuation">,</span>
        allowHTTP1<span class="token operator">:</span> <span class="token boolean">true</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span>
      app
    <span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br></div></div><p>并且在后面添加中间件来处理请求:</p> <div class="language-ts line-numbers-mode"><div class="highlight-lines"><br><br><br><div class="highlighted"> </div><br><br><br><br><br><div class="highlighted"> </div><br><br><br><br><br><div class="highlighted"> </div><br><br><br><br><div class="highlighted"> </div><br><br><br><div class="highlighted"> </div><br><br><div class="highlighted"> </div><br><br><div class="highlighted"> </div><br><br><br><br><div class="highlighted"> </div><br><br><div class="highlighted"> </div><br><br><div class="highlighted"> </div><div class="highlighted"> </div><br><br><br><div class="highlighted"> </div><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><div class="highlighted"> </div><br><div class="highlighted"> </div><br><br><br><br><br><br><div class="highlighted"> </div><br></div><pre class="language-ts"><code><span class="token comment">// packages/vite/src/node/server/index.ts -&gt; function createServer</span>

<span class="token keyword">if</span> <span class="token punctuation">(</span>process<span class="token punctuation">.</span>env<span class="token punctuation">.</span><span class="token constant">DEBUG</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  middlewares<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span><span class="token function">timeMiddleware</span><span class="token punctuation">(</span>root<span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token comment">// cors (enabled by default)</span>
<span class="token keyword">const</span> <span class="token punctuation">{</span> cors <span class="token punctuation">}</span> <span class="token operator">=</span> serverConfig
<span class="token keyword">if</span> <span class="token punctuation">(</span>cors <span class="token operator">!==</span> <span class="token boolean">false</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  middlewares<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span><span class="token function">corsMiddleware</span><span class="token punctuation">(</span><span class="token keyword">typeof</span> cors <span class="token operator">===</span> <span class="token string">'boolean'</span> <span class="token operator">?</span> <span class="token punctuation">{</span><span class="token punctuation">}</span> <span class="token operator">:</span> cors<span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token comment">// proxy</span>
<span class="token keyword">const</span> <span class="token punctuation">{</span> proxy <span class="token punctuation">}</span> <span class="token operator">=</span> serverConfig
<span class="token keyword">if</span> <span class="token punctuation">(</span>proxy<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  middlewares<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span><span class="token function">proxyMiddleware</span><span class="token punctuation">(</span>httpServer<span class="token punctuation">,</span> config<span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token comment">// base</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span>config<span class="token punctuation">.</span>base <span class="token operator">!==</span> <span class="token string">'/'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  middlewares<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span><span class="token function">baseMiddleware</span><span class="token punctuation">(</span>server<span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token comment">// open in editor support</span>
middlewares<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span><span class="token string">'/__open-in-editor'</span><span class="token punctuation">,</span> <span class="token function">launchEditorMiddleware</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

<span class="token comment">// hmr reconnect ping</span>
middlewares<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span><span class="token string">'/__vite_ping'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span>_<span class="token punctuation">,</span> res<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> res<span class="token punctuation">.</span><span class="token function">end</span><span class="token punctuation">(</span><span class="token string">'pong'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

<span class="token comment">//decode request url</span>
middlewares<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span><span class="token function">decodeURIMiddleware</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

<span class="token comment">// serve static files under /public</span>
<span class="token comment">// this applies before the transform middleware so that these files are served</span>
<span class="token comment">// as-is without transforms.</span>
middlewares<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span><span class="token function">servePublicMiddleware</span><span class="token punctuation">(</span>config<span class="token punctuation">.</span>publicDir<span class="token punctuation">)</span><span class="token punctuation">)</span>

<span class="token comment">// main transform middleware</span>
middlewares<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span><span class="token function">transformMiddleware</span><span class="token punctuation">(</span>server<span class="token punctuation">)</span><span class="token punctuation">)</span>

<span class="token comment">// serve static files</span>
middlewares<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span><span class="token function">serveRawFsMiddleware</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
middlewares<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span><span class="token function">serveStaticMiddleware</span><span class="token punctuation">(</span>root<span class="token punctuation">,</span> config<span class="token punctuation">)</span><span class="token punctuation">)</span>

<span class="token comment">// spa fallback</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>middlewareMode<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  middlewares<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span>
    <span class="token function">history</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
      logger<span class="token operator">:</span> <span class="token function">createDebugger</span><span class="token punctuation">(</span><span class="token string">'vite:spa-fallback'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
      <span class="token comment">// support /dir/ without explicit index.html</span>
      rewrites<span class="token operator">:</span> <span class="token punctuation">[</span>
        <span class="token punctuation">{</span>
          from<span class="token operator">:</span> <span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">\/$</span><span class="token regex-delimiter">/</span></span><span class="token punctuation">,</span>
          <span class="token function">to</span><span class="token punctuation">(</span><span class="token punctuation">{</span> parsedUrl <span class="token punctuation">}</span><span class="token operator">:</span> <span class="token builtin">any</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">const</span> rewritten <span class="token operator">=</span> parsedUrl<span class="token punctuation">.</span>pathname <span class="token operator">+</span> <span class="token string">'index.html'</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>fs<span class="token punctuation">.</span><span class="token function">existsSync</span><span class="token punctuation">(</span>path<span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span>root<span class="token punctuation">,</span> rewritten<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
              <span class="token keyword">return</span> rewritten
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
              <span class="token keyword">return</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">/index.html</span><span class="token template-punctuation string">`</span></span>
            <span class="token punctuation">}</span>
          <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">]</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token comment">// run post config hooks</span>
<span class="token comment">// This is applied before the html middleware so that user middleware can</span>
<span class="token comment">// serve custom content instead of index.html.</span>
postHooks<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token punctuation">(</span>fn<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> fn <span class="token operator">&amp;&amp;</span> <span class="token function">fn</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>middlewareMode<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// transform index.html</span>
  middlewares<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span><span class="token function">indexHtmlMiddleware</span><span class="token punctuation">(</span>server<span class="token punctuation">)</span><span class="token punctuation">)</span>
  <span class="token comment">// handle 404s</span>
  middlewares<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span><span class="token punctuation">(</span>_<span class="token punctuation">,</span> res<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    res<span class="token punctuation">.</span>statusCode <span class="token operator">=</span> <span class="token number">404</span>
    res<span class="token punctuation">.</span><span class="token function">end</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token comment">// error handler</span>
middlewares<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span><span class="token function">errorMiddleware</span><span class="token punctuation">(</span>server<span class="token punctuation">,</span> middlewareMode<span class="token punctuation">)</span><span class="token punctuation">)</span>
</code></pre><div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br><span class="line-number">65</span><br><span class="line-number">66</span><br><span class="line-number">67</span><br><span class="line-number">68</span><br><span class="line-number">69</span><br><span class="line-number">70</span><br><span class="line-number">71</span><br><span class="line-number">72</span><br><span class="line-number">73</span><br><span class="line-number">74</span><br><span class="line-number">75</span><br><span class="line-number">76</span><br><span class="line-number">77</span><br><span class="line-number">78</span><br><span class="line-number">79</span><br><span class="line-number">80</span><br><span class="line-number">81</span><br><span class="line-number">82</span><br><span class="line-number">83</span><br><span class="line-number">84</span><br></div></div><p>大致上的中间件有以下几种:</p> <p><img src="/assets/img/vite2-middlewares.4ce614c8.png" alt="vite2-middlewares"></p> <p>其中最核心的中间件则是 transformMiddleware , 用来处理各种类型请求的返回值:</p> <div class="language-ts line-numbers-mode"><div class="highlight-lines"><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><div class="highlighted"> </div><div class="highlighted"> </div><div class="highlighted"> </div><div class="highlighted"> </div><div class="highlighted"> </div><div class="highlighted"> </div><div class="highlighted"> </div><div class="highlighted"> </div><br><br><br><br><br><br><br><br><br><br><br><div class="highlighted"> </div><div class="highlighted"> </div><div class="highlighted"> </div><div class="highlighted"> </div><div class="highlighted"> </div><div class="highlighted"> </div><div class="highlighted"> </div><div class="highlighted"> </div><div class="highlighted"> </div><div class="highlighted"> </div><div class="highlighted"> </div><div class="highlighted"> </div><br><div class="highlighted"> </div><div class="highlighted"> </div><div class="highlighted"> </div><div class="highlighted"> </div><div class="highlighted"> </div><div class="highlighted"> </div><div class="highlighted"> </div><div class="highlighted"> </div><div class="highlighted"> </div><div class="highlighted"> </div><br><div class="highlighted"> </div><div class="highlighted"> </div><div class="highlighted"> </div><div class="highlighted"> </div><div class="highlighted"> </div><div class="highlighted"> </div><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><div class="highlighted"> </div><div class="highlighted"> </div><div class="highlighted"> </div><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br></div><pre class="language-ts"><code><span class="token comment">// packages/vite/src/node/server/middlewares/transform.ts</span>

<span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">transformMiddleware</span><span class="token punctuation">(</span>
  server<span class="token operator">:</span> ViteDevServer
<span class="token punctuation">)</span><span class="token operator">:</span> Connect<span class="token punctuation">.</span>NextHandleFunction <span class="token punctuation">{</span>
  <span class="token keyword">const</span> <span class="token punctuation">{</span>
    config<span class="token operator">:</span> <span class="token punctuation">{</span> root<span class="token punctuation">,</span> logger <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token keyword">module</span>Graph
  <span class="token punctuation">}</span> <span class="token operator">=</span> server

  <span class="token keyword">return</span> <span class="token keyword">async</span> <span class="token punctuation">(</span>req<span class="token punctuation">,</span> res<span class="token punctuation">,</span> next<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token comment">// 命中忽略文件直接返回</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>req<span class="token punctuation">.</span>method <span class="token operator">!==</span> <span class="token string">'GET'</span> <span class="token operator">||</span> knownIgnoreList<span class="token punctuation">.</span><span class="token function">has</span><span class="token punctuation">(</span>req<span class="token punctuation">.</span>url<span class="token operator">!</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">return</span> <span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
    <span class="token comment">// reload 时处理</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>
      server<span class="token punctuation">.</span>_pendingReload <span class="token operator">&amp;&amp;</span>
      <span class="token operator">!</span>req<span class="token punctuation">.</span>url<span class="token operator">?.</span><span class="token function">startsWith</span><span class="token punctuation">(</span><span class="token constant">CLIENT_PUBLIC_PATH</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span>
      <span class="token operator">!</span>req<span class="token punctuation">.</span>url<span class="token operator">?.</span><span class="token function">includes</span><span class="token punctuation">(</span><span class="token string">'vite/dist/client'</span><span class="token punctuation">)</span>
    <span class="token punctuation">)</span> <span class="token punctuation">{</span>
      server<span class="token punctuation">.</span>_pendingReload<span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> res<span class="token punctuation">.</span><span class="token function">end</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
      <span class="token keyword">return</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">let</span> url
    <span class="token keyword">try</span> <span class="token punctuation">{</span>
      url <span class="token operator">=</span> <span class="token function">removeTimestampQuery</span><span class="token punctuation">(</span>req<span class="token punctuation">.</span>url<span class="token operator">!</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">replace</span><span class="token punctuation">(</span><span class="token constant">NULL_BYTE_PLACEHOLDER</span><span class="token punctuation">,</span> <span class="token string">'\0'</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>err<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">//...</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">const</span> withoutQuery <span class="token operator">=</span> <span class="token function">cleanUrl</span><span class="token punctuation">(</span>url<span class="token punctuation">)</span>
    <span class="token comment">// map 类型资源请求处理</span>
    <span class="token keyword">try</span> <span class="token punctuation">{</span>
      <span class="token keyword">const</span> isSourceMap <span class="token operator">=</span> withoutQuery<span class="token punctuation">.</span><span class="token function">endsWith</span><span class="token punctuation">(</span><span class="token string">'.map'</span><span class="token punctuation">)</span>
      <span class="token comment">// since we generate source map references, handle those requests here</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>isSourceMap<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">const</span> originalUrl <span class="token operator">=</span> url<span class="token punctuation">.</span><span class="token function">replace</span><span class="token punctuation">(</span><span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">\.map($|\?)</span><span class="token regex-delimiter">/</span></span><span class="token punctuation">,</span> <span class="token string">'$1'</span><span class="token punctuation">)</span>
        <span class="token keyword">const</span> map <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">await</span> <span class="token keyword">module</span>Graph<span class="token punctuation">.</span><span class="token function">getModuleByUrl</span><span class="token punctuation">(</span>originalUrl<span class="token punctuation">)</span><span class="token punctuation">)</span>
          <span class="token operator">?.</span>transformResult<span class="token operator">?.</span>map
        <span class="token keyword">if</span> <span class="token punctuation">(</span>map<span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token keyword">return</span> <span class="token function">send</span><span class="token punctuation">(</span>req<span class="token punctuation">,</span> res<span class="token punctuation">,</span> <span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">stringify</span><span class="token punctuation">(</span>map<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">'json'</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
          <span class="token keyword">return</span> <span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span>
      <span class="token comment">// 静态文件夹 /public/ 处理</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>url<span class="token punctuation">.</span><span class="token function">startsWith</span><span class="token punctuation">(</span><span class="token string">'/public/'</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        logger<span class="token punctuation">.</span><span class="token function">warn</span><span class="token punctuation">(</span>
          chalk<span class="token punctuation">.</span><span class="token function">yellow</span><span class="token punctuation">(</span>
            <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">files in the public directory are served at the root path.\n</span><span class="token template-punctuation string">`</span></span> <span class="token operator">+</span>
              <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">Instead of </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>chalk<span class="token punctuation">.</span><span class="token function">cyan</span><span class="token punctuation">(</span>url<span class="token punctuation">)</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">, use </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>chalk<span class="token punctuation">.</span><span class="token function">cyan</span><span class="token punctuation">(</span>
                url<span class="token punctuation">.</span><span class="token function">replace</span><span class="token punctuation">(</span><span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">^\/public\/</span><span class="token regex-delimiter">/</span></span><span class="token punctuation">,</span> <span class="token string">'/'</span><span class="token punctuation">)</span>
              <span class="token punctuation">)</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">.</span><span class="token template-punctuation string">`</span></span>
          <span class="token punctuation">)</span>
        <span class="token punctuation">)</span>
      <span class="token punctuation">}</span>
      <span class="token comment">// js / import / css / html-proxy 请求</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>
        <span class="token function">isJSRequest</span><span class="token punctuation">(</span>url<span class="token punctuation">)</span> <span class="token operator">||</span>
        <span class="token function">isImportRequest</span><span class="token punctuation">(</span>url<span class="token punctuation">)</span> <span class="token operator">||</span>
        <span class="token function">isCSSRequest</span><span class="token punctuation">(</span>url<span class="token punctuation">)</span> <span class="token operator">||</span>
        <span class="token function">isHTMLProxy</span><span class="token punctuation">(</span>url<span class="token punctuation">)</span>
      <span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// 移除 ?import</span>
        url <span class="token operator">=</span> <span class="token function">removeImportQuery</span><span class="token punctuation">(</span>url<span class="token punctuation">)</span>
        url <span class="token operator">=</span> <span class="token function">unwrapId</span><span class="token punctuation">(</span>url<span class="token punctuation">)</span>
        <span class="token comment">// 对于 CSS, 我们需要区分正常 CSS请求 和 import请求</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isCSSRequest</span><span class="token punctuation">(</span>url<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> req<span class="token punctuation">.</span>headers<span class="token punctuation">.</span>accept<span class="token operator">?.</span><span class="token function">includes</span><span class="token punctuation">(</span><span class="token string">'text/css'</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
          url <span class="token operator">=</span> <span class="token function">injectQuery</span><span class="token punctuation">(</span>url<span class="token punctuation">,</span> <span class="token string">'direct'</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
        <span class="token comment">// 304 缓存</span>
        <span class="token keyword">const</span> ifNoneMatch <span class="token operator">=</span> req<span class="token punctuation">.</span>headers<span class="token punctuation">[</span><span class="token string">'if-none-match'</span><span class="token punctuation">]</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>
          ifNoneMatch <span class="token operator">&amp;&amp;</span>
          <span class="token punctuation">(</span><span class="token keyword">await</span> <span class="token keyword">module</span>Graph<span class="token punctuation">.</span><span class="token function">getModuleByUrl</span><span class="token punctuation">(</span>url<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token operator">?.</span>transformResult<span class="token operator">?.</span>etag <span class="token operator">===</span>
            ifNoneMatch
        <span class="token punctuation">)</span> <span class="token punctuation">{</span>
          isDebug <span class="token operator">&amp;&amp;</span> <span class="token function">debugCache</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">[304] </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span><span class="token function">prettifyUrl</span><span class="token punctuation">(</span>url<span class="token punctuation">,</span> root<span class="token punctuation">)</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span>
          res<span class="token punctuation">.</span>statusCode <span class="token operator">=</span> <span class="token number">304</span>
          <span class="token keyword">return</span> res<span class="token punctuation">.</span><span class="token function">end</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span>

        <span class="token comment">// 利用 PluginContainer 加载和转化资源内容, 调用 transformRequest 函数处理</span>
        <span class="token keyword">const</span> result <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token function">transformRequest</span><span class="token punctuation">(</span>url<span class="token punctuation">,</span> server<span class="token punctuation">,</span> <span class="token punctuation">{</span>
          html<span class="token operator">:</span> req<span class="token punctuation">.</span>headers<span class="token punctuation">.</span>accept<span class="token operator">?.</span><span class="token function">includes</span><span class="token punctuation">(</span><span class="token string">'text/html'</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>result<span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token keyword">const</span> type <span class="token operator">=</span> <span class="token function">isDirectCSSRequest</span><span class="token punctuation">(</span>url<span class="token punctuation">)</span> <span class="token operator">?</span> <span class="token string">'css'</span> <span class="token operator">:</span> <span class="token string">'js'</span>
          <span class="token keyword">const</span> isDep <span class="token operator">=</span>
            <span class="token constant">DEP_VERSION_RE</span><span class="token punctuation">.</span><span class="token function">test</span><span class="token punctuation">(</span>url<span class="token punctuation">)</span> <span class="token operator">||</span>
            url<span class="token punctuation">.</span><span class="token function">includes</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">node_modules/</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span><span class="token constant">DEP_CACHE_DIR</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span>
          <span class="token keyword">return</span> <span class="token function">send</span><span class="token punctuation">(</span>
            req<span class="token punctuation">,</span>
            res<span class="token punctuation">,</span>
            result<span class="token punctuation">.</span>code<span class="token punctuation">,</span>
            type<span class="token punctuation">,</span>
            result<span class="token punctuation">.</span>etag<span class="token punctuation">,</span>
            <span class="token comment">// 允许浏览器缓存 npm 依赖</span>
            isDep <span class="token operator">?</span> <span class="token string">'max-age=31536000,immutable'</span> <span class="token operator">:</span> <span class="token string">'no-cache'</span><span class="token punctuation">,</span>
            result<span class="token punctuation">.</span>map
          <span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">return</span> <span class="token function">next</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
    <span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br><span class="line-number">65</span><br><span class="line-number">66</span><br><span class="line-number">67</span><br><span class="line-number">68</span><br><span class="line-number">69</span><br><span class="line-number">70</span><br><span class="line-number">71</span><br><span class="line-number">72</span><br><span class="line-number">73</span><br><span class="line-number">74</span><br><span class="line-number">75</span><br><span class="line-number">76</span><br><span class="line-number">77</span><br><span class="line-number">78</span><br><span class="line-number">79</span><br><span class="line-number">80</span><br><span class="line-number">81</span><br><span class="line-number">82</span><br><span class="line-number">83</span><br><span class="line-number">84</span><br><span class="line-number">85</span><br><span class="line-number">86</span><br><span class="line-number">87</span><br><span class="line-number">88</span><br><span class="line-number">89</span><br><span class="line-number">90</span><br><span class="line-number">91</span><br><span class="line-number">92</span><br><span class="line-number">93</span><br><span class="line-number">94</span><br><span class="line-number">95</span><br><span class="line-number">96</span><br><span class="line-number">97</span><br><span class="line-number">98</span><br><span class="line-number">99</span><br><span class="line-number">100</span><br><span class="line-number">101</span><br><span class="line-number">102</span><br><span class="line-number">103</span><br><span class="line-number">104</span><br><span class="line-number">105</span><br><span class="line-number">106</span><br><span class="line-number">107</span><br><span class="line-number">108</span><br><span class="line-number">109</span><br><span class="line-number">110</span><br><span class="line-number">111</span><br></div></div><p>transformMiddleware 中间件的主要逻辑有以下部分:</p> <ul><li>reload 时的兼容处理</li> <li>map 类型资源请求处理</li> <li>public 静态文件夹资源处理</li> <li>js / import / css / html-proxy 资源请求处理</li></ul> <p>其中我们需要重点关注 js / import / css / html-proxy 资源请求处理, 包括其中的 transformRequest 函数的逻辑和调用.</p> <p>我们现在都知道大部分的资源的内容转化都是调用 transformRequest 函数来实现的, 那么我们来看一下这个函数的内部实现:</p> <div class="language-ts line-numbers-mode"><pre class="language-ts"><code><span class="token keyword">export</span> <span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token function">transformRequest</span><span class="token punctuation">(</span>
  url<span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">,</span>
  <span class="token punctuation">{</span> config<span class="token punctuation">,</span> pluginContainer<span class="token punctuation">,</span> <span class="token keyword">module</span>Graph<span class="token punctuation">,</span> watcher <span class="token punctuation">}</span><span class="token operator">:</span> ViteDevServer<span class="token punctuation">,</span>
  options<span class="token operator">:</span> TransformOptions <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
<span class="token punctuation">)</span><span class="token operator">:</span> <span class="token builtin">Promise</span><span class="token operator">&lt;</span>TransformResult <span class="token operator">|</span> <span class="token keyword">null</span><span class="token operator">&gt;</span> <span class="token punctuation">{</span>
  <span class="token comment">// 1.检测命中缓存</span>
  <span class="token comment">// 2.利用PluginContainer的resolveId方法调用所有插件的resolveId钩子函数处理url,得到id</span>
  <span class="token comment">// 3.利用PluginContainer的load方法调用所有插件的load钩子函数, 加载资源内容</span>
  <span class="token comment">// 4.利用PluginContainer的transform方法调用所有插件的transform钩子函数处理code</span>
  <span class="token comment">// 5.返回转化结果</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br></div></div><p>首先我们根据代码逻辑, 总结出了上面所述的转换的流程, 下面我们一步步的来分析整个流程.</p> <h3 id="检测命中缓存"><a href="#检测命中缓存" class="header-anchor">#</a> 检测命中缓存</h3> <p>代码如下:</p> <div class="language-ts line-numbers-mode"><pre class="language-ts"><code><span class="token keyword">export</span> <span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token function">transformRequest</span><span class="token punctuation">(</span>
  url<span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">,</span>
  <span class="token punctuation">{</span> config<span class="token punctuation">,</span> pluginContainer<span class="token punctuation">,</span> <span class="token keyword">module</span>Graph<span class="token punctuation">,</span> watcher <span class="token punctuation">}</span><span class="token operator">:</span> ViteDevServer<span class="token punctuation">,</span>
  options<span class="token operator">:</span> TransformOptions <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
<span class="token punctuation">)</span><span class="token operator">:</span> <span class="token builtin">Promise</span><span class="token operator">&lt;</span>TransformResult <span class="token operator">|</span> <span class="token keyword">null</span><span class="token operator">&gt;</span> <span class="token punctuation">{</span>
  <span class="token comment">// 移除url中的时间戳</span>
  url <span class="token operator">=</span> <span class="token function">removeTimestampQuery</span><span class="token punctuation">(</span>url<span class="token punctuation">)</span>
  <span class="token keyword">const</span> <span class="token punctuation">{</span> root<span class="token punctuation">,</span> logger <span class="token punctuation">}</span> <span class="token operator">=</span> config
  <span class="token keyword">const</span> prettyUrl <span class="token operator">=</span> isDebug <span class="token operator">?</span> <span class="token function">prettifyUrl</span><span class="token punctuation">(</span>url<span class="token punctuation">,</span> root<span class="token punctuation">)</span> <span class="token operator">:</span> <span class="token string">''</span>
  <span class="token keyword">const</span> ssr <span class="token operator">=</span> <span class="token operator">!</span><span class="token operator">!</span>options<span class="token punctuation">.</span>ssr
  <span class="token comment">// 根据 url, 从 moduleGraph 中试图获取 module</span>
  <span class="token keyword">const</span> module <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token keyword">module</span>Graph<span class="token punctuation">.</span><span class="token function">getModuleByUrl</span><span class="token punctuation">(</span>url<span class="token punctuation">)</span>
  <span class="token keyword">const</span> cached <span class="token operator">=</span>
    module <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span>ssr <span class="token operator">?</span> module<span class="token punctuation">.</span>ssrTransformResult <span class="token operator">:</span> module<span class="token punctuation">.</span>transformResult<span class="token punctuation">)</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>cached<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    isDebug <span class="token operator">&amp;&amp;</span> <span class="token function">debugCache</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">[memory] </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>prettyUrl<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span>
    <span class="token keyword">return</span> cached
  <span class="token punctuation">}</span>
  <span class="token comment">// ...</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br></div></div><p>这部分的逻辑很简单, 就是根据 url, 从 moduleGraph 中试图获取 module, 如果module存在, 从中获取 transformResult, 并返回.</p> <p>若没有命中缓存, 则跳过if判断, 向下执行. 并且在 load 执行之后再将其放入 moduleGraph 中. 这里的代码有个小技巧:</p> <div class="language-ts line-numbers-mode"><pre class="language-ts"><code><span class="token comment">// packages/vite/src/node/server/transformRequest.ts</span>

<span class="token keyword">const</span> mod <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token keyword">module</span>Graph<span class="token punctuation">.</span><span class="token function">ensureEntryFromUrl</span><span class="token punctuation">(</span>url<span class="token punctuation">)</span>
<span class="token function">ensureWatchedFile</span><span class="token punctuation">(</span>watcher<span class="token punctuation">,</span> mod<span class="token punctuation">.</span>file<span class="token punctuation">,</span> root<span class="token punctuation">)</span>

<span class="token comment">// packages/vite/src/node/server/moduleGraph.ts</span>

<span class="token keyword">async</span> <span class="token function">ensureEntryFromUrl</span><span class="token punctuation">(</span>rawUrl<span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> <span class="token punctuation">[</span>url<span class="token punctuation">,</span> resolvedId<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">resolveUrl</span><span class="token punctuation">(</span>rawUrl<span class="token punctuation">)</span>
  <span class="token keyword">let</span> mod <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>urlToModuleMap<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>url<span class="token punctuation">)</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>mod<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    mod <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ModuleNode</span><span class="token punctuation">(</span>url<span class="token punctuation">)</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>urlToModuleMap<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>url<span class="token punctuation">,</span> mod<span class="token punctuation">)</span>
    mod<span class="token punctuation">.</span>id <span class="token operator">=</span> resolvedId
    <span class="token keyword">this</span><span class="token punctuation">.</span>idToModuleMap<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>resolvedId<span class="token punctuation">,</span> mod<span class="token punctuation">)</span>
    <span class="token keyword">const</span> file <span class="token operator">=</span> <span class="token punctuation">(</span>mod<span class="token punctuation">.</span>file <span class="token operator">=</span> <span class="token function">cleanUrl</span><span class="token punctuation">(</span>resolvedId<span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token keyword">let</span> fileMappedModules <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>fileToModulesMap<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>file<span class="token punctuation">)</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>fileMappedModules<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      fileMappedModules <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Set</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span>fileToModulesMap<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>file<span class="token punctuation">,</span> fileMappedModules<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
    fileMappedModules<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>mod<span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">return</span> mod
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br></div></div><p>ensureEntryFromUrl 方法会返回 mod 实例引用, 之后对于 mod 实例引用的属性的添加修改, 也就是对 idToModuleMap 中的 mod 进行修改.</p> <p>不用等到 mod 装配完毕后再将其放入 moduleGraph 对象中的 idToModuleMap 中.</p> <p>举个例子:</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">class</span> <span class="token class-name">ModuleNode</span> <span class="token punctuation">{</span>
  <span class="token function">constructor</span><span class="token punctuation">(</span><span class="token parameter">url</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>url <span class="token operator">=</span> url
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">class</span> <span class="token class-name">ModuleGraph</span> <span class="token punctuation">{</span>
  <span class="token function">constructor</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>urlToModuleMap <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Map</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
  <span class="token function">ensureEntryFromUrl</span><span class="token punctuation">(</span><span class="token parameter">url</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token keyword">let</span> mod <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>urlToModuleMap<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>url<span class="token punctuation">)</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span>mod<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      mod <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ModuleNode</span><span class="token punctuation">(</span>url<span class="token punctuation">)</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span>urlToModuleMap<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>url<span class="token punctuation">,</span> mod<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> mod
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">const</span> moduleGraph <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ModuleGraph</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> mod <span class="token operator">=</span> moduleGraph<span class="token punctuation">.</span><span class="token function">ensureEntryFromUrl</span><span class="token punctuation">(</span><span class="token string">&quot;xxxxx&quot;</span><span class="token punctuation">)</span>
mod<span class="token punctuation">.</span>transfromResult <span class="token operator">=</span> <span class="token punctuation">{</span>code<span class="token operator">:</span> <span class="token string">&quot;yyyyyyy&quot;</span><span class="token punctuation">}</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>moduleGraph<span class="token punctuation">.</span>urlToModuleMap<span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br></div></div><p>其中 23 行的添加, 都会体现在 urlToModuleMap 中.</p> <h3 id="resolveid-钩子函数处理-url"><a href="#resolveid-钩子函数处理-url" class="header-anchor">#</a> resolveId 钩子函数处理 url</h3> <p>这部分逻辑则是统一调用插件的 resolveId 钩子函数, 处理url, 使其转换为id.</p> <div class="language-ts line-numbers-mode"><pre class="language-ts"><code><span class="token keyword">const</span> id <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">await</span> pluginContainer<span class="token punctuation">.</span><span class="token function">resolveId</span><span class="token punctuation">(</span>url<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token operator">?.</span>id <span class="token operator">||</span> url
<span class="token keyword">const</span> file <span class="token operator">=</span> <span class="token function">cleanUrl</span><span class="token punctuation">(</span>id<span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><h3 id="load-钩子函数加载资源"><a href="#load-钩子函数加载资源" class="header-anchor">#</a> load 钩子函数加载资源</h3> <div class="language-ts line-numbers-mode"><pre class="language-ts"><code><span class="token keyword">let</span> code<span class="token operator">:</span> <span class="token builtin">string</span> <span class="token operator">|</span> <span class="token keyword">null</span> <span class="token operator">=</span> <span class="token keyword">null</span>
<span class="token keyword">let</span> map<span class="token operator">:</span> SourceDescription<span class="token punctuation">[</span><span class="token string">'map'</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token keyword">null</span>

<span class="token keyword">const</span> loadResult <span class="token operator">=</span> <span class="token keyword">await</span> pluginContainer<span class="token punctuation">.</span><span class="token function">load</span><span class="token punctuation">(</span>id<span class="token punctuation">,</span> ssr<span class="token punctuation">)</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span>loadResult <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>options<span class="token punctuation">.</span>html <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>id<span class="token punctuation">.</span><span class="token function">endsWith</span><span class="token punctuation">(</span><span class="token string">'.html'</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token keyword">null</span>
  <span class="token punctuation">}</span>
  <span class="token comment">// ...</span>
  code <span class="token operator">=</span> <span class="token keyword">await</span> fs<span class="token punctuation">.</span><span class="token function">readFile</span><span class="token punctuation">(</span>file<span class="token punctuation">,</span> <span class="token string">'utf-8'</span><span class="token punctuation">)</span>
  <span class="token comment">// ...</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>code<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    map <span class="token operator">=</span> <span class="token punctuation">(</span>
      convertSourceMap<span class="token punctuation">.</span><span class="token function">fromSource</span><span class="token punctuation">(</span>code<span class="token punctuation">)</span> <span class="token operator">||</span>
      convertSourceMap<span class="token punctuation">.</span><span class="token function">fromMapFileSource</span><span class="token punctuation">(</span>code<span class="token punctuation">,</span> path<span class="token punctuation">.</span><span class="token function">dirname</span><span class="token punctuation">(</span>file<span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">)</span><span class="token operator">?.</span><span class="token function">toObject</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">typeof</span> loadResult <span class="token operator">===</span> <span class="token string">'object'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    code <span class="token operator">=</span> loadResult<span class="token punctuation">.</span>code
    map <span class="token operator">=</span> loadResult<span class="token punctuation">.</span>map
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
    code <span class="token operator">=</span> loadResult
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span>code <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">checkPublicFile</span><span class="token punctuation">(</span>url<span class="token punctuation">,</span> config<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 资源引用报错</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token keyword">null</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br></div></div><p>这里逻辑分为两部分:</p> <ul><li>若 pluginContainer.load 方法返回 loadResult, 则直接将其code属性值赋给code变量, map属性值赋给map变量.</li> <li>若返回值 loadResult 为 null, 则从根据 file 变量读取文件, 并将其赋给 code 值. map 值则是根据 code 生成.</li></ul> <h3 id="transform-钩子函数处理-code"><a href="#transform-钩子函数处理-code" class="header-anchor">#</a> transform 钩子函数处理 code</h3> <p>先看代码:</p> <div class="language-ts line-numbers-mode"><pre class="language-ts"><code><span class="token keyword">const</span> transformResult <span class="token operator">=</span> <span class="token keyword">await</span> pluginContainer<span class="token punctuation">.</span><span class="token function">transform</span><span class="token punctuation">(</span>code<span class="token punctuation">,</span> id<span class="token punctuation">,</span> map<span class="token punctuation">,</span> ssr<span class="token punctuation">)</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span>
  transformResult <span class="token operator">==</span> <span class="token keyword">null</span> <span class="token operator">||</span>
  <span class="token punctuation">(</span><span class="token keyword">typeof</span> transformResult <span class="token operator">===</span> <span class="token string">'object'</span> <span class="token operator">&amp;&amp;</span> transformResult<span class="token punctuation">.</span>code <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span>
<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// 没有 transform 钩子函数被应用, 保持原样</span>
<span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
  code <span class="token operator">=</span> transformResult<span class="token punctuation">.</span>code<span class="token operator">!</span>
  map <span class="token operator">=</span> transformResult<span class="token punctuation">.</span>map
<span class="token punctuation">}</span>

<span class="token keyword">if</span> <span class="token punctuation">(</span>map <span class="token operator">&amp;&amp;</span> mod<span class="token punctuation">.</span>file<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  map <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">typeof</span> map <span class="token operator">===</span> <span class="token string">'string'</span> <span class="token operator">?</span> <span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">parse</span><span class="token punctuation">(</span>map<span class="token punctuation">)</span> <span class="token operator">:</span> map<span class="token punctuation">)</span> <span class="token keyword">as</span> SourceMap
  <span class="token keyword">if</span> <span class="token punctuation">(</span>map<span class="token punctuation">.</span>mappings <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>map<span class="token punctuation">.</span>sourcesContent<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">await</span> <span class="token function">injectSourcesContent</span><span class="token punctuation">(</span>map<span class="token punctuation">,</span> mod<span class="token punctuation">.</span>file<span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br></div></div><p>其实这段代码的逻辑也很简单, 调用 pluginContainer.transform 方法, 得到返回值, 判断是否经过了转换, 并根据转换的结果替换 code 和 map .</p> <p>最后组装 transformResult , 并返回结果.</p> <div class="language-ts line-numbers-mode"><pre class="language-ts"><code><span class="token keyword">return</span> <span class="token punctuation">(</span>mod<span class="token punctuation">.</span>transformResult <span class="token operator">=</span> <span class="token punctuation">{</span>
  code<span class="token punctuation">,</span>
  map<span class="token punctuation">,</span>
  etag<span class="token operator">:</span> <span class="token function">getEtag</span><span class="token punctuation">(</span>code<span class="token punctuation">,</span> <span class="token punctuation">{</span> weak<span class="token operator">:</span> <span class="token boolean">true</span> <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span> <span class="token keyword">as</span> TransformResult<span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><h2 id="vite-2-0-的插件机制"><a href="#vite-2-0-的插件机制" class="header-anchor">#</a> vite 2.0 的插件机制</h2> <p>上面讲 transfromMiddleware 中间件时, 提到了他的核心就是依次调用插件的钩子函数, 最终得到转化的结果. 那么我们来了解 vite 2.0 的插件机制. 他是如何加载及如何调用的.</p> <p>首先我们先看一下 Plugin 的类型声明:</p> <div class="language-ts line-numbers-mode"><pre class="language-ts"><code><span class="token comment">/**
 * Vite 插件继承自 Rollup 插件, 并在基础上扩展了几个 vite 特有的选项.
 */</span>
<span class="token keyword">export</span> <span class="token keyword">interface</span> <span class="token class-name">Plugin</span> <span class="token keyword">extends</span> <span class="token class-name">RollupPlugin</span> <span class="token punctuation">{</span>
  <span class="token comment">/**
   * 强调插件的调用顺序选项
   *
   * 插件调用顺序如下:
   * - 别名解析(alias resolution)
   * - enforce 选项为 pre 的插件
   * - vite 核心插件
   * - 正常插件
   * - vite 构建插件
   * - enforce 选项为 post 的插件
   * - vite build post plugins
   */</span>
  enforce<span class="token operator">?</span><span class="token operator">:</span> <span class="token string">'pre'</span> <span class="token operator">|</span> <span class="token string">'post'</span>
  <span class="token comment">/**
   * 插件只应用在serve或者build
   */</span>
  apply<span class="token operator">?</span><span class="token operator">:</span> <span class="token string">'serve'</span> <span class="token operator">|</span> <span class="token string">'build'</span>
  <span class="token comment">/**
   * config 钩子函数, 调用前修改vite配置
   */</span>
  config<span class="token operator">?</span><span class="token operator">:</span> <span class="token punctuation">(</span>config<span class="token operator">:</span> UserConfig<span class="token punctuation">,</span> env<span class="token operator">:</span> ConfigEnv<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> UserConfig <span class="token operator">|</span> <span class="token keyword">null</span> <span class="token operator">|</span> <span class="token keyword">void</span>
  <span class="token comment">/**
   * configResolved 钩子函数, 读取并存储最终的已解析 Vite 配置。
   */</span>
  configResolved<span class="token operator">?</span><span class="token operator">:</span> <span class="token punctuation">(</span>config<span class="token operator">:</span> ResolvedConfig<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token keyword">void</span>
  <span class="token comment">/**
   * 配置 vite server, 这个钩子函数接受一个 ViteDevServer 实例
   */</span>
  configureServer<span class="token operator">?</span><span class="token operator">:</span> <span class="token punctuation">(</span>
    server<span class="token operator">:</span> ViteDevServer
  <span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token keyword">void</span><span class="token punctuation">)</span> <span class="token operator">|</span> <span class="token keyword">void</span> <span class="token operator">|</span> <span class="token builtin">Promise</span><span class="token operator">&lt;</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token keyword">void</span><span class="token punctuation">)</span> <span class="token operator">|</span> <span class="token keyword">void</span><span class="token operator">&gt;</span>
  <span class="token comment">/**
   * 转换 index.html
   */</span>
  transformIndexHtml<span class="token operator">?</span><span class="token operator">:</span> IndexHtmlTransform
  <span class="token comment">/**
   * 执行 HMR更新 的自定义处理
   */</span>
  handleHotUpdate<span class="token operator">?</span><span class="token punctuation">(</span>
    ctx<span class="token operator">:</span> HmrContext
  <span class="token punctuation">)</span><span class="token operator">:</span> <span class="token builtin">Array</span><span class="token operator">&lt;</span>ModuleNode<span class="token operator">&gt;</span> <span class="token operator">|</span> <span class="token keyword">void</span> <span class="token operator">|</span> <span class="token builtin">Promise</span><span class="token operator">&lt;</span><span class="token builtin">Array</span><span class="token operator">&lt;</span>ModuleNode<span class="token operator">&gt;</span> <span class="token operator">|</span> <span class="token keyword">void</span><span class="token operator">&gt;</span>

  <span class="token comment">/**
   * 为下面的钩子函数签名添加ssr参数
   */</span>
  resolveId<span class="token operator">?</span><span class="token punctuation">(</span>
    <span class="token keyword">this</span><span class="token operator">:</span> PluginContext<span class="token punctuation">,</span>
    source<span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">,</span>
    importer<span class="token operator">:</span> <span class="token builtin">string</span> <span class="token operator">|</span> <span class="token keyword">undefined</span><span class="token punctuation">,</span>
    options<span class="token operator">:</span> <span class="token punctuation">{</span> custom<span class="token operator">?</span><span class="token operator">:</span> CustomPluginOptions <span class="token punctuation">}</span><span class="token punctuation">,</span>
    ssr<span class="token operator">?</span><span class="token operator">:</span> <span class="token builtin">boolean</span>
  <span class="token punctuation">)</span><span class="token operator">:</span> <span class="token builtin">Promise</span><span class="token operator">&lt;</span>ResolveIdResult<span class="token operator">&gt;</span> <span class="token operator">|</span> ResolveIdResult
  load<span class="token operator">?</span><span class="token punctuation">(</span>
    <span class="token keyword">this</span><span class="token operator">:</span> PluginContext<span class="token punctuation">,</span>
    id<span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">,</span>
    ssr<span class="token operator">?</span><span class="token operator">:</span> <span class="token builtin">boolean</span>
  <span class="token punctuation">)</span><span class="token operator">:</span> <span class="token builtin">Promise</span><span class="token operator">&lt;</span>LoadResult<span class="token operator">&gt;</span> <span class="token operator">|</span> LoadResult
  transform<span class="token operator">?</span><span class="token punctuation">(</span>
    <span class="token keyword">this</span><span class="token operator">:</span> TransformPluginContext<span class="token punctuation">,</span>
    code<span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">,</span>
    id<span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">,</span>
    ssr<span class="token operator">?</span><span class="token operator">:</span> <span class="token builtin">boolean</span>
  <span class="token punctuation">)</span><span class="token operator">:</span> <span class="token builtin">Promise</span><span class="token operator">&lt;</span>TransformResult<span class="token operator">&gt;</span> <span class="token operator">|</span> TransformResult
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br><span class="line-number">65</span><br><span class="line-number">66</span><br><span class="line-number">67</span><br><span class="line-number">68</span><br></div></div><p>我们了解了 Vite Plugin 与 Rollup Plugin 的区别, 我们现在来看 Plugin 在 Vite 中是如何加载的.</p> <h3 id="加载插件"><a href="#加载插件" class="header-anchor">#</a> 加载插件</h3> <p>首先用户插件是在 resolveConfig 函数调用时, 进行处理的:</p> <div class="language-ts line-numbers-mode"><pre class="language-ts"><code><span class="token comment">// packages/vite/src/node/config.ts -&gt; function resolveConfig</span>

<span class="token keyword">const</span> rawUserPlugins <span class="token operator">=</span> <span class="token punctuation">(</span>config<span class="token punctuation">.</span>plugins <span class="token operator">||</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">flat</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">filter</span><span class="token punctuation">(</span><span class="token punctuation">(</span>p<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token operator">!</span>p<span class="token punctuation">.</span>apply <span class="token operator">||</span> p<span class="token punctuation">.</span>apply <span class="token operator">===</span> command
<span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token comment">// 根据 enforce 参数分类插件</span>
<span class="token keyword">const</span> <span class="token punctuation">[</span>prePlugins<span class="token punctuation">,</span> normalPlugins<span class="token punctuation">,</span> postPlugins<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">sortUserPlugins</span><span class="token punctuation">(</span>
  rawUserPlugins
<span class="token punctuation">)</span>

<span class="token comment">// 调用插件的 config 钩子方法</span>
<span class="token keyword">const</span> userPlugins <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token operator">...</span>prePlugins<span class="token punctuation">,</span> <span class="token operator">...</span>normalPlugins<span class="token punctuation">,</span> <span class="token operator">...</span>postPlugins<span class="token punctuation">]</span>
userPlugins<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token punctuation">(</span>p<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>p<span class="token punctuation">.</span>config<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> res <span class="token operator">=</span> p<span class="token punctuation">.</span><span class="token function">config</span><span class="token punctuation">(</span>config<span class="token punctuation">,</span> configEnv<span class="token punctuation">)</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>res<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      config <span class="token operator">=</span> <span class="token function">mergeConfig</span><span class="token punctuation">(</span>config<span class="token punctuation">,</span> res<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br></div></div><p>然后调用 resolvePlugins 方法, 对用户插件和内置插件进行组合:</p> <div class="language-ts line-numbers-mode"><pre class="language-ts"><code><span class="token comment">// packages/vite/src/node/config.ts -&gt; function resolveConfig</span>

<span class="token punctuation">;</span><span class="token punctuation">(</span>resolved <span class="token keyword">as</span> <span class="token builtin">any</span><span class="token punctuation">)</span><span class="token punctuation">.</span>plugins <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token function">resolvePlugins</span><span class="token punctuation">(</span>
  resolved<span class="token punctuation">,</span>
  prePlugins<span class="token punctuation">,</span>
  normalPlugins<span class="token punctuation">,</span>
  postPlugins
<span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br></div></div><p>下面我们看 resolvePlugins 函数的具体的实现:</p> <div class="language-ts line-numbers-mode"><pre class="language-ts"><code><span class="token comment">// packages/vite/src/node/plugins/index.ts</span>

<span class="token keyword">export</span> <span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token function">resolvePlugins</span><span class="token punctuation">(</span>
  config<span class="token operator">:</span> ResolvedConfig<span class="token punctuation">,</span>
  prePlugins<span class="token operator">:</span> Plugin<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
  normalPlugins<span class="token operator">:</span> Plugin<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
  postPlugins<span class="token operator">:</span> Plugin<span class="token punctuation">[</span><span class="token punctuation">]</span>
<span class="token punctuation">)</span><span class="token operator">:</span> <span class="token builtin">Promise</span><span class="token operator">&lt;</span>Plugin<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token operator">&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> isBuild <span class="token operator">=</span> config<span class="token punctuation">.</span>command <span class="token operator">===</span> <span class="token string">'build'</span>

  <span class="token keyword">const</span> buildPlugins <span class="token operator">=</span> isBuild
    <span class="token operator">?</span> <span class="token punctuation">(</span><span class="token keyword">await</span> <span class="token keyword">import</span><span class="token punctuation">(</span><span class="token string">'../build'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">resolveBuildPlugins</span><span class="token punctuation">(</span>config<span class="token punctuation">)</span>
    <span class="token operator">:</span> <span class="token punctuation">{</span> pre<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span> post<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token punctuation">}</span>

  <span class="token keyword">return</span> <span class="token punctuation">[</span>
    <span class="token comment">// </span>
    isBuild <span class="token operator">?</span> <span class="token keyword">null</span> <span class="token operator">:</span> <span class="token function">preAliasPlugin</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token function">aliasPlugin</span><span class="token punctuation">(</span><span class="token punctuation">{</span> entries<span class="token operator">:</span> config<span class="token punctuation">.</span>resolve<span class="token punctuation">.</span>alias <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token operator">...</span>prePlugins<span class="token punctuation">,</span>
    config<span class="token punctuation">.</span>build<span class="token punctuation">.</span>polyfillDynamicImport
      <span class="token operator">?</span> <span class="token function">dynamicImportPolyfillPlugin</span><span class="token punctuation">(</span>config<span class="token punctuation">)</span>
      <span class="token operator">:</span> <span class="token keyword">null</span><span class="token punctuation">,</span>
    <span class="token function">resolvePlugin</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
      <span class="token operator">...</span>config<span class="token punctuation">.</span>resolve<span class="token punctuation">,</span>
      root<span class="token operator">:</span> config<span class="token punctuation">.</span>root<span class="token punctuation">,</span>
      isProduction<span class="token operator">:</span> config<span class="token punctuation">.</span>isProduction<span class="token punctuation">,</span>
      isBuild<span class="token punctuation">,</span>
      asSrc<span class="token operator">:</span> <span class="token boolean">true</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token function">htmlInlineScriptProxyPlugin</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token function">cssPlugin</span><span class="token punctuation">(</span>config<span class="token punctuation">)</span><span class="token punctuation">,</span>
    config<span class="token punctuation">.</span>esbuild <span class="token operator">!==</span> <span class="token boolean">false</span> <span class="token operator">?</span> <span class="token function">esbuildPlugin</span><span class="token punctuation">(</span>config<span class="token punctuation">.</span>esbuild<span class="token punctuation">)</span> <span class="token operator">:</span> <span class="token keyword">null</span><span class="token punctuation">,</span>
    <span class="token function">jsonPlugin</span><span class="token punctuation">(</span>
      <span class="token punctuation">{</span>
        namedExports<span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
        <span class="token operator">...</span>config<span class="token punctuation">.</span>json
      <span class="token punctuation">}</span><span class="token punctuation">,</span>
      isBuild
    <span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token function">wasmPlugin</span><span class="token punctuation">(</span>config<span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token function">webWorkerPlugin</span><span class="token punctuation">(</span>config<span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token function">assetPlugin</span><span class="token punctuation">(</span>config<span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token operator">...</span>normalPlugins<span class="token punctuation">,</span>
    <span class="token function">definePlugin</span><span class="token punctuation">(</span>config<span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token function">cssPostPlugin</span><span class="token punctuation">(</span>config<span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token operator">...</span>buildPlugins<span class="token punctuation">.</span>pre<span class="token punctuation">,</span>
    <span class="token operator">...</span>postPlugins<span class="token punctuation">,</span>
    <span class="token operator">...</span>buildPlugins<span class="token punctuation">.</span>post<span class="token punctuation">,</span>
    <span class="token comment">// internal server-only plugins are always applied after everything else</span>
    <span class="token operator">...</span><span class="token punctuation">(</span>isBuild
      <span class="token operator">?</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
      <span class="token operator">:</span> <span class="token punctuation">[</span><span class="token function">clientInjectionsPlugin</span><span class="token punctuation">(</span>config<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">importAnalysisPlugin</span><span class="token punctuation">(</span>config<span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
  <span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">filter</span><span class="token punctuation">(</span>Boolean<span class="token punctuation">)</span> <span class="token keyword">as</span> Plugin<span class="token punctuation">[</span><span class="token punctuation">]</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br></div></div><p>可以看出, resolvePlugins 函数就是为了保持前面注释提到的插件的调用顺序.这里我们再看一下顺序:</p> <ul><li>别名解析(alias resolution)</li> <li>enforce 选项为 pre 的插件</li> <li>vite 核心插件</li> <li>正常插件(normal plugin)</li> <li>vite 构建插件</li> <li>enforce 选项为 post 的插件</li> <li>vite build post plugins</li></ul> <h3 id="调用插件"><a href="#调用插件" class="header-anchor">#</a> 调用插件</h3> <p>另外这里还有一点需要注意, 插件调用时, 并不是直接遍历插件数组, 然后调用其中的方法.</p> <p>大部分时候都是通过 PluginContainer 实例暴露的方法, 统一调用插件的相应的钩子方法:</p> <div class="language-ts line-numbers-mode"><pre class="language-ts"><code>  <span class="token keyword">const</span> container<span class="token operator">:</span> PluginContainer <span class="token operator">=</span> <span class="token punctuation">{</span>
    options<span class="token operator">:</span> <span class="token keyword">await</span> <span class="token punctuation">(</span><span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      <span class="token comment">// 调用插件的 options 钩子方法</span>
      <span class="token comment">//...</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token keyword">async</span> <span class="token function">buildStart</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// 调用插件的 buildStart 钩子方法</span>
      <span class="token comment">// ...</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token keyword">async</span> <span class="token function">resolveId</span><span class="token punctuation">(</span>rawId<span class="token punctuation">,</span> importer <span class="token operator">=</span> <span class="token function">join</span><span class="token punctuation">(</span>root<span class="token punctuation">,</span> <span class="token string">'index.html'</span><span class="token punctuation">)</span><span class="token punctuation">,</span> skips<span class="token punctuation">,</span> ssr<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// 调用插件的 resolveId 钩子方法</span>
      <span class="token comment">// ...</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token keyword">async</span> <span class="token function">load</span><span class="token punctuation">(</span>id<span class="token punctuation">,</span> ssr<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// 调用插件的 load 钩子方法</span>
      <span class="token comment">// ...</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token keyword">async</span> <span class="token function">transform</span><span class="token punctuation">(</span>code<span class="token punctuation">,</span> id<span class="token punctuation">,</span> inMap<span class="token punctuation">,</span> ssr<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// 调用插件的 transform 钩子方法</span>
      <span class="token comment">// ...</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token function">watchChange</span><span class="token punctuation">(</span>id<span class="token punctuation">,</span> event <span class="token operator">=</span> <span class="token string">'update'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// 调用插件的 watchChange 钩子方法</span>
      <span class="token comment">// ...</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token keyword">async</span> <span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// 调用插件的 buildEnd / closeBundle 钩子方法</span>
      <span class="token comment">// ...</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br></div></div><h2 id="vite-2-0-的热更新机制"><a href="#vite-2-0-的热更新机制" class="header-anchor">#</a> vite 2.0 的热更新机制</h2> <p>至于 vite 2.0 的 热更新机制, 本质上是通过 watcher 和 ws 来实现的. 其实这也是 HMR 通用的实现思路.</p> <p>首先我们要了解到 watcher 的作用是监控本地文件的变动, ws 则是在文件变动时, 将 payload 推送到浏览器端, 这就意味着浏览器端需要能接收到 WebSocket 推送, 并且能解析 payload.</p> <p>所以一个完整的 HMR 实现, 不光需要提供 server 端的逻辑, 还需要提供 client 端的逻辑代码.</p> <p>而 vite 会在入口的模块上自动的加入对 client 的导入, 并且其 import 请求会被 server 自动解析. 所以在开发阶段, 不需要我们手动导入.</p> <h3 id="启动-watcher"><a href="#启动-watcher" class="header-anchor">#</a> 启动 watcher</h3> <p>首先我们先看一下代码:</p> <div class="language-ts line-numbers-mode"><pre class="language-ts"><code><span class="token comment">// packages/vite/src/node/server/index.ts -&gt; function createServer</span>

<span class="token keyword">const</span> watcher <span class="token operator">=</span> chokidar<span class="token punctuation">.</span><span class="token function">watch</span><span class="token punctuation">(</span>path<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span>root<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>
  ignored<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">'**/node_modules/**'</span><span class="token punctuation">,</span> <span class="token string">'**/.git/**'</span><span class="token punctuation">,</span> <span class="token operator">...</span>ignored<span class="token punctuation">]</span><span class="token punctuation">,</span>
  ignoreInitial<span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
  ignorePermissionErrors<span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
  disableGlobbing<span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
  <span class="token operator">...</span>watchOptions
<span class="token punctuation">}</span><span class="token punctuation">)</span> <span class="token keyword">as</span> FSWatcher

<span class="token comment">// ...</span>
watcher<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">'change'</span><span class="token punctuation">,</span> <span class="token keyword">async</span> <span class="token punctuation">(</span>file<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  file <span class="token operator">=</span> <span class="token function">normalizePath</span><span class="token punctuation">(</span>file<span class="token punctuation">)</span>
  <span class="token comment">// invalidate module graph cache on file change</span>
  <span class="token keyword">module</span>Graph<span class="token punctuation">.</span><span class="token function">onFileChange</span><span class="token punctuation">(</span>file<span class="token punctuation">)</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>serverConfig<span class="token punctuation">.</span>hmr <span class="token operator">!==</span> <span class="token boolean">false</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">try</span> <span class="token punctuation">{</span>
      <span class="token keyword">await</span> <span class="token function">handleHMRUpdate</span><span class="token punctuation">(</span>file<span class="token punctuation">,</span> server<span class="token punctuation">)</span>
    <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>err<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      ws<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
        type<span class="token operator">:</span> <span class="token string">'error'</span><span class="token punctuation">,</span>
        err<span class="token operator">:</span> <span class="token function">prepareError</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>

watcher<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">'add'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span>file<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token function">handleFileAddUnlink</span><span class="token punctuation">(</span><span class="token function">normalizePath</span><span class="token punctuation">(</span>file<span class="token punctuation">)</span><span class="token punctuation">,</span> server<span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>

watcher<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">'unlink'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span>file<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token function">handleFileAddUnlink</span><span class="token punctuation">(</span><span class="token function">normalizePath</span><span class="token punctuation">(</span>file<span class="token punctuation">)</span><span class="token punctuation">,</span> server<span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br></div></div><p>其中这部分逻辑分为两步:</p> <ul><li>启动 watcher 服务, 这里的 watcher 服务则是使用 chokidar 模块创建的.</li> <li>绑定事件, 这里绑定了如下的事件:
<ul><li>change 事件, 监控文件变化</li> <li>add 事件, 监控新文件增加</li> <li>unlink 事件, 监控文件删除</li></ul></li></ul> <p>我们先看已存在文件修改时的情况, 这时会触发 change 事件时, 最终会调用 handleHMRUpdate 函数进行处理.</p> <div class="language-ts line-numbers-mode"><pre class="language-ts"><code><span class="token comment">// packages/vite/src/node/server/hmr.ts</span>

<span class="token keyword">export</span> <span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token function">handleHMRUpdate</span><span class="token punctuation">(</span>
  file<span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">,</span>
  server<span class="token operator">:</span> ViteDevServer
<span class="token punctuation">)</span><span class="token operator">:</span> <span class="token builtin">Promise</span><span class="token operator">&lt;</span><span class="token builtin">any</span><span class="token operator">&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> <span class="token punctuation">{</span> ws<span class="token punctuation">,</span> config<span class="token punctuation">,</span> <span class="token keyword">module</span>Graph <span class="token punctuation">}</span> <span class="token operator">=</span> server
  <span class="token keyword">const</span> shortFile <span class="token operator">=</span> <span class="token function">getShortName</span><span class="token punctuation">(</span>file<span class="token punctuation">,</span> config<span class="token punctuation">.</span>root<span class="token punctuation">)</span>
  <span class="token comment">// 配置文件或环境变量文件修改, restart server</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>file <span class="token operator">===</span> config<span class="token punctuation">.</span>configFile <span class="token operator">||</span> file<span class="token punctuation">.</span><span class="token function">endsWith</span><span class="token punctuation">(</span><span class="token string">'.env'</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// ...</span>
    <span class="token keyword">await</span> <span class="token function">restartServer</span><span class="token punctuation">(</span>server<span class="token punctuation">)</span>
    <span class="token keyword">return</span>
  <span class="token punctuation">}</span>

  <span class="token comment">// vite/dist/client/client.js 不支持 HMR</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>file<span class="token punctuation">.</span><span class="token function">startsWith</span><span class="token punctuation">(</span>normalizedClientDir<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    ws<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
      type<span class="token operator">:</span> <span class="token string">'full-reload'</span><span class="token punctuation">,</span>
      path<span class="token operator">:</span> <span class="token string">'*'</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token keyword">return</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">const</span> mods <span class="token operator">=</span> <span class="token keyword">module</span>Graph<span class="token punctuation">.</span><span class="token function">getModulesByFile</span><span class="token punctuation">(</span>file<span class="token punctuation">)</span>

  <span class="token comment">// 检查是否有插件想要执行自定义 HMR 处理</span>
  <span class="token keyword">const</span> timestamp <span class="token operator">=</span> Date<span class="token punctuation">.</span><span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token keyword">const</span> hmrContext<span class="token operator">:</span> HmrContext <span class="token operator">=</span> <span class="token punctuation">{</span>
    file<span class="token punctuation">,</span>
    timestamp<span class="token punctuation">,</span>
    <span class="token keyword">module</span>s<span class="token operator">:</span> mods <span class="token operator">?</span> <span class="token punctuation">[</span><span class="token operator">...</span>mods<span class="token punctuation">]</span> <span class="token operator">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
    <span class="token function-variable function">read</span><span class="token operator">:</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token function">readModifiedFile</span><span class="token punctuation">(</span>file<span class="token punctuation">)</span><span class="token punctuation">,</span>
    server
  <span class="token punctuation">}</span>

  <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">const</span> plugin <span class="token keyword">of</span> config<span class="token punctuation">.</span>plugins<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>plugin<span class="token punctuation">.</span>handleHotUpdate<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">const</span> filteredModules <span class="token operator">=</span> <span class="token keyword">await</span> plugin<span class="token punctuation">.</span><span class="token function">handleHotUpdate</span><span class="token punctuation">(</span>hmrContext<span class="token punctuation">)</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>filteredModules<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        hmrContext<span class="token punctuation">.</span><span class="token keyword">module</span>s <span class="token operator">=</span> filteredModules
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
  <span class="token comment">// 没有处理的模块</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>hmrContext<span class="token punctuation">.</span><span class="token keyword">module</span>s<span class="token punctuation">.</span>length<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// html 文件不支持 hmr</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>file<span class="token punctuation">.</span><span class="token function">endsWith</span><span class="token punctuation">(</span><span class="token string">'.html'</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// ...</span>
      ws<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
        type<span class="token operator">:</span> <span class="token string">'full-reload'</span><span class="token punctuation">,</span>
        path<span class="token operator">:</span> config<span class="token punctuation">.</span>server<span class="token punctuation">.</span>middlewareMode
          <span class="token operator">?</span> <span class="token string">'*'</span>
          <span class="token operator">:</span> <span class="token string">'/'</span> <span class="token operator">+</span> <span class="token function">normalizePath</span><span class="token punctuation">(</span>path<span class="token punctuation">.</span><span class="token function">relative</span><span class="token punctuation">(</span>config<span class="token punctuation">.</span>root<span class="token punctuation">,</span> file<span class="token punctuation">)</span><span class="token punctuation">)</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
      <span class="token comment">// loaded but not in the module graph, probably not js</span>
      <span class="token function">debugHmr</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">[no modules matched] </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>chalk<span class="token punctuation">.</span><span class="token function">dim</span><span class="token punctuation">(</span>shortFile<span class="token punctuation">)</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span>
  <span class="token punctuation">}</span>

  <span class="token function">updateModules</span><span class="token punctuation">(</span>shortFile<span class="token punctuation">,</span> hmrContext<span class="token punctuation">.</span><span class="token keyword">module</span>s<span class="token punctuation">,</span> timestamp<span class="token punctuation">,</span> server<span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br></div></div><p>handleHMRUpdate 函数逻辑分为四步:</p> <ul><li>配置文件或环境变量文件修改, restart server</li> <li>vite/dist/client/client.js 不支持 HMR, 全量重新加载(full-reload)</li> <li>依次执行 plugins 的 handleHotUpdate, 若没有处理的模块, 进行逻辑判断:
<ul><li>如果是 html 文件, 不支持 HMR, 全量重新加载(full-reload)</li> <li>否则不执行</li></ul></li> <li>如果有处理的模块, 则调用 updateModules 函数</li></ul> <h3 id="发送-payload"><a href="#发送-payload" class="header-anchor">#</a> 发送 payload</h3> <p>下面我们看下 updateModules 函数的定义:</p> <div class="language-ts line-numbers-mode"><pre class="language-ts"><code><span class="token comment">// packages/vite/src/node/server/hmr.ts</span>

<span class="token keyword">function</span> <span class="token function">updateModules</span><span class="token punctuation">(</span>
  file<span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">,</span>
  <span class="token keyword">module</span>s<span class="token operator">:</span> ModuleNode<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
  timestamp<span class="token operator">:</span> <span class="token builtin">number</span><span class="token punctuation">,</span>
  <span class="token punctuation">{</span> config<span class="token punctuation">,</span> ws <span class="token punctuation">}</span><span class="token operator">:</span> ViteDevServer
<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> updates<span class="token operator">:</span> Update<span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
  <span class="token keyword">const</span> invalidatedModules <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Set<span class="token operator">&lt;</span>ModuleNode<span class="token operator">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span>

  <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">const</span> mod <span class="token keyword">of</span> <span class="token keyword">module</span>s<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 设置边界</span>
    <span class="token keyword">const</span> boundaries <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Set<span class="token operator">&lt;</span><span class="token punctuation">{</span>
      boundary<span class="token operator">:</span> ModuleNode
      acceptedVia<span class="token operator">:</span> ModuleNode
    <span class="token punctuation">}</span><span class="token operator">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token comment">// 收集废弃的模块</span>
    <span class="token function">invalidate</span><span class="token punctuation">(</span>mod<span class="token punctuation">,</span> timestamp<span class="token punctuation">,</span> invalidatedModules<span class="token punctuation">)</span>
    <span class="token comment">// 传播更新, 判断是否存在 deadend</span>
    <span class="token keyword">const</span> hasDeadEnd <span class="token operator">=</span> <span class="token function">propagateUpdate</span><span class="token punctuation">(</span>mod<span class="token punctuation">,</span> timestamp<span class="token punctuation">,</span> boundaries<span class="token punctuation">)</span>
    <span class="token comment">// 存在 deadend, 全量重载</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>hasDeadEnd<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// ...</span>
      ws<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
        type<span class="token operator">:</span> <span class="token string">'full-reload'</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span>
      <span class="token keyword">return</span>
    <span class="token punctuation">}</span>
    <span class="token comment">// 不存在 deadend, 放入 updates 队列中</span>
    updates<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>
      <span class="token operator">...</span><span class="token punctuation">[</span><span class="token operator">...</span>boundaries<span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">{</span> boundary<span class="token punctuation">,</span> acceptedVia <span class="token punctuation">}</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">(</span><span class="token punctuation">{</span>
        type<span class="token operator">:</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>boundary<span class="token punctuation">.</span><span class="token keyword">type</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">-update</span><span class="token template-punctuation string">`</span></span> <span class="token keyword">as</span> Update<span class="token punctuation">[</span><span class="token string">'type'</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
        timestamp<span class="token punctuation">,</span>
        path<span class="token operator">:</span> boundary<span class="token punctuation">.</span>url<span class="token punctuation">,</span>
        acceptedPath<span class="token operator">:</span> acceptedVia<span class="token punctuation">.</span>url
      <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
  <span class="token comment">// 发送 payload</span>
  ws<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
    type<span class="token operator">:</span> <span class="token string">'update'</span><span class="token punctuation">,</span>
    updates
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br></div></div><p>在这段逻辑中, 我们需要注意两个点:</p> <ul><li>如何判断 deadend</li> <li>update 格式是什么</li></ul> <p>首先我们先看第一点: 如何判断deadend?</p> <div class="language-ts line-numbers-mode"><pre class="language-ts"><code><span class="token comment">// packages/vite/src/node/server/hmr.ts</span>

<span class="token keyword">function</span> <span class="token function">propagateUpdate</span><span class="token punctuation">(</span>
  node<span class="token operator">:</span> ModuleNode<span class="token punctuation">,</span>
  timestamp<span class="token operator">:</span> <span class="token builtin">number</span><span class="token punctuation">,</span>
  boundaries<span class="token operator">:</span> Set<span class="token operator">&lt;</span><span class="token punctuation">{</span>
    boundary<span class="token operator">:</span> ModuleNode
    acceptedVia<span class="token operator">:</span> ModuleNode
  <span class="token punctuation">}</span><span class="token operator">&gt;</span><span class="token punctuation">,</span>
  currentChain<span class="token operator">:</span> ModuleNode<span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">[</span>node<span class="token punctuation">]</span>
<span class="token punctuation">)</span><span class="token operator">:</span> <span class="token builtin">boolean</span> <span class="token comment">/* hasDeadEnd */</span> <span class="token punctuation">{</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>node<span class="token punctuation">.</span>isSelfAccepting<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    boundaries<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
      boundary<span class="token operator">:</span> node<span class="token punctuation">,</span>
      acceptedVia<span class="token operator">:</span> node
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token keyword">return</span> <span class="token boolean">false</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>node<span class="token punctuation">.</span>importers<span class="token punctuation">.</span>size<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token boolean">true</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">const</span> importer <span class="token keyword">of</span> node<span class="token punctuation">.</span>importers<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> subChain <span class="token operator">=</span> currentChain<span class="token punctuation">.</span><span class="token function">concat</span><span class="token punctuation">(</span>importer<span class="token punctuation">)</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>importer<span class="token punctuation">.</span>acceptedHmrDeps<span class="token punctuation">.</span><span class="token function">has</span><span class="token punctuation">(</span>node<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      boundaries<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
        boundary<span class="token operator">:</span> importer<span class="token punctuation">,</span>
        acceptedVia<span class="token operator">:</span> node
      <span class="token punctuation">}</span><span class="token punctuation">)</span>
      <span class="token keyword">continue</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>currentChain<span class="token punctuation">.</span><span class="token function">includes</span><span class="token punctuation">(</span>importer<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// circular deps is considered dead end</span>
      <span class="token keyword">return</span> <span class="token boolean">true</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">propagateUpdate</span><span class="token punctuation">(</span>importer<span class="token punctuation">,</span> timestamp<span class="token punctuation">,</span> boundaries<span class="token punctuation">,</span> subChain<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">return</span> <span class="token boolean">true</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">return</span> <span class="token boolean">false</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br></div></div><p>首先我们了解一下 importers 字段的含义, 这个字段表示引入这个模块的模块合集.</p> <p>所以有两种判断条件, 一是判断 importers 是否为空, 为空, 则表示deadend.</p> <p>二是遍历他的 importers , 判断是否存在循环依赖, 若存在循环依赖, 则就是 deadend.</p> <p>不存在 deadend 的话, 则组装 update , 并推入 updates 中, 其中 update 的格式如下:</p> <div class="language-ts line-numbers-mode"><pre class="language-ts"><code>updates<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>
  <span class="token operator">...</span><span class="token punctuation">[</span><span class="token operator">...</span>boundaries<span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">{</span> boundary<span class="token punctuation">,</span> acceptedVia <span class="token punctuation">}</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">(</span><span class="token punctuation">{</span>
    type<span class="token operator">:</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>boundary<span class="token punctuation">.</span><span class="token keyword">type</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">-update</span><span class="token template-punctuation string">`</span></span> <span class="token keyword">as</span> Update<span class="token punctuation">[</span><span class="token string">'type'</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
    timestamp<span class="token punctuation">,</span>
    path<span class="token operator">:</span> boundary<span class="token punctuation">.</span>url<span class="token punctuation">,</span>
    acceptedPath<span class="token operator">:</span> acceptedVia<span class="token punctuation">.</span>url
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br></div></div><p>首先需要 type 字段来判断更新类型, 这里一共有两种类型: css, js ; 其次需要 timestamp 时间戳字段; 再就是 path 字段, 表示引用者路径或者自身路径, 最后一个字段是 acceptedPath, 表示自身路径.</p> <h3 id="解析-payload"><a href="#解析-payload" class="header-anchor">#</a> 解析 payload</h3> <p>经过ws.send 方法, 将更新发送到 client , 那么这就需要解析 payload, 并进行更新了.</p> <p>首先我们看一下代码:</p> <div class="language-ts line-numbers-mode"><pre class="language-ts"><code><span class="token comment">// packages/vite/src/client/client.ts</span>

<span class="token keyword">const</span> socketProtocol <span class="token operator">=</span>
  __HMR_PROTOCOL__ <span class="token operator">||</span> <span class="token punctuation">(</span>location<span class="token punctuation">.</span>protocol <span class="token operator">===</span> <span class="token string">'https:'</span> <span class="token operator">?</span> <span class="token string">'wss'</span> <span class="token operator">:</span> <span class="token string">'ws'</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> socketHost <span class="token operator">=</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>__HMR_HOSTNAME__ <span class="token operator">||</span> location<span class="token punctuation">.</span>hostname<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">:</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>__HMR_PORT__<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span>
<span class="token keyword">const</span> socket <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">WebSocket</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>socketProtocol<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">://</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>socketHost<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">,</span> <span class="token string">'vite-hmr'</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> base <span class="token operator">=</span> __BASE__ <span class="token operator">||</span> <span class="token string">'/'</span>

socket<span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span><span class="token string">'message'</span><span class="token punctuation">,</span> <span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token punctuation">{</span> data <span class="token punctuation">}</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token function">handleMessage</span><span class="token punctuation">(</span><span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">parse</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br></div></div><p>首先的话, 需要确定协议, 然后创建 WebSocket 链接, 并且监听 message 事件. 并且在 message 事件方法中调用 handleMessage 函数解析 payload.</p> <p>那么看一下 handleMessage 函数的实现:</p> <div class="language-ts line-numbers-mode"><pre class="language-ts"><code><span class="token comment">// packages/vite/src/client/client.ts</span>

<span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token function">handleMessage</span><span class="token punctuation">(</span>payload<span class="token operator">:</span> HMRPayload<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">switch</span> <span class="token punctuation">(</span>payload<span class="token punctuation">.</span>type<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">case</span> <span class="token string">'connected'</span><span class="token operator">:</span>
      <span class="token comment">// 链接</span>
    <span class="token keyword">case</span> <span class="token string">'update'</span><span class="token operator">:</span>
      <span class="token comment">// 更新</span>
    <span class="token keyword">case</span> <span class="token string">'custom'</span><span class="token operator">:</span>
      <span class="token comment">// 自定义事件</span>
    <span class="token keyword">case</span> <span class="token string">'full-reload'</span><span class="token operator">:</span>
      <span class="token comment">// 全量重载</span>
    <span class="token keyword">case</span> <span class="token string">'prune'</span><span class="token operator">:</span>
      <span class="token comment">// 移除模块</span>
    <span class="token keyword">case</span> <span class="token string">'error'</span><span class="token operator">:</span>
      <span class="token comment">// 错误</span>
    <span class="token keyword">default</span><span class="token operator">:</span>
      <span class="token comment">// 默认</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br></div></div><p>我们看到 payload 一共有上述几种类型, 我们重点看 update 类型的 payload 解析.</p> <div class="language-ts line-numbers-mode"><pre class="language-ts"><code><span class="token keyword">if</span> <span class="token punctuation">(</span>isFirstUpdate <span class="token operator">&amp;&amp;</span> <span class="token function">hasErrorOverlay</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  window<span class="token punctuation">.</span>location<span class="token punctuation">.</span><span class="token function">reload</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token keyword">return</span>
<span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
  <span class="token function">clearErrorOverlay</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  isFirstUpdate <span class="token operator">=</span> <span class="token boolean">false</span>
<span class="token punctuation">}</span>
payload<span class="token punctuation">.</span>updates<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token punctuation">(</span>update<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>update<span class="token punctuation">.</span>type <span class="token operator">===</span> <span class="token string">'js-update'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">queueUpdate</span><span class="token punctuation">(</span><span class="token function">fetchUpdate</span><span class="token punctuation">(</span>update<span class="token punctuation">)</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
    <span class="token keyword">let</span> <span class="token punctuation">{</span> path<span class="token punctuation">,</span> timestamp <span class="token punctuation">}</span> <span class="token operator">=</span> update
    path <span class="token operator">=</span> path<span class="token punctuation">.</span><span class="token function">replace</span><span class="token punctuation">(</span><span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">\?.*</span><span class="token regex-delimiter">/</span></span><span class="token punctuation">,</span> <span class="token string">''</span><span class="token punctuation">)</span>
    <span class="token keyword">const</span> el <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">slice</span><span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span>
      document<span class="token punctuation">.</span><span class="token function">querySelectorAll</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">link</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span>
    <span class="token punctuation">)</span> <span class="token keyword">as</span> HTMLLinkElement<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">find</span><span class="token punctuation">(</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> e<span class="token punctuation">.</span>href<span class="token punctuation">.</span><span class="token function">includes</span><span class="token punctuation">(</span>path<span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>el<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">const</span> newPath <span class="token operator">=</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>path<span class="token interpolation-punctuation punctuation">}</span></span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>
        path<span class="token punctuation">.</span><span class="token function">includes</span><span class="token punctuation">(</span><span class="token string">'?'</span><span class="token punctuation">)</span> <span class="token operator">?</span> <span class="token string">'&amp;'</span> <span class="token operator">:</span> <span class="token string">'?'</span>
      <span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">t=</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>timestamp<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span>
      el<span class="token punctuation">.</span>href <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name"><span class="token constant">URL</span></span><span class="token punctuation">(</span>newPath<span class="token punctuation">,</span> el<span class="token punctuation">.</span>href<span class="token punctuation">)</span><span class="token punctuation">.</span>href
    <span class="token punctuation">}</span>
    <span class="token builtin">console</span><span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">[vite] css hot updated: </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>path<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br></div></div><p>这段代码逻辑首先判断是 isFirstUpdate &amp;&amp; hasErrorOverlay() , 是为了兼容一种情况, 就是首次更新, 并且此时有一个错误遮罩层, 这样的话就需要重新加载.</p> <p>其他的情况则是清除错误遮罩层, 并将 isFirstUpdate 置为 false.</p> <p>然后遍历 updates, 根据 update.type 进行相应的处理:</p> <ul><li>update.type 为 'js-update' 时, 依次调用 fetchUpdate 和 queueUpdate 函数进行更新</li> <li>update.type 为 'css-update' 时, 找到对应 path 的 link 元素, 更新 href 属性</li></ul> <p>其中对于 css-update 的处理比较简单, 那么我们就着重看一下对于 js-update 的处理, 首先我们先看 fetchUpdate 函数的定义:</p> <div class="language-ts line-numbers-mode"><pre class="language-ts"><code><span class="token comment">// packages/vite/src/client/client.ts</span>

<span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token function">fetchUpdate</span><span class="token punctuation">(</span><span class="token punctuation">{</span> path<span class="token punctuation">,</span> acceptedPath<span class="token punctuation">,</span> timestamp <span class="token punctuation">}</span><span class="token operator">:</span> Update<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> mod <span class="token operator">=</span> hotModulesMap<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>path<span class="token punctuation">)</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>mod<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">const</span> <span class="token keyword">module</span>Map <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Map</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token keyword">const</span> isSelfUpdate <span class="token operator">=</span> path <span class="token operator">===</span> acceptedPath
  <span class="token comment">// 保证每个依赖只更新依次</span>
  <span class="token keyword">const</span> <span class="token keyword">module</span>sToUpdate <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Set<span class="token operator">&lt;</span><span class="token builtin">string</span><span class="token operator">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>isSelfUpdate<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 只更新自身</span>
    <span class="token keyword">module</span>sToUpdate<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>path<span class="token punctuation">)</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
    <span class="token comment">// 更新依赖</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token punctuation">{</span> deps <span class="token punctuation">}</span> <span class="token keyword">of</span> mod<span class="token punctuation">.</span>callbacks<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      deps<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token punctuation">(</span>dep<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>acceptedPath <span class="token operator">===</span> dep<span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token keyword">module</span>sToUpdate<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>dep<span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
  <span class="token comment">// 在我们重新导入模块之前确定合格的回调</span>
  <span class="token keyword">const</span> qualifiedCallbacks <span class="token operator">=</span> mod<span class="token punctuation">.</span>callbacks<span class="token punctuation">.</span><span class="token function">filter</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">{</span> deps <span class="token punctuation">}</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> deps<span class="token punctuation">.</span><span class="token function">some</span><span class="token punctuation">(</span><span class="token punctuation">(</span>dep<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token keyword">module</span>sToUpdate<span class="token punctuation">.</span><span class="token function">has</span><span class="token punctuation">(</span>dep<span class="token punctuation">)</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token keyword">await</span> <span class="token builtin">Promise</span><span class="token punctuation">.</span><span class="token function">all</span><span class="token punctuation">(</span>
    <span class="token builtin">Array</span><span class="token punctuation">.</span><span class="token function">from</span><span class="token punctuation">(</span><span class="token keyword">module</span>sToUpdate<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token keyword">async</span> <span class="token punctuation">(</span>dep<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      <span class="token keyword">const</span> disposer <span class="token operator">=</span> disposeMap<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>dep<span class="token punctuation">)</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>disposer<span class="token punctuation">)</span> <span class="token keyword">await</span> <span class="token function">disposer</span><span class="token punctuation">(</span>dataMap<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>dep<span class="token punctuation">)</span><span class="token punctuation">)</span>
      <span class="token keyword">const</span> <span class="token punctuation">[</span>path<span class="token punctuation">,</span> query<span class="token punctuation">]</span> <span class="token operator">=</span> dep<span class="token punctuation">.</span><span class="token function">split</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">?</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span>
      <span class="token keyword">try</span> <span class="token punctuation">{</span>
        <span class="token comment">// 调用 import 重新加载新的模块</span>
        <span class="token keyword">const</span> newMod <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token keyword">import</span><span class="token punctuation">(</span>
          <span class="token comment">/* @vite-ignore */</span>
          base <span class="token operator">+</span>
            path<span class="token punctuation">.</span><span class="token function">slice</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">+</span>
            <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">?import&amp;t=</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>timestamp<span class="token interpolation-punctuation punctuation">}</span></span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>query <span class="token operator">?</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">&amp;</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>query<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span> <span class="token operator">:</span> <span class="token string">''</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span>
        <span class="token punctuation">)</span>
        <span class="token keyword">module</span>Map<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>dep<span class="token punctuation">,</span> newMod<span class="token punctuation">)</span>
      <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">warnFailedFetch</span><span class="token punctuation">(</span>e<span class="token punctuation">,</span> dep<span class="token punctuation">)</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token punctuation">)</span>
  <span class="token comment">// 返回回调</span>
  <span class="token keyword">return</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token punctuation">{</span> deps<span class="token punctuation">,</span> fn <span class="token punctuation">}</span> <span class="token keyword">of</span> qualifiedCallbacks<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token function">fn</span><span class="token punctuation">(</span>deps<span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token punctuation">(</span>dep<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token keyword">module</span>Map<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>dep<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">const</span> loggedPath <span class="token operator">=</span> isSelfUpdate <span class="token operator">?</span> path <span class="token operator">:</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>acceptedPath<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string"> via </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>path<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span>
    <span class="token builtin">console</span><span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">[vite] hot updated: </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>loggedPath<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br></div></div><p>fetchUpdate 函数的基本逻辑就是根据 path, acceptedPath 确定更新的模块集合 modulesToUpdate , 然后遍历 modulesToUpdate , 调用 import 函数重新请求新模块, 并将其放入 moduleMap.</p> <p>最后返回一个回调函数, 用来最后执行相应的回调和打印 log .</p> <p>至于 queueUpdate 函数, 可以理解他是一个调度更新的函数, 用来缓存由同一个 src 更新导致的多个更新, 并保证他们能按照相应的顺序进行更新. 并且他以微任务队列周期统一更新.</p> <div class="language-ts line-numbers-mode"><pre class="language-ts"><code><span class="token comment">// packages/vite/src/client/client.ts</span>

<span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token function">queueUpdate</span><span class="token punctuation">(</span>p<span class="token operator">:</span> <span class="token builtin">Promise</span><span class="token operator">&lt;</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token keyword">void</span><span class="token punctuation">)</span> <span class="token operator">|</span> <span class="token keyword">undefined</span><span class="token operator">&gt;</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  queued<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>p<span class="token punctuation">)</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>pending<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    pending <span class="token operator">=</span> <span class="token boolean">true</span>
    <span class="token keyword">await</span> <span class="token builtin">Promise</span><span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    pending <span class="token operator">=</span> <span class="token boolean">false</span>
    <span class="token keyword">const</span> loading <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token operator">...</span>queued<span class="token punctuation">]</span>
    queued <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
    <span class="token punctuation">;</span><span class="token punctuation">(</span><span class="token keyword">await</span> <span class="token builtin">Promise</span><span class="token punctuation">.</span><span class="token function">all</span><span class="token punctuation">(</span>loading<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token punctuation">(</span>fn<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> fn <span class="token operator">&amp;&amp;</span> <span class="token function">fn</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br></div></div><p>至此, HMR 的实现原理就解析完了. 下图是 ViteDevServer 基本的层级结构:</p> <p><img src="/assets/img/vite2-dev-server.0217c89e.png" alt="vite2-dev-server"></p> <h2 id="总结"><a href="#总结" class="header-anchor">#</a> 总结</h2> <p>以上, 就是关于 vite 2.0 的中间件机制, 插件机制及HMR机制的解析.</p> <h2 id="扩展阅读"><a href="#扩展阅读" class="header-anchor">#</a> 扩展阅读</h2> <ul><li><a href="https://juejin.cn/post/6943233321765715976" target="_blank" rel="noopener noreferrer">在浏览器中使用 ECMAScript Modules<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li> <li><a href="https://macsalvation.net/ES-modules-A-cartoon-deep-dive-chinese-translation/" target="_blank" rel="noopener noreferrer">[译文]深入理解 ES Modules (手绘示例)<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li></ul></div></div> <!----> <div class="page-edit"><div class="edit-link"><a href="https://github.com/artoriaschan/edit/master/src/Vite 源码解析/02.vite2.md" target="_blank" rel="noopener noreferrer">编辑</a> <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></div> <div class="tags"><a href="/tags/?tag=ESBuild" title="标签">#ESBuild</a><a href="/tags/?tag=Build%20Tools" title="标签">#Build Tools</a></div> <div class="last-updated"><span class="prefix">上次更新:</span> <span class="time">2022/07/23, 17:53:01</span></div></div> <div class="page-nav-wapper"><!----> <!----></div></div> <!----></main></div> <div class="footer"><div class="icons"><a href="mailto:dalecracker@gmail.com" title="发邮件" target="_blank" class="iconfont icon-youjian"></a><a href="https://github.com/artoriaschan" title="GitHub" target="_blank" class="iconfont icon-github"></a></div> 
  Theme by
  <a href="https://github.com/xugaoyi/vuepress-theme-vdoing" target="_blank" title="本站主题">Vdoing</a> 
    | Copyright © 2018-2022
    <span>Artorias Chan | <a href="https://raw.githubusercontent.com/artoriaschan/blog/master/LICENSE" target="_blank">MIT License</a></span></div> <div class="buttons"><div title="返回顶部" class="button blur go-to-top iconfont icon-fanhuidingbu" style="display:none;"></div> <div title="去评论" class="button blur go-to-comment iconfont icon-pinglun" style="display:none;"></div> <div title="主题模式" class="button blur theme-mode-but iconfont icon-zhuti"><ul class="select-box" style="display:none;"><li class="iconfont icon-zidong">
          跟随系统
        </li><li class="iconfont icon-rijianmoshi">
          浅色模式
        </li><li class="iconfont icon-yejianmoshi">
          深色模式
        </li><li class="iconfont icon-yuedu">
          阅读模式
        </li></ul></div></div> <div class="body-bg" style="background:url() center center / cover no-repeat;opacity:0.5;"></div> <!----> <!----></div><div class="global-ui"></div></div>
    <script src="/assets/js/app.c17531b4.js" defer></script><script src="/assets/js/2.3e7b8786.js" defer></script><script src="/assets/js/23.3ca57ee7.js" defer></script>
  </body>
</html>