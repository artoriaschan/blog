---
title: âš› React æºç è§£è¯»(ä¸ƒ) - åˆæˆäº‹ä»¶ç³»ç»Ÿ
date: 2020-03-31 00:00:00
tags: 
  - React
permalink: /pages/ff369e/
sidebar: auto
categories: 
  - React 17 æºç è§£æ
---
## æ¦‚è§ˆ
åœ¨ `React v17` çš„ç‰ˆæœ¬ä¸­ï¼Œå¯¹Reactä¸­çš„äº‹ä»¶å§”æ‰˜è¿›è¡Œäº†æ›´æ”¹ã€‚

è‡ªä»å…¶å‘å¸ƒä»¥æ¥ï¼Œ `React` ä¸€ç›´è‡ªåŠ¨è¿›è¡Œäº‹ä»¶å§”æ‰˜ã€‚å½“ `document` ä¸Šè§¦å‘ `DOM` äº‹ä»¶æ—¶ï¼Œ `React` ä¼šæ‰¾å‡ºè°ƒç”¨çš„ç»„ä»¶ï¼Œç„¶å `React` äº‹ä»¶ä¼šåœ¨ç»„ä»¶ä¸­å‘ä¸Š `â€œå†’æ³¡â€`ã€‚ä½†å®é™…ä¸Šï¼ŒåŸç”Ÿäº‹ä»¶å·²ç»å†’æ³¡å‡ºäº† `document` çº§åˆ«ï¼Œ `React` åœ¨å…¶ä¸­å®‰è£…äº†äº‹ä»¶å¤„ç†å™¨ã€‚

å¦‚æœé¡µé¢ä¸Šæœ‰å¤šä¸ª `React` ç‰ˆæœ¬ï¼Œä»–ä»¬éƒ½å°†åœ¨é¡¶å±‚æ³¨å†Œäº‹ä»¶å¤„ç†å™¨ã€‚è¿™ä¼šç ´å `e.stopPropagation()`ï¼šå¦‚æœåµŒå¥—æ ‘ç»“æ„ä¸­é˜»æ­¢äº†äº‹ä»¶å†’æ³¡ï¼Œä½†å¤–éƒ¨æ ‘ä¾ç„¶èƒ½æ¥æ”¶åˆ°å®ƒã€‚è¿™ä¼šä½¿ä¸åŒç‰ˆæœ¬ `React` åµŒå¥—å˜å¾—å›°éš¾é‡é‡ã€‚

åœ¨ `React v17` ä¸­ï¼Œ `React` å°†ä¸å†å‘ `document` é™„åŠ äº‹ä»¶å¤„ç†å™¨ã€‚è€Œä¼šå°†äº‹ä»¶å¤„ç†å™¨é™„åŠ åˆ°æ¸²æŸ“ `Reactæ ‘` çš„ `æ ¹DOM` å®¹å™¨ä¸­ï¼š
```javascript
const rootNode = document.getElementById('root');
ReactDOM.render(<App />, rootNode);
```
åœ¨ `React v16` æˆ–æ›´æ—©ç‰ˆæœ¬ä¸­ï¼Œ `React` ä¼šå¯¹å¤§å¤šæ•°äº‹ä»¶æ‰§è¡Œ `document.addEventListener()` ã€‚ `React v17` å°†ä¼šåœ¨åº•å±‚è°ƒç”¨ `rootNode.addEventListener()`ã€‚
![react_17_delegation](~@assets/posts/react-source-event-system/react_17_delegation.png)

ç”±äºæ­¤æ›´æ”¹ï¼Œç°åœ¨å¯ä»¥æ›´åŠ å®‰å…¨åœ°è¿›è¡Œæ–°æ—§ç‰ˆæœ¬ `Reactæ ‘` çš„åµŒå¥—ã€‚æ­¤å¤–è¿˜ä½¿å¾—å°† `React` åµŒå…¥ä½¿ç”¨å…¶ä»–æŠ€æœ¯æ„å»ºçš„åº”ç”¨ç¨‹åºå˜å¾—æ›´åŠ å®¹æ˜“ã€‚

é‚£ä¹ˆæˆ‘ä»¬æ¥åˆ†æä¸€ä¸‹ `React` ä¸­çš„ `åˆæˆäº‹ä»¶` ç³»ç»Ÿã€‚
## ç³»ç»Ÿç»“æ„
### createSyntheticEvent
`createSyntheticEvent` å‡½æ•°ä¸º `åˆæˆäº‹ä»¶å¯¹è±¡` çš„æ„é€  `å·¥å‚å‡½æ•°` ï¼Œé€šè¿‡ä¼ å…¥çš„ `Interface` æ¥è¿”å›ä¸åŒçš„æ„é€ å‡½æ•°ã€‚
```javascript
// packages/react-dom/src/events/SyntheticEvent.js

function createSyntheticEvent(Interface: EventInterfaceType) {
  function SyntheticBaseEvent(
    reactName: string | null,
    reactEventType: string,
    targetInst: Fiber,
    nativeEvent: {[propName: string]: mixed},
    nativeEventTarget: null | EventTarget,
  ) {
    this._reactName = reactName;
    this._targetInst = targetInst;
    this.type = reactEventType;
    this.nativeEvent = nativeEvent;
    this.target = nativeEventTarget;
    this.currentTarget = null;

    for (const propName in Interface) {
      if (!Interface.hasOwnProperty(propName)) {
        continue;
      }
      const normalize = Interface[propName];
      if (normalize) {
        this[propName] = normalize(nativeEvent);
      } else {
        this[propName] = nativeEvent[propName];
      }
    }

    const defaultPrevented =
      nativeEvent.defaultPrevented != null
        ? nativeEvent.defaultPrevented
        : nativeEvent.returnValue === false;
    if (defaultPrevented) {
      this.isDefaultPrevented = functionThatReturnsTrue;
    } else {
      this.isDefaultPrevented = functionThatReturnsFalse;
    }
    this.isPropagationStopped = functionThatReturnsFalse;
    return this;
  }

  Object.assign(SyntheticBaseEvent.prototype, {
    preventDefault: function() {
      this.defaultPrevented = true;
      const event = this.nativeEvent;
      if (!event) {
        return;
      }
      if (event.preventDefault) {
        event.preventDefault();
      } else if (typeof event.returnValue !== 'unknown') {
        event.returnValue = false;
      }
      this.isDefaultPrevented = functionThatReturnsTrue;
    },

    stopPropagation: function() {
      const event = this.nativeEvent;
      if (!event) {
        return;
      }
      if (event.stopPropagation) {
        event.stopPropagation();
      } else if (typeof event.cancelBubble !== 'unknown') {
        event.cancelBubble = true;
      }
      this.isPropagationStopped = functionThatReturnsTrue;
    },
    persist: function() {
      // Modern event system doesn't use pooling.
    },
    isPersistent: functionThatReturnsTrue,
  });
  return SyntheticBaseEvent;
}
```
é€šè¿‡ `createSyntheticEvent` æ„é€ å·¥å‚å‡½æ•°ï¼Œ `React` æ„é€ äº† `13` ä¸ªåˆæˆäº‹ä»¶å¯¹è±¡æ„é€ å‡½æ•°ï¼Œåˆ†åˆ«å¯¹åº”ä¸åŒç±»å‹çš„äº‹ä»¶ï¼š
```javascript
// packages/react-dom/src/events/SyntheticEvent.js

export const SyntheticEvent = createSyntheticEvent(EventInterface);
export const SyntheticUIEvent = createSyntheticEvent(UIEventInterface);
export const SyntheticMouseEvent = createSyntheticEvent(MouseEventInterface);
export const SyntheticDragEvent = createSyntheticEvent(DragEventInterface);
export const SyntheticFocusEvent = createSyntheticEvent(FocusEventInterface);
export const SyntheticAnimationEvent = createSyntheticEvent(
  AnimationEventInterface,
);
export const SyntheticClipboardEvent = createSyntheticEvent(
  ClipboardEventInterface,
);
export const SyntheticCompositionEvent = createSyntheticEvent(
  CompositionEventInterface,
);
export const SyntheticKeyboardEvent = createSyntheticEvent(
  KeyboardEventInterface,
);
export const SyntheticPointerEvent = createSyntheticEvent(
  PointerEventInterface,
);
export const SyntheticTouchEvent = createSyntheticEvent(TouchEventInterface);
export const SyntheticTransitionEvent = createSyntheticEvent(
  TransitionEventInterface,
);
export const SyntheticWheelEvent = createSyntheticEvent(WheelEventInterface);
```
æ‰€æœ‰çš„åˆæˆäº‹ä»¶æ„é€ å‡½æ•°éƒ½æ˜¯åœ¨æ’ä»¶çš„ `extractEvents` å‡½æ•°ä¸­ä½¿ç”¨ï¼Œå¹¶åˆ›å»ºåˆæˆäº‹ä»¶å®ä¾‹ã€‚å¹¶å°†å…¶æ”¾å…¥ `dispatchQueue` ä¸­å»æ‰§è¡Œã€‚

æœ€ç»ˆåˆæˆäº‹ä»¶å®ä¾‹ä¼šä½œä¸ºå‚æ•°ä¼ å…¥åˆ°äº‹ä»¶ç›‘å¬å‡½æ•° `listener` ä¸­ã€‚
### äº‹ä»¶æ’ä»¶
* `SimpleEventPlugin`
* `EnterLeaveEventPlugin`
* `ChangeEventPlugin`
* `SelectEventPlugin`
* `BeforeInputEventPlugin`
æ¯ä¸ªäº‹ä»¶æ’ä»¶éƒ½ä¼šç»Ÿä¸€çš„å¯¹å¤–æš´éœ²ä¸¤ä¸ªå‡½æ•°ï¼š
* `registerEvents` ï¼š è´Ÿè´£äº‹ä»¶æ³¨å†Œ
* `extractEvents` ï¼š è´Ÿè´£æå– fiber ä¸­æ³¨å†Œçš„äº‹ä»¶
æ’ä»¶çš„ `registerEvents` å‡½æ•°ä¼šåœ¨ `packages/react-dom/src/events/DOMPluginEventSystem.js` æ–‡ä»¶çš„ `Top-Level` ä½œç”¨åŸŸä¸­ç»Ÿä¸€è°ƒç”¨ï¼š
```javascript
// packages/react-dom/src/events/DOMPluginEventSystem.js

SimpleEventPlugin.registerEvents();
EnterLeaveEventPlugin.registerEvents();
ChangeEventPlugin.registerEvents();
SelectEventPlugin.registerEvents();
BeforeInputEventPlugin.registerEvents();
```
è‡³äº `extractEvents` å‡½æ•°åˆ™ä¼šé›†æˆè¿›ä¸€ä¸ªç»Ÿä¸€çš„ extractEvents å‡½æ•°ä¸­ï¼š
```javascript {10,22,31,40,49}
function extractEvents(
  dispatchQueue: DispatchQueue,
  domEventName: DOMEventName,
  targetInst: null | Fiber,
  nativeEvent: AnyNativeEvent,
  nativeEventTarget: null | EventTarget,
  eventSystemFlags: EventSystemFlags,
  targetContainer: EventTarget,
) {
  SimpleEventPlugin.extractEvents(
    dispatchQueue,
    domEventName,
    targetInst,
    nativeEvent,
    nativeEventTarget,
    eventSystemFlags,
    targetContainer,
  );
  const shouldProcessPolyfillPlugins =
    (eventSystemFlags & SHOULD_NOT_PROCESS_POLYFILL_EVENT_PLUGINS) === 0;
  if (shouldProcessPolyfillPlugins) {
    EnterLeaveEventPlugin.extractEvents(
      dispatchQueue,
      domEventName,
      targetInst,
      nativeEvent,
      nativeEventTarget,
      eventSystemFlags,
      targetContainer,
    );
    ChangeEventPlugin.extractEvents(
      dispatchQueue,
      domEventName,
      targetInst,
      nativeEvent,
      nativeEventTarget,
      eventSystemFlags,
      targetContainer,
    );
    SelectEventPlugin.extractEvents(
      dispatchQueue,
      domEventName,
      targetInst,
      nativeEvent,
      nativeEventTarget,
      eventSystemFlags,
      targetContainer,
    );
    BeforeInputEventPlugin.extractEvents(
      dispatchQueue,
      domEventName,
      targetInst,
      nativeEvent,
      nativeEventTarget,
      eventSystemFlags,
      targetContainer,
    );
  }
}
```
è€Œ `extractEvents` å‡½æ•°çš„è°ƒç”¨åªå‘ç”Ÿåœ¨ `dispatchEventsForPlugins` å‡½æ•°ä¸­ï¼Œç”¨æ¥è·å– `dispatch` æ”¾å…¥ä¼ å…¥çš„ `dispatchQueue` ä¸­ï¼š
```javascript {11,12-20}
// packages/react-dom/src/events/DOMPluginEventSystem.js

function dispatchEventsForPlugins(
  domEventName: DOMEventName,
  eventSystemFlags: EventSystemFlags,
  nativeEvent: AnyNativeEvent,
  targetInst: null | Fiber,
  targetContainer: EventTarget,
): void {
  const nativeEventTarget = getEventTarget(nativeEvent);
  const dispatchQueue: DispatchQueue = [];
  extractEvents(
    dispatchQueue,
    domEventName,
    targetInst,
    nativeEvent,
    nativeEventTarget,
    eventSystemFlags,
    targetContainer,
  );
  processDispatchQueue(dispatchQueue, eventSystemFlags);
}
```
è€Œ `dispatchEventsForPlugins` å‡½æ•°çš„è°ƒç”¨ä¹Ÿåªå‘ç”Ÿåœ¨ `dispatchEventForPluginEventSystem` å‡½æ•°ä¸­ï¼š
``` javascript {72-78}
// packages/react-dom/src/events/DOMPluginEventSystem.js

export function dispatchEventForPluginEventSystem(
  domEventName: DOMEventName,
  eventSystemFlags: EventSystemFlags,
  nativeEvent: AnyNativeEvent,
  targetInst: null | Fiber,
  targetContainer: EventTarget,
): void {
  let ancestorInst = targetInst;
  if (
    (eventSystemFlags & IS_EVENT_HANDLE_NON_MANAGED_NODE) === 0 &&
    (eventSystemFlags & IS_NON_DELEGATED) === 0
  ) {
    const targetContainerNode = ((targetContainer: any): Node);

    if (
      enableLegacyFBSupport &&
      domEventName === 'click' &&
      (eventSystemFlags & SHOULD_NOT_DEFER_CLICK_FOR_FB_SUPPORT_MODE) === 0
    ) {
      deferClickToDocumentForLegacyFBSupport(domEventName, targetContainer);
      return;
    }
    if (targetInst !== null) {
      let node = targetInst;

      mainLoop: while (true) {
        if (node === null) {
          return;
        }
        const nodeTag = node.tag;
        if (nodeTag === HostRoot || nodeTag === HostPortal) {
          let container = node.stateNode.containerInfo;
          if (isMatchingRootContainer(container, targetContainerNode)) {
            break;
          }
          if (nodeTag === HostPortal) {
            let grandNode = node.return;
            while (grandNode !== null) {
              const grandTag = grandNode.tag;
              if (grandTag === HostRoot || grandTag === HostPortal) {
                const grandContainer = grandNode.stateNode.containerInfo;
                if (
                  isMatchingRootContainer(grandContainer, targetContainerNode)
                ) {
                  return;
                }
              }
              grandNode = grandNode.return;
            }
          }
          while (container !== null) {
            const parentNode = getClosestInstanceFromNode(container);
            if (parentNode === null) {
              return;
            }
            const parentTag = parentNode.tag;
            if (parentTag === HostComponent || parentTag === HostText) {
              node = ancestorInst = parentNode;
              continue mainLoop;
            }
            container = container.parentNode;
          }
        }
        node = node.return;
      }
    }
  }

  batchedEventUpdates(() =>
    dispatchEventsForPlugins(
      domEventName,
      eventSystemFlags,
      nativeEvent,
      ancestorInst,
      targetContainer,
    ),
  );
}
```
### SimpleEventPlugin
æˆ‘ä»¬å°±ä»¥ `SimpleEventPlugin` ä¸ºä¾‹åˆ†æä¸€ä¸‹ï¼Œçœ‹çœ‹è¿™ä¸ªæ’ä»¶ä¸»è¦åšäº†ä»€ä¹ˆå·¥ä½œã€‚

æ ¹æ®å‰æ–‡æˆ‘ä»¬çŸ¥é“ï¼Œæ¯ä¸ªæ’ä»¶éƒ½ä¼šå¯¹å¤–æš´éœ²ä¸¤ä¸ªå‡½æ•°ï¼š `registerEvents` å‡½æ•°ä¸»è¦æ˜¯è¿›è¡Œäº‹ä»¶æ³¨å†Œï¼› `extractEvents` å‡½æ•°ä¸»è¦æ˜¯ä»ä»£ç†äº‹ä»¶ä¸­æå–å‡ºåœ¨ `fiber` ä¸­æ³¨å†Œçš„äº‹ä»¶ç›‘å¬å‡½æ•°ã€‚

é¦–å…ˆæˆ‘ä»¬å…ˆçœ‹ä¸€ä¸‹ `registerEvents` çš„å£°æ˜ï¼š
```javascript
// packages/react-dom/src/events/plugins/SimpleEventPlugin.js

export {registerSimpleEvents as registerEvents, extractEvents};

// packages/react-dom/src/events/DOMEventProperties.js

export function registerSimpleEvents() {
  registerSimplePluginEventsAndSetTheirPriorities(
    discreteEventPairsForSimpleEventPlugin,
    DiscreteEvent,
  );
  registerSimplePluginEventsAndSetTheirPriorities(
    userBlockingPairsForSimpleEventPlugin,
    UserBlockingEvent,
  );
  registerSimplePluginEventsAndSetTheirPriorities(
    continuousPairsForSimpleEventPlugin,
    ContinuousEvent,
  );
  setEventPriorities(otherDiscreteEvents, DiscreteEvent);
}
```
`registerSimpleEvents` å‡½æ•°çš„ä½œç”¨å°±æ˜¯è°ƒç”¨ `registerTwoPhaseEvent` å‡½æ•°è¿›è¡Œäº‹ä»¶æ³¨å†Œã€‚æˆ‘ä»¬å¯ä»¥çœ‹åˆ°ä»–åˆ†åˆ«è°ƒç”¨äº†ä¸‰æ¬¡ `registerSimplePluginEventsAndSetTheirPriorities` å‡½æ•°ï¼Œ å¹¶å¯¹å¯¹åº”çš„äº‹ä»¶é›†èµ‹å€¼ç›¸åº”çš„ä¼˜å…ˆçº§ã€‚

å…¶ä¸­ `discreteEventPairsForSimpleEventPlugin` ï¼Œ `userBlockingPairsForSimpleEventPlugin` åŠ `continuousPairsForSimpleEventPlugin` ç­‰é›†åˆçš„æ ¼å¼ä¸ºæ•°ç»„ï¼Œä½†æ˜¯ `[i, i + 1]` ä¸ºç›¸åº”çš„ä¸€å¯¹ã€‚

`registerSimplePluginEventsAndSetTheirPriorities` å‡½æ•°çš„å®šä¹‰å¦‚ä¸‹ï¼š
```javascript {3-14,25-26}
// packages/react-dom/src/events/DOMEventProperties.js

/**
 * Turns
 * ['abort', ...]
 *
 * into
 *
 * topLevelEventsToReactNames = new Map([
 *   ['abort', 'onAbort'],
 * ]);
 *
 * and registers them.
 */
function registerSimplePluginEventsAndSetTheirPriorities(
  eventTypes: Array<DOMEventName | string>,
  priority: EventPriority,
): void {
  for (let i = 0; i < eventTypes.length; i += 2) {
    const topEvent = ((eventTypes[i]: any): DOMEventName);
    const event = ((eventTypes[i + 1]: any): string);
    const capitalizedEvent = event[0].toUpperCase() + event.slice(1);
    const reactName = 'on' + capitalizedEvent;
    eventPriorities.set(topEvent, priority);
    topLevelEventsToReactNames.set(topEvent, reactName);
    registerTwoPhaseEvent(reactName, [topEvent]);
  }
}
```
è¿™ä¸ªå‡½æ•°çš„ä½œç”¨æºä»£ç ä¸­çš„æ³¨é‡Šå¾ˆå¥½çš„è¯ é‡Šäº†ï¼šå°† `[i, i + 1]` å­—ç¬¦ä¸²å¯¹è½¬æ¢æˆ `Map` ï¼Œå¹¶ä¸”ä½¿ç”¨ `registerTwoPhaseEvent` å‡½æ•°æ³¨å†Œè¯¥äº‹ä»¶ã€‚

è‡³äº `topLevelEventsToReactNames` å¸¸é‡çš„ä½¿ç”¨ï¼Œåˆ™æ˜¯åœ¨ `SimpleEventPlugin.extractEvents` ä¸­ç”¨æ¥è·å– `reactName` ï¼Œç”¨æ¥æ„é€ åˆæˆäº‹ä»¶å¯¹è±¡ã€‚
``` javascript
  const reactName = topLevelEventsToReactNames.get(domEventName);
```
æˆ‘ä»¬æ¥ç€çœ‹ `registerTwoPhaseEvent` å‡½æ•°æ˜¯å¦‚ä½•æ³¨å†Œäº‹ä»¶çš„ï¼š
```javascript
// packages/react-dom/src/events/EventRegistry.js

export function registerTwoPhaseEvent(
  registrationName: string,
  dependencies: Array<DOMEventName>,
): void {
  registerDirectEvent(registrationName, dependencies);
  registerDirectEvent(registrationName + 'Capture', dependencies);
}

export function registerDirectEvent(
  registrationName: string,
  dependencies: Array<DOMEventName>,
) {
  // ...
  registrationNameDependencies[registrationName] = dependencies;
  // ...
  for (let i = 0; i < dependencies.length; i++) {
    allNativeEvents.add(dependencies[i]);
  }
}
```
æœ¬è´¨ä¸Šæ¥è¯´ `registerTwoPhaseEvent` æ²¡æœ‰ä½¿ç”¨ `å®¿ä¸»ç¯å¢ƒ` çš„ `addEventListener` æ¥è¿›è¡Œäº‹ä»¶æ³¨å†Œï¼Œè€Œæ˜¯å°†ä¼ å…¥çš„å‚æ•°è½¬åŒ–æˆä¸¤ä¸ªé›†åˆï¼š `registrationNameDependencies` å’Œ `allNativeEvents` ã€‚

å…¶ä¸­ `allNativeEvents` ä¼šåœ¨ `listenToAllSupportedEvents` ä¸­ä½¿ç”¨ï¼Œ ç”¨äºäº‹ä»¶æ³¨å†Œï¼›è€Œ `registrationNameDependencies` åˆ™æ˜¯åœ¨ `React` è§£æ `props` æ—¶ï¼Œ è¿‡æ»¤ç”¨æˆ·æ³¨å†Œåœ¨ `DOM` ä¸Šçš„äº‹ä»¶å±æ€§ã€‚

åˆ°è¿™ä¸ºæ­¢ï¼Œ `SimpleEventPlugin` äº‹ä»¶æ’ä»¶çš„è§£æå°±ç»“æŸäº†ï¼Œæœ€ç»ˆæˆ‘ä»¬çŸ¥é“ç»è¿‡æ‰€æœ‰çš„äº‹ä»¶æ’ä»¶çš„ `registerEvents` å‡½æ•°ä¹‹åï¼Œæœ€åº•å±‚éƒ½ä¼šè°ƒç”¨ `registerDirectEvent` å‡½æ•°å°†æ’ä»¶ä¸­æ”¯æŒçš„äº‹ä»¶é›†æˆåˆ° `allNativeEvents` é›†åˆä¸­ï¼Œä½†æ˜¯æ²¡æœ‰çœŸæ­£çš„è¿›è¡Œäº‹ä»¶åœ¨ `å®¿ä¸»ç¯å¢ƒ` ä¸­çš„æ³¨å†Œã€‚

é‚£ä¹ˆæˆ‘ä»¬æ¥ä¸‹æ¥çœ‹äº‹ä»¶æ˜¯å¦‚ä½•åœ¨ `å®¿ä¸»ç¯å¢ƒ` ä¸­è¿›è¡Œæ³¨å†Œçš„ã€‚
## äº‹ä»¶æ³¨å†Œ
`listenToAllSupportedEvents` å‡½æ•°æ—¶è¿›è¡Œäº‹ä»¶æ³¨å†Œçš„å…¥å£å‡½æ•°ï¼Œ ä¸‹é¢æˆ‘ä»¬çœ‹ä¸€ä¸‹ `listenToAllSupportedEvents` çš„å®šä¹‰ï¼š
```javascript {6-15}
// packages/react-dom/src/events/DOMPluginEventSystem.js

export function listenToAllSupportedEvents(rootContainerElement: EventTarget) {
  if (!(rootContainerElement: any)[listeningMarker]) {
    (rootContainerElement: any)[listeningMarker] = true;
    allNativeEvents.forEach(domEventName => {
      // We handle selectionchange separately because it
      // doesn't bubble and needs to be on the document.
      if (domEventName !== 'selectionchange') {
        if (!nonDelegatedEvents.has(domEventName)) {
          listenToNativeEvent(domEventName, false, rootContainerElement);
        }
        listenToNativeEvent(domEventName, true, rootContainerElement);
      }
    });
    const ownerDocument =
      (rootContainerElement: any).nodeType === DOCUMENT_NODE
        ? rootContainerElement
        : (rootContainerElement: any).ownerDocument;
    if (ownerDocument !== null) {
      // The selectionchange event also needs deduplication
      // but it is attached to the document.
      if (!(ownerDocument: any)[listeningMarker]) {
        (ownerDocument: any)[listeningMarker] = true;
        listenToNativeEvent('selectionchange', false, ownerDocument);
      }
    }
  }
}
```
::: warning `listenToAllSupportedEvents` å‡½æ•°çš„è°ƒç”¨æ—¶æœº
åœ¨è°ƒç”¨ `listenToAllSupportedEvents` å‡½æ•°æ—¶ï¼Œ ä¼ å…¥çš„æ˜¯å½“å‰ `Fiber æ ‘` çš„æ ¹å®¹å™¨å…ƒç´ ã€‚
``` javascript {9}
// packages/react-dom/src/client/ReactDOMRoot.js

function createRootImpl(
  container: Container,
  tag: RootTag,
  options: void | RootOptions,
) {
  // ...
  const rootContainerElement =
    container.nodeType === COMMENT_NODE ? container.parentNode : container;
  listenToAllSupportedEvents(rootContainerElement);
  // ...
  return root;
}
```
:::
æˆ‘ä»¬å¯ä»¥çœ‹åˆ° listenToAllSupportedEvents å‡½æ•°ä¸­ï¼Œéå† allNativeEvents é›†åˆå¹¶ä¸”è°ƒç”¨ listenToNativeEvent å‡½æ•°ï¼š
```javascript
export function listenToNativeEvent(
  domEventName: DOMEventName,
  isCapturePhaseListener: boolean,
  target: EventTarget,
): void {

  let eventSystemFlags = 0;
  if (isCapturePhaseListener) {
    eventSystemFlags |= IS_CAPTURE_PHASE;
  }
  addTrappedEventListener(
    target,
    domEventName,
    eventSystemFlags,
    isCapturePhaseListener,
  );
}
```
è€Œåœ¨ listenToNativeEvent å‡½æ•°ä¸­åˆè°ƒç”¨äº† addTrappedEventListener å‡½æ•°ï¼Œé‚£æˆ‘ä»¬æ¥ç€è¿™ä¸ªæµç¨‹å¾€ä¸‹çœ‹ï¼š
```javascript {9,18,25,33,40} 
function addTrappedEventListener(
  targetContainer: EventTarget,
  domEventName: DOMEventName,
  eventSystemFlags: EventSystemFlags,
  isCapturePhaseListener: boolean,
  isDeferredListenerForLegacyFBSupport?: boolean,
) {
  // ç”Ÿæˆäº‹ä»¶ç›‘å¬å‡½æ•° listenerï¼Œä¼šæ ¹æ®ä¼˜å…ˆçº§ç”Ÿæˆä¸åŒçš„ç›‘å¬å‡½æ•°
  let listener = createEventListenerWrapperWithPriority(
    targetContainer,
    domEventName,
    eventSystemFlags,
  );
  // ...
  // æ ¹æ® isCapturePhaseListener æ ‡å¿—ä½åˆ¤æ–­æ˜¯ç›‘å¬æ•è·é˜¶æ®µè¿˜æ˜¯å†’æ³¡é˜¶æ®µ
  if (isCapturePhaseListener) {
    if (isPassiveListener !== undefined) {
      unsubscribeListener = addEventCaptureListenerWithPassiveFlag(
        targetContainer,
        domEventName,
        listener,
        isPassiveListener,
      );
    } else {
      unsubscribeListener = addEventCaptureListener(
        targetContainer,
        domEventName,
        listener,
      );
    }
  } else {
    if (isPassiveListener !== undefined) {
      unsubscribeListener = addEventBubbleListenerWithPassiveFlag(
        targetContainer,
        domEventName,
        listener,
        isPassiveListener,
      );
    } else {
      unsubscribeListener = addEventBubbleListener(
        targetContainer,
        domEventName,
        listener,
      );
    }
  }
}
```
æˆ‘ä»¬åœ¨ `addTrappedEventListener` å‡½æ•°ä¸­çœ‹åˆ°ï¼Œæ ¹æ® `isCapturePhaseListener` å’Œ `isPassiveListener` çš„åˆ¤æ–­ï¼Œåˆ†åˆ«è°ƒç”¨å››ä¸ªå‡½æ•°ï¼š
* `addEventCaptureListenerWithPassiveFlag`
* `addEventCaptureListener`
* `addEventBubbleListenerWithPassiveFlag`
* `addEventBubbleListener`

å…¶æ ¸å¿ƒå°±æ˜¯è°ƒç”¨ `addEventListener API` æ³¨å†Œäº‹ä»¶ç›‘å¬å‡½æ•°ã€‚æˆ‘ä»¬ä»¥ `addEventBubbleListener` ä¸ºä¾‹ï¼Œçœ‹ä¸€ä¸‹ä»–çš„å®šä¹‰ï¼š
```javascript {8}
// packages/react-dom/src/events/EventListener.js

export function addEventBubbleListener(
  target: EventTarget,
  eventType: string,
  listener: Function,
): Function {
  target.addEventListener(eventType, listener, false);
  return listener;
}
```
å…¶ä»–ä¸‰ä¸ªå‡½æ•°ç›¸ä¼¼ï¼Œåªæ˜¯è°ƒç”¨ `addEventListener API` æ—¶ï¼Œä¼ é€’çš„å‚æ•°ä¸åŒè€Œå·²ã€‚

è‡³æ­¤ï¼Œæˆ‘ä»¬äº‹ä»¶æ³¨å†Œé˜¶æ®µå°±è§£æå®Œæ¯•ï¼Œæ¥ä¸‹æ¥æ¥çœ‹ä¸€ä¸‹ `React` æ˜¯å¦‚ä½•è¿›è¡Œæ‰§è¡Œäº‹ä»¶ç›‘å¬å‡½æ•°çš„ã€‚
## äº‹ä»¶æ‰§è¡Œ
æˆ‘ä»¬çŸ¥é“åœ¨ `React v17` ä¸­ï¼Œ `React` å°†ä¸å†å‘ `document` é™„åŠ äº‹ä»¶å¤„ç†å™¨ã€‚è€Œä¼šå°†äº‹ä»¶å¤„ç†å™¨é™„åŠ åˆ°æ¸²æŸ“ `Reactæ ‘` çš„ `æ ¹DOM` å®¹å™¨ä¸­ã€‚ä¸»è¦çš„æ ¸å¿ƒæ€æƒ³åˆ™æ˜¯äº‹ä»¶ä»£ç†ï¼ˆäº‹ä»¶å§”æ‰˜ï¼‰ã€‚

ä¹Ÿå°±æ˜¯è¯´ï¼Œæ‰€æœ‰çš„äº‹ä»¶è§¦å‘éƒ½ä¼šè§¦å‘ `React` ä¸­ä»£ç†çš„äº‹ä»¶ï¼Œ å¹¶ä¸”æ‰§è¡Œå…¶äº‹ä»¶ç›‘å¬å‡½æ•°ã€‚

è€Œæˆ‘ä»¬çŸ¥é“ï¼Œåœ¨ `React` ä¸­ï¼Œäº‹ä»¶ç›‘å¬å‡½æ•° `listener` åˆ™æ˜¯é€šè¿‡ `createEventListenerWrapperWithPriority` å‡½æ•°ç”Ÿæˆçš„ï¼Œæˆ‘ä»¬çœ‹ä¸‹è¯¥å‡½æ•°çš„å®šä¹‰ï¼š
```javascript {10,13,16,20,24-29}
// packages/react-dom/src/events/ReactDOMEventListener.js

export function createEventListenerWrapperWithPriority(
  targetContainer: EventTarget,
  domEventName: DOMEventName,
  eventSystemFlags: EventSystemFlags,
): Function {
  // è·å–äº‹ä»¶ä¼˜å…ˆçº§
  const eventPriority = getEventPriorityForPluginSystem(domEventName);
  let listenerWrapper;
  switch (eventPriority) {
    case DiscreteEvent:
      listenerWrapper = dispatchDiscreteEvent;
      break;
    case UserBlockingEvent:
      listenerWrapper = dispatchUserBlockingUpdate;
      break;
    case ContinuousEvent:
    default:
      listenerWrapper = dispatchEvent;
      break;
  }
  // ä½¿ç”¨ bind ç»‘å®šå‚æ•°
  return listenerWrapper.bind(
    null,
    domEventName,
    eventSystemFlags,
    targetContainer,
  );
}
```
ä¸Šé¢æ€»å…±æœ‰ä¸‰ç§ `listenerWrapper` ï¼Œå…¶å®æœ€ç»ˆè°ƒç”¨çš„åªæœ‰ `dispatchEvent` å‡½æ•°ã€‚é‚£ä¹ˆæˆ‘ä»¬çœ‹ä¸€ä¸‹ `dispatchEvent` å‡½æ•°çš„å®šä¹‰ï¼š
```javascript {14-19}
// packages/react-dom/src/events/ReactDOMEventListener.js

export function dispatchEvent(
  domEventName: DOMEventName,
  eventSystemFlags: EventSystemFlags,
  targetContainer: EventTarget,
  nativeEvent: AnyNativeEvent,
): void {
  if (!_enabled) {
    return;
  }
  // ...
  // å°è¯•è°ƒåº¦äº‹ä»¶
  const blockedOn = attemptToDispatchEvent(
    domEventName,
    eventSystemFlags,
    targetContainer,
    nativeEvent,
  );
  // æˆåŠŸè°ƒåº¦äº‹ä»¶
  if (blockedOn === null) {
    if (allowReplay) {
      clearIfContinuousEvent(domEventName, nativeEvent);
    }
    return;
  }
  // ...
  dispatchEventForPluginEventSystem(
    domEventName,
    eventSystemFlags,
    nativeEvent,
    null,
    targetContainer,
  );
}
```
`dispatchEvent` å‡½æ•°ä¸­è°ƒç”¨ `attemptToDispatchEvent` å‡½æ•°æ¥å°è¯•è°ƒåº¦äº‹ä»¶ï¼Œå¦‚æœè¿”å›å€¼ä¸º `null` ï¼Œ åˆ™è¯´æ˜è°ƒåº¦æˆåŠŸï¼Œç›´æ¥è·³å‡º `dispatchEvent` å‡½æ•°ã€‚

æˆ‘ä»¬çœ‹ä¸€ä¸‹ `attemptToDispatchEvent` å‡½æ•°çš„å®šä¹‰ï¼š
```javascript {12,42-48}
// packages/react-dom/src/events/ReactDOMEventListener.js

export function attemptToDispatchEvent(
  domEventName: DOMEventName,
  eventSystemFlags: EventSystemFlags,
  targetContainer: EventTarget,
  nativeEvent: AnyNativeEvent,
): null | Container | SuspenseInstance {
  // è·å–äº‹ä»¶è§¦å‘çš„å…ƒç´ 
  const nativeEventTarget = getEventTarget(nativeEvent);
  // è·å–äº‹ä»¶è§¦å‘çš„æœ€è¿‘çš„ Fiber
  let targetInst = getClosestInstanceFromNode(nativeEventTarget);

  if (targetInst !== null) {
    // è·å–æœ€è¿‘æ¸²æŸ“å®Œçš„ Fiber
    const nearestMounted = getNearestMountedFiber(targetInst);
    if (nearestMounted === null) {
      targetInst = null;
    } else {
      const tag = nearestMounted.tag;
      if (tag === SuspenseComponent) {
        // SuspenseComponent ç›¸å…³çš„å¤„ç†
        if (instance !== null) {
          return instance;
        }
        targetInst = null;
      } else if (tag === HostRoot) {
        // HostRoot ç›¸å…³çš„å¤„ç†
        const root: FiberRoot = nearestMounted.stateNode;
        if (root.hydrate) {
          return getContainerFromFiber(nearestMounted);
        }
        targetInst = null;
      } else if (nearestMounted !== targetInst) {
        // åœ¨ç»„ä»¶ mount ä¹‹å‰è·å–äº‹ä»¶ï¼Œæš‚æ—¶å¿½ç•¥ã€‚
        targetInst = null;
      }
    }
  }

  dispatchEventForPluginEventSystem(
    domEventName,
    eventSystemFlags,
    nativeEvent,
    targetInst,
    targetContainer,
  );
  // We're not blocked on anything.
  return null;
}
```
`attemptToDispatchEvent` å‡½æ•°çš„é€»è¾‘ä¸»è¦åˆ†ä¸ºä¸¤éƒ¨åˆ†ï¼š
* è·å– `targetInst`
* è°ƒç”¨ `dispatchEventForPluginEventSystem` å‡½æ•°

è°ƒç”¨ `getClosestInstanceFromNode` è·å– `targetInst` ä¹‹åï¼Œåœ¨ä¸ä¸ºç©ºçš„æƒ…å†µä¸‹ï¼Œä¼šç»è¿‡å¦‚ä¸‹åˆ¤æ–­ï¼š
* è·å–æœ€è¿‘æ¸²æŸ“å®Œçš„ `Fiber` ï¼š `nearestMounted` ã€‚è‹¥ä¸ºç©ºï¼Œåˆ™è¯´æ˜å½“å‰ `fiberæ ‘` å°†è¢«ç§»é™¤ï¼Œ`targetInst = null`
* `nearestMounted` ä¸ä¸ºç©ºï¼Œåˆ™åˆ¤æ–­ `nearestMounted.tag` ï¼š
  * `tag === SuspenseComponent` ï¼Œè·å– `SuspenseInstance` ï¼Œè‹¥å­˜åœ¨ï¼Œè¿”å› `SuspenseInstance` ï¼›è‹¥ä¸å­˜åœ¨ï¼Œ`targetInst = null`
  * `tag === HostRoot` ï¼Œè‹¥æ˜¯ `SSR` ï¼Œåˆ™è¿”å›å®¹å™¨ï¼›è‹¥ä¸æ˜¯ `SSR` ï¼Œ`targetInst = null`
  * `nearestMounted !== targetInst` ï¼Œåœ¨ç»„ä»¶ `mount` ä¹‹å‰è·å–äº‹ä»¶ï¼Œæš‚æ—¶å¿½ç•¥ï¼Œ `targetInst = null`

æ¥ä¸‹æ¥æ˜¯è°ƒç”¨ `dispatchEventForPluginEventSystem` å‡½æ•°ï¼Œæˆ‘ä»¬çœ‹ä¸‹ `dispatchEventForPluginEventSystem` å‡½æ•°çš„å®šä¹‰ï¼š
```javascript {10,38,50-56}
// packages/react-dom/src/events/DOMPluginEventSystem.js

export function dispatchEventForPluginEventSystem(
  domEventName: DOMEventName,
  eventSystemFlags: EventSystemFlags,
  nativeEvent: AnyNativeEvent,
  targetInst: null | Fiber,
  targetContainer: EventTarget,
): void {
  let ancestorInst = targetInst;
  // æ ¹æ® å½“å‰ç›®æ ‡Fiber è·å– rootContainer Fiber
  if (
    (eventSystemFlags & IS_EVENT_HANDLE_NON_MANAGED_NODE) === 0 &&
    (eventSystemFlags & IS_NON_DELEGATED) === 0
  ) {
    const targetContainerNode = ((targetContainer: any): Node);
    // ...
    if (targetInst !== null) {
      let node = targetInst;

      mainLoop: while (true) {
        if (node === null) {
          return;
        }
        const nodeTag = node.tag;
        if (nodeTag === HostRoot || nodeTag === HostPortal) {
          let container = node.stateNode.containerInfo;
          if (isMatchingRootContainer(container, targetContainerNode)) {
            break;
          }s
          while (container !== null) {
            const parentNode = getClosestInstanceFromNode(container);
            if (parentNode === null) {
              return;
            }
            const parentTag = parentNode.tag;
            if (parentTag === HostComponent || parentTag === HostText) {
              node = ancestorInst = parentNode;
              continue mainLoop;
            }
            container = container.parentNode;
          }
        }
        node = node.return;
      }
    }
  }
  // è°ƒç”¨ dispatchEventsForPlugins
  batchedEventUpdates(() =>
    dispatchEventsForPlugins(
      domEventName,
      eventSystemFlags,
      nativeEvent,
      ancestorInst,
      targetContainer,
    ),
  );
}
```
`dispatchEventForPluginEventSystem` å‡½æ•°çš„æ ¸å¿ƒé€»è¾‘ä¹Ÿæ˜¯ä¸¤éƒ¨åˆ†ï¼š
* æ ¹æ® `å½“å‰ç›®æ ‡Fiber` è·å– `rootContainer Fiber`
* è°ƒç”¨ `dispatchEventsForPlugins` å‡½æ•°

å…¶ä¸­ `batchedEventUpdates` å‡½æ•°çš„ä½œç”¨åˆ™æ˜¯åœ¨è°ƒç”¨å®Œä¼ å…¥çš„å›è°ƒå‡½æ•°åï¼Œæ¥ç€å¤„ç† `isBatchingEventUpdates` æ ‡å¿—ä½å’Œè°ƒç”¨ `finishEventHandler` å‡½æ•°ï¼Œè¿›è¡Œä¸€äº›é‡ç½®æ“ä½œã€‚

é‚£ä¹ˆå…³äº `dispatchEventsForPlugins` å‡½æ•°ï¼Œæˆ‘ä»¬ä¹‹å‰ä»‹ç»è¿‡ï¼Œä¸»è¦çš„ä½œç”¨åˆ™æ˜¯åˆ©ç”¨ `extractEvents` å‡½æ•°åˆ›å»ºç›¸åº”çš„åˆæˆäº‹ä»¶ï¼Œå¹¶å°†å…¶æ”¾å…¥ `dispatchQueue` ã€‚äº¤ç»™ä¹‹åçš„å‡½æ•°å¤„ç†ã€‚

å…¶ä¸­ `extractEvents` å‡½æ•°åˆ™æ˜¯è°ƒç”¨çš„å„æ’ä»¶å¯¼å‡ºçš„ `extractEvents` ï¼Œæ¥ä¸‹æ¥æˆ‘ä»¬ä»¥ `SimpleEventPlugin.extractEvents` ä¸ºä¾‹è¿›è¡Œè§£æã€‚
### SimpleEventPlugin.extractEvents
```javascript {16-21,28-35,37-44}
// packages/react-dom/src/events/plugins/SimpleEventPlugin.js

function extractEvents(
  dispatchQueue: DispatchQueue,
  domEventName: DOMEventName,
  targetInst: null | Fiber,
  nativeEvent: AnyNativeEvent,
  nativeEventTarget: null | EventTarget,
  eventSystemFlags: EventSystemFlags,
  targetContainer: EventTarget,
): void {
  const reactName = topLevelEventsToReactNames.get(domEventName);
  if (reactName === undefined) {
    return;
  }
  let SyntheticEventCtor = SyntheticEvent;
  let reactEventType: string = domEventName;
  switch (domEventName) {
    // æ ¹æ® domEventName, å¯¹ SyntheticEventCtor è¿›è¡Œç›¸åº”çš„èµ‹å€¼
    // ...
  }
  const inCapturePhase = (eventSystemFlags & IS_CAPTURE_PHASE) !== 0;
  // ...
  const accumulateTargetOnly =
    !inCapturePhase &&
    domEventName === 'scroll';

  const listeners = accumulateSinglePhaseListeners(
    targetInst,
    reactName,
    nativeEvent.type,
    inCapturePhase,
    accumulateTargetOnly,
    nativeEvent,
  );
  if (listeners.length > 0) {
    const event = new SyntheticEventCtor(
      reactName,
      reactEventType,
      null,
      nativeEvent,
      nativeEventTarget,
    );
    dispatchQueue.push({event, listeners});
  }
}
```
SimpleEventPlugin.extractEvents å‡½æ•°æœ‰ä¸‰éƒ¨åˆ†é€»è¾‘ï¼š
* è·å– SyntheticEventCtor
* åˆ©ç”¨ accumulateSinglePhaseListeners å‡½æ•°è·å– listeners
* åˆ©ç”¨ SyntheticEventCtor ç”Ÿæˆåˆæˆäº‹ä»¶ eventï¼Œå°† event ä¸ listeners æ”¾å…¥ dispatchQueue

è‡³æ­¤ åˆæˆäº‹ä»¶åŠç›‘å¬å‡½æ•°æ”¶é›†å®Œæˆï¼Œå¹¶æ”¾å…¥åˆ° dispatchQueue ä¸­ã€‚åœ¨ dispatchEventsForPlugins å‡½æ•°ä¸­ï¼Œä¼šè°ƒç”¨ processDispatchQueue å‡½æ•°å¯¹ dispatchQueue è¿›è¡Œå¤„ç†ã€‚
```javascript {10,29,38,51}
// packages/react-dom/src/events/DOMPluginEventSystem.js

export function processDispatchQueue(
  dispatchQueue: DispatchQueue,
  eventSystemFlags: EventSystemFlags,
): void {
  const inCapturePhase = (eventSystemFlags & IS_CAPTURE_PHASE) !== 0;
  for (let i = 0; i < dispatchQueue.length; i++) {
    const {event, listeners} = dispatchQueue[i];
    processDispatchQueueItemsInOrder(event, listeners, inCapturePhase);
    //  event system doesn't use pooling.
  }
  // This would be a good time to rethrow if any of the event handlers threw.
  rethrowCaughtError();
}

function processDispatchQueueItemsInOrder(
  event: ReactSyntheticEvent,
  dispatchListeners: Array<DispatchListener>,
  inCapturePhase: boolean,
): void {
  let previousInstance;
  if (inCapturePhase) {
    for (let i = dispatchListeners.length - 1; i >= 0; i--) {
      const {instance, currentTarget, listener} = dispatchListeners[i];
      if (instance !== previousInstance && event.isPropagationStopped()) {
        return;
      }
      executeDispatch(event, listener, currentTarget);
      previousInstance = instance;
    }
  } else {
    for (let i = 0; i < dispatchListeners.length; i++) {
      const {instance, currentTarget, listener} = dispatchListeners[i];
      if (instance !== previousInstance && event.isPropagationStopped()) {
        return;
      }
      executeDispatch(event, listener, currentTarget);
      previousInstance = instance;
    }
  }
}

function executeDispatch(
  event: ReactSyntheticEvent,
  listener: Function,
  currentTarget: EventTarget,
): void {
  const type = event.type || 'unknown-event';
  event.currentTarget = currentTarget;
  invokeGuardedCallbackAndCatchFirstError(type, listener, undefined, event);
  event.currentTarget = null;
}
```
æœ€ç»ˆçš„è°ƒç”¨é“¾å¦‚ä¸‹ï¼š
```
processDispatchQueue ---> processDispatchQueueItemsInOrder ---> executeDispatch
```
è‡³æ­¤ï¼Œäº‹ä»¶æ‰§è¡Œå®Œæ¯•ã€‚
## æ€»ä½“æµç¨‹
ğŸ‘»