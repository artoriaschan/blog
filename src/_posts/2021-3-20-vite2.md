---
title: vite 2.0
subtitle: 新版本的vite有什么提升
date: 2021-3-20
tags:
  - esbuild
  - build tools
author: ArtoriasChan
location: Beijing  
---
## 简介
vite 在悄无声息中更新到了2.0, 以至于许多开发者都没怎么体验和了解vite 1.0, 就听到了 vite 2.0 推出的消息.

![vite2-twitter](~@assets/posts/vite2/vite2-twitter.png)

并且尤大在 Dev.to 上也发布了一篇简单的介绍文章: [Announcing Vite 2.0](https://dev.to/yyx990803/announcing-vite-2-0-2f0a), 并且在文中也列数了 2.0 相较于 1.0 , 在哪些方面做了提升:
* 核心设计框架无感知
* 全新插件格式和接口设计
* 基于esbuild的依赖预捆绑
* CSS的一等公民支持
* SSR的支持
* 可选的传统浏览器支持

下面就让我们来简单的分析一下vite的实现原理和细节.
## 目录结构
我们先来看一下vite的目录结构:

![vite2-tree](~@assets/posts/vite2/vite2-tree.png)

我们可以看到有这么几个文件夹:
* create-app
* playground
* plugin-legacy
* plugin-react-refresh
* plugin-vue
* plugin-vue-jsx
* vite

我们就先来分析最主要最核心的部分: vite 文件夹中的代码.
## vite 2.0 的DevServer
vite 文件夹中提供了 vite cli, 其中就包括最核心的 ViteDevServer .

其实大家对于vite最核心的原理都有所了解, 就是基于 native ESM 来实现的. 但是对于 1.0 的版本来说, 本质上是和 vue 3.0 进行绑定的, 无法轻易的适用到其他的前端框架的开发中去, 基于此, vite 2.0 重新设计了结构, 以便达成 **框架无感知** 的目的.

其中也对本地开发服务进行了改造. vite 1.0 版本是基于koa进行设计的, 而在 vite 2.0 中则是抛弃掉了koa框架, 使用 node.js 的 http 模块及 connect 中间件框架来达到相同的效果.

下面是ViteDevServer的流程图:

![vite2-flow](~@assets/posts/vite2/vite2-flow.png)

我们可以看一下源码中ViteDevServer的实现:
```ts
// packages/vite/src/node/server/index.ts -> function createServer
// ...
const server: ViteDevServer = {
  config: config,
  middlewares,  // connect中间件框架
  httpServer, // http服务
  watcher,  // 文件监控服务
  pluginContainer: container, // 插件容器
  ws, // WebSocket服务
  moduleGraph,  // 模块映射图
  transformWithEsbuild, // 基于esbuild转化模块
  transformRequest(url, options) {  // 请求转换方法
    return transformRequest(url, server, options)
  },
  transformIndexHtml: null as any,  // index.html 转化
  ssrLoadModule(url) { 
    if (!server._ssrExternals) {
      server._ssrExternals = resolveSSRExternal(
        config,
        server._optimizeDepsMetadata
          ? Object.keys(server._optimizeDepsMetadata.optimized)
          : []
      )
    }
    return ssrLoadModule(url, server)
  },
  ssrFixStacktrace(e) {
    if (e.stack) {
      e.stack = ssrRewriteStacktrace(e.stack, moduleGraph)
    }
  },
  listen(port?: number, isRestart?: boolean) {  // 服务启动方法
    return startServer(server, port, isRestart)
  },
  async close() { // 服务关闭方法
    await Promise.all([
      watcher.close(),
      ws.close(),
      container.close(),
      closeHttpServer()
    ])
  },
  // ...
}
```
可以看到 ViteDevServer 是一个对象字面量, 我们可以先看其中的 middlewares , httpServer, watcher 及 ws 字段.
## vite 2.0 的中间件
首先我们看一下 middlewares 字段的实现:
```ts
// packages/vite/src/node/server/index.ts -> function createServer
import connect from 'connect'

export async function createServer(
  inlineConfig: InlineConfig = {}
): Promise<ViteDevServer> {
  // ...
  const middlewares = connect() as Connect.Server
  const httpServer = middlewareMode
    ? null
    : await resolveHttpServer(serverConfig, middlewares)
  // ...
}
```
## vite 2.0 的插件机制
## vite 2.0 的热更新机制